<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ğŸ“š Smart Student Planner AI</title>
<style>
/* â•â•â•â• SEC-CSS-1 Â· Variables Â· Reset Â· Layout Â· Header Â· Tabs â•â•â•â• */
:root{
  --bg:#f0ebff;--surf:#fff;--surf2:#f7f3ff;--surf3:#ede9ff;
  --pri:#7c3aed;--pri-l:#ede9fe;--pri-d:#5b21b6;
  --acc:#f472b6;--grn:#10b981;--yel:#f59e0b;--red:#ef4444;--blue:#3b82f6;
  --txt:#111827;--txt2:#6b7280;--brd:#e5e7eb;
  --shd:0 2px 16px rgba(124,58,237,.12);--r:12px;
  --font:'Segoe UI',system-ui,sans-serif;
}
[data-theme=dark]{
  --bg:#0e0b1a;--surf:#17142a;--surf2:#1e1a33;--surf3:#252040;
  --pri-l:#28204a;--txt:#ede9ff;--txt2:#9ca3af;--brd:#38305a;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:var(--font);font-size:15px}
body{background:var(--bg);color:var(--txt);display:flex;flex-direction:column;transition:background .25s,color .25s}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--pri-l);border-radius:99px}

/* Header */
#hdr{flex-shrink:0;display:flex;align-items:center;gap:8px;padding:9px 16px;
  background:var(--surf);border-bottom:2px solid var(--brd);box-shadow:var(--shd);z-index:100;flex-wrap:wrap}
.logo{font-size:.97rem;font-weight:900;color:var(--pri);white-space:nowrap;letter-spacing:-.3px}
.logo em{color:var(--acc);font-style:normal}
.hdr-r{display:flex;gap:5px;align-items:center;margin-left:auto;flex-wrap:wrap}
.ai-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:99px;
  border:1.5px solid var(--brd);background:var(--surf2);font-size:.72rem;font-weight:700;
  cursor:pointer;transition:all .2s;white-space:nowrap}
.ai-pill:hover{border-color:var(--pri)}
.sdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dot-ok{background:var(--grn)}.dot-err{background:var(--red)}.dot-chk{background:var(--yel);animation:pulse .7s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

/* Tabs */
#tabs{flex-shrink:0;display:flex;gap:2px;padding:7px 16px 0;
  background:var(--surf);border-bottom:2px solid var(--brd);overflow-x:auto}
.tab{padding:7px 13px;border:none;border-radius:8px 8px 0 0;background:transparent;
  color:var(--txt2);font:700 .78rem var(--font);white-space:nowrap;cursor:pointer;transition:all .18s}
.tab:hover{background:var(--pri-l);color:var(--pri)}
.tab.on{background:var(--pri);color:#fff}

/* Main + Pages */
#main{flex:1;overflow:hidden;display:flex;min-height:0}
.page{display:none;flex:1;overflow:hidden;flex-direction:column;min-height:0}
.page.on{display:flex}
.scroll{flex:1;overflow-y:auto;padding:16px}

/* Cards */
.card{background:var(--surf);border:1.5px solid var(--brd);border-radius:var(--r);
  padding:15px;margin-bottom:13px;box-shadow:var(--shd)}
.ct{font-size:.88rem;font-weight:700;color:var(--pri);margin-bottom:11px}

/* Form */
.row{display:flex;gap:9px;flex-wrap:wrap;margin-bottom:9px;align-items:flex-end}
.fg{display:flex;flex-direction:column;gap:3px;flex:1;min-width:90px}
.fg label{font-size:.7rem;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.3px}
.fg input,.fg select,.fg textarea{padding:7px 10px;border:1.5px solid var(--brd);border-radius:8px;
  background:var(--surf2);color:var(--txt);font:.84rem var(--font);transition:border .18s;outline:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--pri)}
.fg textarea{resize:vertical;min-height:48px}

/* Buttons */
.btn{padding:7px 13px;border:none;border-radius:8px;font:700 .8rem var(--font);
  cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
.btn:active{transform:scale(.95)}
.bp{background:var(--pri);color:#fff}.bp:hover{background:var(--pri-d)}
.bg{background:var(--grn);color:#fff}
.bgh{background:var(--pri-l);color:var(--pri)}.bgh:hover{background:var(--pri);color:#fff}
.br{background:var(--red);color:#fff}
.bb{background:var(--blue);color:#fff}
.bor{background:#fed7aa;color:#7c2d12}.bor:hover{background:#fb923c;color:#fff}
.sm{padding:5px 9px;font-size:.73rem}
.bundo{background:#fef3c7;color:#92400e;border:1.5px solid #fbbf24}
.bundo:hover{background:#fbbf24;color:#fff}

/* Badge / List item */
.badge{padding:2px 7px;border-radius:99px;font-size:.67rem;font-weight:700}
.bh{background:#fecaca;color:#991b1b}.bm{background:#fef3c7;color:#92400e}.bl{background:#d1fae5;color:#065f46}
.li{display:flex;align-items:center;gap:7px;padding:8px 11px;border-radius:9px;
  border:1.5px solid var(--brd);background:var(--surf2);margin-bottom:6px;font-size:.83rem}
.li .n{flex:1;font-weight:600}
.dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}

/* Toggle */
.toggle-row{display:flex;align-items:center;gap:9px;padding:7px 0;border-bottom:1px solid var(--brd)}
.toggle-row label{flex:1;font-size:.83rem;font-weight:600}
input[type=checkbox].tgl{width:34px;height:18px;appearance:none;background:var(--brd);
  border-radius:99px;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0}
input[type=checkbox].tgl:checked{background:var(--pri)}
input[type=checkbox].tgl::after{content:'';position:absolute;width:12px;height:12px;
  border-radius:50%;background:#fff;top:3px;left:3px;transition:left .2s}
input[type=checkbox].tgl:checked::after{left:19px}

/* Toast */
#toast{position:fixed;bottom:18px;right:18px;z-index:9998;background:var(--pri);color:#fff;
  padding:9px 16px;border-radius:10px;font-size:.82rem;font-weight:700;
  box-shadow:var(--shd);display:none;animation:slideUp .25s ease;max-width:320px;text-align:center}
@keyframes slideUp{from{transform:translateY(10px);opacity:0}to{transform:none;opacity:1}}

/* Notification banner */
#notifBanner{display:none;background:linear-gradient(135deg,var(--pri),var(--acc));
  color:#fff;padding:7px 16px;font-size:.78rem;font-weight:600;flex-shrink:0;align-items:center;gap:8px;flex-wrap:wrap}
#notifBanner.show{display:flex}

/* AI Confirm dialog */
#aiConfirmBox{display:none;position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.6);
  align-items:center;justify-content:center;padding:14px}
#aiConfirmBox.open{display:flex}
.ac-box{background:var(--surf);border-radius:13px;width:min(420px,100%);box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden}
.ac-hdr{padding:12px 16px;background:var(--pri);color:#fff;font-weight:700;font-size:.9rem}
.ac-body{padding:15px 16px;font-size:.85rem;line-height:1.7;max-height:50vh;overflow-y:auto}
.ac-ftr{display:flex;gap:7px;justify-content:flex-end;padding:11px 16px;border-top:1.5px solid var(--brd)}

/* â•â•â•â• SEC-CSS-2 Â· Calendar Grid Â· Timeline â•â•â•â• */
/* FIX: Ratio 3:4 (43% : 57%) and resizable via CSS resize */
#pg-cal{flex-direction:row}
#cal-left{
  display:flex;flex-direction:column;min-height:0;
  width:43%;min-width:200px;max-width:70%;
  flex-shrink:0;border-right:2px solid var(--brd);
  resize:horizontal;overflow:auto; /* allow manual resize */
}
#cal-nav{flex-shrink:0;display:flex;align-items:center;gap:5px;padding:8px 10px;
  border-bottom:1.5px solid var(--brd);background:var(--surf);flex-wrap:wrap}
.wk-lbl{flex:1;text-align:center;font-weight:700;font-size:.84rem;min-width:90px}

/* Calendar grid â€“ cells fill height, overflow scroll for many chips */
#weekGrid{
  flex:1;overflow:auto;padding:5px;
  display:grid;
  grid-template-columns:repeat(7,1fr);
  grid-auto-rows:1fr;
  gap:4px;
}
/* Cell: allow internal scroll */
.dc{
  background:var(--surf);border:1.5px solid var(--brd);border-radius:9px;
  padding:4px 3px;cursor:pointer;transition:border-color .18s,box-shadow .18s;
  display:flex;flex-direction:column;gap:1px;
  overflow-y:auto;   /* â† scroll inside cell */
  min-height:0;
}
.dc:hover{border-color:var(--pri);box-shadow:0 2px 8px rgba(124,58,237,.12)}
.dc.today{border-color:var(--pri);background:var(--pri-l)}
.dc.selected{border-color:var(--acc);box-shadow:0 0 0 2px rgba(244,114,182,.3)}
.dh{text-align:center;font-weight:700;font-size:.57rem;color:var(--txt2);text-transform:uppercase;line-height:1;flex-shrink:0}
.dc.today .dh{color:var(--pri)}
.dd{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:.8rem;font-weight:800;margin:1px auto 2px;flex-shrink:0}
.dc.today .dd{background:var(--pri);color:#fff}
.dc.selected .dd{background:var(--acc);color:#fff}
/* Progress bar */
.dc-prog{height:3px;border-radius:99px;background:var(--brd);margin-bottom:2px;overflow:hidden;flex-shrink:0}
.dc-prog-b{height:100%;border-radius:99px;background:var(--grn)}
/* Chips â€“ minimal height, show as many as possible */
.ce{
  border-radius:3px;padding:1px 3px;font-size:.56rem;font-weight:600;
  overflow:hidden;border-left:2px solid transparent;flex-shrink:0;line-height:1.25;
}
.ce.done{opacity:.35;text-decoration:line-through}
.ce-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}
.ce-time{font-size:.5rem;opacity:.65;display:block}

/* Right panel */
#cal-right{flex:1;display:flex;flex-direction:column;min-height:0;background:var(--surf2);overflow:hidden}
#tl-hdr{flex-shrink:0;padding:8px 12px;background:var(--surf);border-bottom:1.5px solid var(--brd);display:flex;align-items:center;gap:7px;flex-wrap:wrap}
#tl-hdr h3{flex:1;font-size:.86rem;font-weight:700;color:var(--pri)}
#tl-placeholder{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:9px;color:var(--txt2);font-size:.86rem;padding:18px;text-align:center}
#tl-body{flex:1;overflow-y:auto;padding:10px 12px 10px 52px;position:relative;display:none}
#tl-inner{position:relative}
.tl-hour{position:absolute;left:-44px;font-size:.62rem;color:var(--txt2);line-height:1;user-select:none}
.tl-line{position:absolute;left:-3px;right:0;border-top:1px dashed var(--brd)}
.tl-line-half{position:absolute;left:-3px;right:0;border-top:1px dotted var(--brd);opacity:.4}
#tl-now-line{position:absolute;left:-3px;right:0;border-top:2.5px solid var(--red);z-index:20;display:none}
.tl-now-lbl{position:absolute;left:2px;top:-10px;font-size:.62rem;color:var(--red);
  font-weight:700;background:var(--surf2);padding:1px 4px;border-radius:4px;white-space:nowrap}

/* Timeline slot â€“ FIX: proper absolute positioning, no overlap artifacts */
.tl-slot{
  position:absolute;
  border-radius:6px;padding:3px 7px 3px 8px;
  font-size:.73rem;font-weight:600;
  overflow:hidden;user-select:none;z-index:5;
  display:flex;flex-direction:column;gap:1px;
  transition:filter .15s;
  cursor:grab;
  box-shadow:0 1px 4px rgba(0,0,0,.18);
  /* Prevent black artifacts from default colors */
  background-clip:padding-box;
}
.tl-slot:hover{filter:brightness(.88);z-index:10}
.tl-slot.done{opacity:.42;text-decoration:line-through}
.tl-slot.dragging{opacity:.55;cursor:grabbing;z-index:15}
/* Buffer slots (breaks) â€“ subtle, no hover */
.tl-slot.buffer-slot{
  opacity:.55;font-size:.62rem;font-weight:500;
  border-radius:4px;cursor:default;
  box-shadow:none;
}
.ts-time{font-size:.6rem;opacity:.85;font-weight:500;flex-shrink:0}
.ts-name{font-size:.72rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ts-sub{font-size:.58rem;opacity:.72;font-style:italic}
.ts-cb{position:absolute;right:5px;top:6px;width:13px;height:13px;cursor:pointer;z-index:6}
.conflict-banner{background:#fef2f2;border:1.5px solid var(--red);border-radius:8px;
  padding:7px 11px;font-size:.77rem;color:#991b1b;flex-shrink:0;display:none;align-items:center;gap:7px}
.conflict-banner.show{display:flex}

/* â•â•â•â• SEC-CSS-3 Â· Chat Â· Forms Â· Modals Â· Stats Â· Landing â•â•â•â• */
#pg-ai{flex-direction:column}
#chat-top{flex-shrink:0;padding:9px 16px;background:var(--surf);border-bottom:1.5px solid var(--brd);display:flex;align-items:center;gap:9px;flex-wrap:wrap}
#chat-top h3{font-size:.86rem;font-weight:700;color:var(--pri);flex:1}
.mode-badge{font-size:.68rem;padding:3px 8px;border-radius:99px;font-weight:700}
.mode-fake{background:#d1fae5;color:#065f46}.mode-gemini{background:#ede9fe;color:#5b21b6}
#chatBox{flex:1;overflow-y:auto;padding:13px 16px;display:flex;flex-direction:column;gap:9px;min-height:0}
.msg{max-width:82%;border-radius:13px;padding:9px 13px;font-size:.84rem;line-height:1.65;animation:msgIn .2s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.msg.u{background:var(--pri);color:#fff;align-self:flex-end;border-bottom-right-radius:3px}
.msg.a{background:var(--surf);border:1.5px solid var(--brd);align-self:flex-start;border-bottom-left-radius:3px}
.msg.sys{background:var(--surf3);border:1.5px dashed var(--brd);align-self:center;color:var(--txt2);font-size:.72rem;max-width:92%;text-align:center}
.dots span{width:6px;height:6px;border-radius:50%;background:var(--pri);animation:bou .8s infinite;display:inline-block;margin:0 2px}
.dots span:nth-child(2){animation-delay:.15s}.dots span:nth-child(3){animation-delay:.3s}
@keyframes bou{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
#suggestions{display:flex;gap:5px;flex-wrap:wrap;padding:7px 16px;flex-shrink:0;border-bottom:1px solid var(--brd)}
.sugg{padding:4px 10px;border-radius:99px;border:1.5px solid var(--brd);background:var(--surf2);
  color:var(--txt2);font-size:.71rem;font-weight:600;cursor:pointer;transition:all .18s}
.sugg:hover{border-color:var(--pri);color:var(--pri)}
#chat-inp{flex-shrink:0;display:flex;gap:7px;padding:11px 16px;background:var(--surf);border-top:1.5px solid var(--brd)}
#chatIn{flex:1;padding:9px 12px;border:1.5px solid var(--brd);border-radius:9px;
  background:var(--surf2);color:var(--txt);font:.84rem var(--font);outline:none;
  resize:none;height:42px;max-height:90px;overflow-y:auto;transition:border .18s;line-height:1.4}
#chatIn:focus{border-color:var(--pri)}
.subj-btns{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px}
.subj-btn{padding:3px 9px;border-radius:99px;border:1.5px solid var(--brd);background:var(--surf2);color:var(--txt2);font-size:.7rem;font-weight:700;cursor:pointer;transition:all .15s}
.subj-btn.on{border-color:var(--pri);color:var(--pri);background:var(--pri-l)}
.pri-btns{display:flex;gap:5px;flex-wrap:wrap;margin-top:3px}
.pri-btn{padding:4px 11px;border-radius:7px;border:1.5px solid var(--brd);background:var(--surf2);font-size:.75rem;font-weight:700;cursor:pointer;transition:all .15s;color:var(--txt2)}
.pri-btn.on-high{background:#fecaca;color:#991b1b;border-color:#f87171}
.pri-btn.on-med{background:#fef3c7;color:#92400e;border-color:#fbbf24}
.pri-btn.on-low{background:#d1fae5;color:#065f46;border-color:#34d399}
.dpick{display:flex;gap:4px;flex-wrap:wrap}
.dchip{width:27px;height:27px;border-radius:50%;border:1.5px solid var(--brd);background:var(--surf2);
  color:var(--txt2);font-size:.7rem;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .18s}
.dchip.on{background:var(--pri);color:#fff;border-color:var(--pri)}
.cpick{display:flex;gap:5px;flex-wrap:wrap}
.copt{width:20px;height:20px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border .18s}
.copt.on{border-color:var(--txt)}
.stat-tabs{display:flex;gap:4px;margin-bottom:13px;flex-wrap:wrap}
.stat-tab{padding:6px 13px;border:1.5px solid var(--brd);border-radius:8px;background:var(--surf2);color:var(--txt2);font-size:.76rem;font-weight:700;cursor:pointer;transition:all .15s}
.stat-tab:hover{border-color:var(--pri);color:var(--pri)}
.stat-tab.on{background:var(--pri);color:#fff;border-color:var(--pri)}
.stat-cards{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:13px}
.sc{background:var(--surf);border:1.5px solid var(--brd);border-radius:10px;padding:9px 13px;flex:1;min-width:65px}
.sv{font-size:1.3rem;font-weight:800;color:var(--pri)}.sl{font-size:.67rem;color:var(--txt2);margin-top:1px}
.prog{background:var(--brd);border-radius:99px;height:6px;overflow:hidden;margin-top:4px}
.prog-b{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--pri),var(--acc));transition:width .4s}
.stat-bar-row{display:flex;align-items:center;gap:7px;margin-bottom:7px}
.stat-bar-row .lbl{min-width:75px;font-size:.74rem;font-weight:600;color:var(--txt2);text-align:right}
.stat-bar-row .bar-wrap{flex:1;background:var(--brd);border-radius:99px;height:12px;overflow:hidden}
.stat-bar-row .bar-fill{height:100%;border-radius:99px;transition:width .4s}
.stat-bar-row .val{min-width:32px;font-size:.7rem;font-weight:700;color:var(--pri)}
#editModal,#guideModal,#aiSetupModal,#evEditModal{display:none;position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.6);align-items:center;justify-content:center;padding:14px}
#editModal.open,#guideModal.open,#aiSetupModal.open,#evEditModal.open{display:flex}
.m-box{background:var(--surf);border-radius:13px;width:min(450px,100%);box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden}
.m-hdr{display:flex;align-items:center;padding:13px 17px;border-bottom:1.5px solid var(--brd);background:var(--surf2)}
.m-hdr h3{flex:1;font-size:.9rem;font-weight:700;color:var(--pri)}
.m-body{padding:15px 17px;max-height:65vh;overflow-y:auto}
.m-ftr{display:flex;gap:7px;justify-content:flex-end;padding:11px 17px;border-top:1.5px solid var(--brd)}
.gm-box{background:#1e1a33;border-radius:15px;width:min(520px,100%);max-height:85vh;overflow-y:auto;box-shadow:0 30px 60px rgba(0,0,0,.5)}
.gm-hdr{padding:17px 21px;background:linear-gradient(135deg,#7c3aed,#f472b6);border-radius:15px 15px 0 0;display:flex;align-items:center;gap:9px}
.gm-hdr h3{flex:1;color:#fff;font-size:.97rem;font-weight:800}
.gm-body{padding:18px 21px;color:#c4b5fd;font-size:.84rem;line-height:1.8}
.gm-body h4{color:#a78bfa;font-size:.87rem;margin:13px 0 5px}
.gm-body code{background:#28204a;padding:2px 7px;border-radius:5px;color:#f472b6;font-size:.8rem}
.gm-body .step{display:flex;gap:9px;margin-bottom:9px;align-items:flex-start}
.gm-body .sn{width:22px;height:22px;border-radius:50%;background:#7c3aed;color:#fff;font-weight:800;font-size:.72rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px}
.gm-body .warn{background:#2a1a00;border:1px solid #f59e0b;border-radius:7px;padding:7px 11px;color:#fcd34d;margin-top:9px;font-size:.78rem}
.gm-ftr{padding:11px 21px;border-top:1px solid #38305a;display:flex;gap:7px;justify-content:flex-end}
.mode-selector{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:13px}
.mode-opt{flex:1;min-width:130px;border:2px solid #38305a;border-radius:11px;padding:13px;cursor:pointer;transition:all .2s;text-align:center;background:#17142a}
.mode-opt:hover{border-color:#7c3aed}
.mode-opt.on{border-color:#7c3aed;background:#28204a}
.mode-opt .mo-icon{font-size:1.7rem;margin-bottom:5px}
.mode-opt .mo-title{font-weight:700;font-size:.84rem;color:#a78bfa}
.mode-opt .mo-desc{font-size:.7rem;color:#6b7280;margin-top:2px;line-height:1.4}
.api-warning{background:#2a1a00;border:1px solid #f59e0b;border-radius:7px;padding:7px 11px;color:#fcd34d;margin-top:8px;font-size:.78rem;display:flex;gap:5px}
.setup-api-warning{background:#fef3c7;border:1px solid #f59e0b;border-radius:7px;padding:7px 11px;color:#78350f;margin-top:8px;font-size:.78rem}
[data-theme=dark] .setup-api-warning{background:#2a1f0a;color:var(--yel)}
#landing{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);
  display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:22px;overflow:auto}
#landing .land-logo{font-size:3.2rem;margin-bottom:9px;animation:floatLogo 3s ease-in-out infinite}
@keyframes floatLogo{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
#landing h1{font-size:2rem;font-weight:900;color:#fff;letter-spacing:-.5px;line-height:1.2;margin-bottom:7px}
#landing h1 span{background:linear-gradient(90deg,#a78bfa,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#landing .slogan{font-size:.95rem;color:#c4b5fd;margin-bottom:9px;font-style:italic}
#landing .desc{max-width:460px;font-size:.85rem;color:#94a3b8;line-height:1.7;margin-bottom:28px}
.land-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:24px}
.land-btn{padding:11px 24px;border-radius:99px;font-weight:700;font-size:.88rem;cursor:pointer;border:none;transition:all .2s}
.land-btn.primary{background:linear-gradient(135deg,#7c3aed,#f472b6);color:#fff;box-shadow:0 4px 20px rgba(124,58,237,.4)}
.land-btn.primary:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(124,58,237,.5)}
.land-btn.secondary{background:rgba(255,255,255,.1);color:#fff;border:1.5px solid rgba(255,255,255,.2)}
.land-btn.secondary:hover{background:rgba(255,255,255,.18)}
.land-features{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;max-width:560px}
.lf{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:10px;
  padding:8px 13px;font-size:.75rem;color:#c4b5fd;display:flex;align-items:center;gap:5px}
.code-b{background:var(--surf3);border:1.5px solid var(--brd);border-radius:7px;padding:7px 11px;
  font-family:monospace;font-size:.77rem;color:var(--pri);position:relative;white-space:pre-wrap;word-break:break-all;line-height:1.55}
.cpbtn{position:absolute;right:5px;top:5px;background:var(--pri-l);border:none;border-radius:4px;padding:2px 6px;font-size:.65rem;color:var(--pri);font-weight:700;cursor:pointer}
.step-g{display:flex;gap:10px;margin-bottom:11px}
.sn-g{width:24px;height:24px;border-radius:50%;background:var(--pri);color:#fff;font-weight:800;font-size:.8rem;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.tip-b{background:#fef9c3;border:1.5px solid #f59e0b;border-radius:7px;padding:7px 11px;font-size:.77rem;color:#78350f;margin-top:5px}
[data-theme=dark] .tip-b{background:#2a1f0a;color:var(--txt2)}

/* One-time event badge */
.ev-once-badge{background:#fed7aa;color:#7c2d12;padding:1px 6px;border-radius:99px;font-size:.62rem;font-weight:700;margin-left:4px}

@media(max-width:860px){
  #pg-cal{flex-direction:column}
  #cal-left{width:100%!important;max-width:100%;height:44%;border-right:none;border-bottom:2px solid var(--brd);resize:none}
  #weekGrid{grid-template-columns:repeat(4,1fr)}
  #cal-right{height:56%}
}
@media(max-width:540px){
  #weekGrid{grid-template-columns:repeat(3,1fr)}
  .msg{max-width:92%}
  .hdr-r{gap:3px}
  .land-btns{flex-direction:column;align-items:center}
}
@media(max-width:380px){
  #weekGrid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<!-- â•â•â•â• SEC-HTML-1 Â· Landing Â· Guide Modal Â· AI Setup Modal â•â•â•â• -->
<div id="landing">
  <div class="land-logo">ğŸ“š</div>
  <h1>Smart Student <span>Planner AI</span></h1>
  <div class="slogan">"Há»c thÃ´ng minh hÆ¡n, khÃ´ng pháº£i chÄƒm chá»‰ hÆ¡n."</div>
  <div class="desc">Trá»£ lÃ½ láº­p lá»‹ch há»c cÃ¡ nhÃ¢n vá»›i <strong style="color:#a78bfa">Gemini AI</strong> hoáº·c <strong style="color:#f472b6">Fake AI offline</strong>.</div>
  <div class="land-btns">
    <button class="land-btn primary" onclick="startApp()">ğŸš€ Báº¯t Ä‘áº§u</button>
    <button class="land-btn secondary" onclick="openGuide()">ğŸ“– HÆ°á»›ng dáº«n</button>
    <button class="land-btn secondary" onclick="openAiSetup()">âš™ï¸ CÃ i Ä‘áº·t AI</button>
  </div>
  <div class="land-features">
    <div class="lf">ğŸ¤– Gemini AI + Fake AI</div>
    <div class="lf">ğŸ“… Xáº¿p lá»‹ch thÃ´ng minh</div>
    <div class="lf">ğŸ”” Nháº¯c nhá»Ÿ deadline</div>
    <div class="lf">ğŸ“Š Thá»‘ng kÃª 4 cháº¿ Ä‘á»™</div>
    <div class="lf">ğŸ… Pomodoro</div>
    <div class="lf">ğŸ”„ Interleaving</div>
    <div class="lf">ğŸ“… Spaced Repetition</div>
    <div class="lf">ğŸ–±ï¸ KÃ©o tháº£ lá»‹ch</div>
  </div>
</div>

<!-- Guide Modal -->
<div id="guideModal">
  <div class="gm-box">
    <div class="gm-hdr"><span>ğŸ“–</span><h3>HÆ°á»›ng dáº«n sá»­ dá»¥ng</h3><button class="btn sm" style="background:rgba(255,255,255,.15);color:#fff;border:none" onclick="closeGuide()">âœ•</button></div>
    <div class="gm-body">
      <h4>ğŸš€ Báº¯t Ä‘áº§u nhanh</h4>
      <div class="step"><div class="sn">1</div><div>VÃ o <strong>Sá»± kiá»‡n</strong> â†’ thÃªm lá»‹ch cá»‘ Ä‘á»‹nh (Ä‘i há»c, Äƒn, ngá»§â€¦) hoáº·c sá»± kiá»‡n Ä‘á»™t xuáº¥t</div></div>
      <div class="step"><div class="sn">2</div><div>VÃ o <strong>CÃ´ng viá»‡c</strong> â†’ thÃªm bÃ i táº­p + chá»n Ä‘á»™ khÃ³ + deadline</div></div>
      <div class="step"><div class="sn">3</div><div>Nháº¥n <strong>âš¡ Xáº¿p lá»‹ch</strong> â†’ AI tá»± Ä‘á»™ng xáº¿p vÃ o khung giá» trá»‘ng</div></div>
      <div class="step"><div class="sn">4</div><div>Chat vá»›i AI Ä‘á»ƒ di chuyá»ƒn, thÃªm, xoÃ¡ cÃ´ng viá»‡c</div></div>
      <h4>ğŸ“Œ Sá»± kiá»‡n Ä‘á»™t xuáº¥t</h4>
      Chá»n loáº¡i <strong>"ğŸ“ Äá»™t xuáº¥t"</strong> khi thÃªm sá»± kiá»‡n, sau Ä‘Ã³ chá»n ngÃ y cá»¥ thá»ƒ. Sá»± kiá»‡n nÃ y chá»‰ xuáº¥t hiá»‡n Ä‘Ãºng ngÃ y Ä‘Ã³.
      <h4>ğŸ… Pomodoro</h4>
      Task dÃ i tá»± chia thÃ nh block 25p há»c + 5p nghá»‰ báº¯t buá»™c. Sau 2 block liÃªn tiáº¿p cÃ³ nghá»‰ dÃ i 15p.
      <h4>ğŸ“… Spaced Repetition</h4>
      Task chá»n method "Spaced" sáº½ tá»± táº¡o session Ã´n láº¡i sau 1, 3, 7, 14 ngÃ y.
    </div>
    <div class="gm-ftr"><button class="btn bp sm" onclick="closeGuide()">ÄÃ£ hiá»ƒu âœ“</button></div>
  </div>
</div>

<!-- AI Setup Modal -->
<div id="aiSetupModal">
  <div class="gm-box">
    <div class="gm-hdr"><span>âš™ï¸</span><h3>Chá»n cháº¿ Ä‘á»™ AI</h3><button class="btn sm" style="background:rgba(255,255,255,.15);color:#fff;border:none" onclick="closeAiSetup()">âœ•</button></div>
    <div class="gm-body">
      <div class="mode-selector">
        <div class="mode-opt on" id="mopt-fake" onclick="selectAiMode('fake')">
          <div class="mo-icon">ğŸ§ </div><div class="mo-title">Fake AI (Offline)</div>
          <div class="mo-desc">Thuáº­t toÃ¡n JS thuáº§n<br>KhÃ´ng cáº§n internet<br>Miá»…n phÃ­ 100%</div>
        </div>
        <div class="mode-opt" id="mopt-gemini" onclick="selectAiMode('gemini')">
          <div class="mo-icon">âœ¨</div><div class="mo-title">Gemini AI</div>
          <div class="mo-desc">Google Gemini 2.0 Flash<br>Cáº§n API key + internet</div>
        </div>
      </div>
      <div id="geminiKeySection" style="display:none">
        <div class="fg" style="margin-bottom:9px">
          <label style="color:#a78bfa;font-size:.7rem;font-weight:700;text-transform:uppercase">Gemini API Key</label>
          <input type="password" id="geminiKeyInput" placeholder="AIzaâ€¦" style="background:#28204a;border-color:#38305a;color:#ede9ff;padding:8px 10px;border-radius:8px;border:1.5px solid #38305a;width:100%;font:.84rem var(--font);outline:none"/>
        </div>
        <button class="btn bp sm" onclick="saveAiSetup()" style="width:100%">ğŸ’¾ LÆ°u &amp; Kiá»ƒm tra</button>
        <div id="setupTestResult" style="font-size:.78rem;color:#6b7280;min-height:18px;margin-top:6px"></div>
        <div class="api-warning">âš ï¸ KhÃ´ng chia sáº» API key!</div>
      </div>
      <div id="fakeSaveBtn" style="margin-top:4px">
        <button class="btn bp sm" onclick="saveAiSetup()">ğŸ’¾ LÆ°u cháº¿ Ä‘á»™</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Confirm Dialog -->
<div id="aiConfirmBox">
  <div class="ac-box">
    <div class="ac-hdr">ğŸ¤– AI muá»‘n thá»±c hiá»‡n thay Ä‘á»•i lá»‹ch</div>
    <div class="ac-body" id="aiConfirmBody"></div>
    <div class="ac-ftr">
      <button class="btn bgh sm" onclick="rejectAiChange()">âœ• Huá»·</button>
      <button class="btn bp sm" onclick="confirmAiChange()">âœ“ XÃ¡c nháº­n</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• SEC-HTML-2 Â· Main App â•â•â•â• -->
<div id="app" style="display:none;flex-direction:column;height:100%">
  <div id="notifBanner">
    ğŸ”” Báº­t thÃ´ng bÃ¡o Ä‘á»ƒ nháº­n nháº¯c nhá»Ÿ!
    <button class="btn sm" style="background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3)" onclick="requestNotif()">Báº­t</button>
    <button class="btn sm" style="background:transparent;color:rgba(255,255,255,.6);border:none;margin-left:auto" onclick="this.parentElement.classList.remove('show')">âœ•</button>
  </div>
  <div id="hdr">
    <div class="logo">ğŸ“š Smart <em>Student</em> Planner</div>
    <div class="hdr-r">
      <div class="ai-pill" onclick="openAiSetup()">
        <div class="sdot dot-chk" id="sDot"></div>
        <span id="sTxt">Fake AI</span>
      </div>
      <button class="btn bundo sm" id="btnUndo" onclick="applyUndo()" style="display:none">â†© HoÃ n tÃ¡c</button>
      <button class="btn bgh sm" id="btnDark" onclick="toggleDark()">ğŸŒ™</button>
      <button class="btn bp sm" onclick="runScheduler()">âš¡ Xáº¿p lá»‹ch</button>
    </div>
  </div>
  <div id="tabs">
    <button class="tab on" onclick="goTo('cal',this)">ğŸ“… Lá»‹ch tuáº§n</button>
    <button class="tab" onclick="goTo('ai',this)">ğŸ¤– AI Chat</button>
    <button class="tab" onclick="goTo('ev',this)">ğŸ“Œ Sá»± kiá»‡n</button>
    <button class="tab" onclick="goTo('tk',this)">ğŸ“ CÃ´ng viá»‡c</button>
    <button class="tab" onclick="goTo('stats',this)">ğŸ“Š Thá»‘ng kÃª</button>
    <button class="tab" onclick="goTo('setup',this)">âš™ï¸ CÃ i Ä‘áº·t</button>
  </div>
  <div id="main">

<!-- â•â•â•â• SEC-HTML-3 Â· Calendar Â· Chat Â· Events Â· Tasks â•â•â•â• -->

    <!-- CALENDAR -->
    <div class="page on" id="pg-cal">
      <div id="cal-left">
        <div id="cal-nav">
          <button class="btn bgh sm" onclick="chgWeek(-1)">â—€</button>
          <span class="wk-lbl" id="wkLbl"></span>
          <button class="btn bgh sm" onclick="chgWeek(1)">â–¶</button>
          <button class="btn bgh sm" onclick="chgWeek(0,'today')">HÃ´m nay</button>
          <button class="btn bp sm" onclick="runScheduler()">âš¡</button>
        </div>
        <div id="weekGrid"></div>
      </div>
      <div id="cal-right">
        <div id="tl-hdr">
          <h3 id="tlTitle">â† Nháº¥p vÃ o ngÃ y Ä‘á»ƒ xem</h3>
          <button class="btn bgh sm" onclick="openEditNew()">â• ThÃªm</button>
        </div>
        <div id="conflictBanner" class="conflict-banner">âš ï¸ <span id="conflictMsg"></span></div>
        <div id="tl-placeholder">
          <div style="font-size:2.4rem">ğŸ“…</div>
          <div style="font-weight:700;color:var(--pri)">Chá»n má»™t ngÃ y Ä‘á»ƒ xem chi tiáº¿t</div>
          <div style="font-size:.77rem">Nháº¥p vÃ o báº¥t ká»³ Ã´ nÃ o bÃªn trÃ¡i</div>
          <div style="margin-top:7px"><button class="btn bp sm" onclick="runScheduler()">âš¡ Xáº¿p lá»‹ch ngay</button></div>
        </div>
        <div id="tl-body">
          <div id="tl-inner">
            <div id="tl-now-line"><span class="tl-now-lbl" id="nowLbl">BÃ¢y giá»</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI CHAT -->
    <div class="page" id="pg-ai">
      <div id="chat-top">
        <h3>ğŸ¤– AI Chat</h3>
        <span id="modeBadge" class="mode-badge mode-fake">ğŸ§  Fake AI</span>
        <button class="btn bgh sm" onclick="clearChatHistory()">ğŸ—‘ï¸ XÃ³a</button>
      </div>
      <div id="suggestions">
        <div class="sugg" onclick="quickSend(this)">HÃ´m nay tÃ´i cÃ³ gÃ¬?</div>
        <div class="sugg" onclick="quickSend(this)">Mai tÃ´i khÃ´ng Ä‘i há»c</div>
        <div class="sugg" onclick="quickSend(this)">Deadline sáº¯p tá»›i?</div>
        <div class="sugg" onclick="quickSend(this)">Nháº­n xÃ©t tuáº§n nÃ y</div>
        <div class="sugg" onclick="quickSend(this)">Lá»i khuyÃªn há»c táº­p</div>
      </div>
      <div id="chatBox"></div>
      <div id="chat-inp">
        <textarea id="chatIn" placeholder="Nháº­p yÃªu cáº§uâ€¦ (Enter gá»­i, Shift+Enter xuá»‘ng dÃ²ng)"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
        <button class="btn bp" id="btnSend" onclick="sendChat()">Gá»­i ğŸš€</button>
      </div>
    </div>

    <!-- EVENTS -->
    <div class="page" id="pg-ev">
      <div class="scroll">
        <div class="card">
          <div class="ct">â• ThÃªm sá»± kiá»‡n</div>
          <div class="row">
            <div class="fg" style="flex:2"><label>TÃªn sá»± kiá»‡n</label><input id="ev_n" placeholder="Äi há»c, Há»p phá»¥ huynhâ€¦"/></div>
            <div class="fg"><label>Loáº¡i</label>
              <select id="ev_t" onchange="toggleEvType()">
                <option value="fixed">ğŸ“Œ Cá»‘ Ä‘á»‹nh (má»—i tuáº§n)</option>
                <option value="flex">ğŸ”€ Linh hoáº¡t</option>
                <option value="once">ğŸ“ Äá»™t xuáº¥t (1 láº§n)</option>
              </select></div>
            <div class="fg"><label>Æ¯u tiÃªn</label>
              <select id="ev_p"><option value="high">ğŸ”´ Cao</option><option value="med" selected>ğŸŸ¡ TB</option><option value="low">ğŸŸ¢ Tháº¥p</option></select></div>
          </div>
          <!-- Fixed / Flex time fields -->
          <div id="ui_fix">
            <div class="row">
              <div class="fg"><label>Báº¯t Ä‘áº§u</label><input type="time" id="ev_s" value="07:00"/></div>
              <div class="fg"><label>Káº¿t thÃºc</label><input type="time" id="ev_e" value="11:30"/></div>
            </div>
          </div>
          <div id="ui_flex" style="display:none">
            <div class="row">
              <div class="fg"><label>Sá»›m nháº¥t</label><input type="time" id="ev_es" value="17:30"/></div>
              <div class="fg"><label>Muá»™n nháº¥t</label><input type="time" id="ev_le" value="20:00"/></div>
              <div class="fg"><label>Thá»i lÆ°á»£ng (phÃºt)</label><input type="number" id="ev_fd" value="30" min="5" step="5"/></div>
            </div>
          </div>
          <!-- Once: date picker -->
          <div id="ui_once" style="display:none">
            <div class="row">
              <div class="fg"><label>NgÃ y diá»…n ra</label><input type="date" id="ev_once_date"/></div>
              <div class="fg"><label>Báº¯t Ä‘áº§u</label><input type="time" id="ev_once_s" value="08:00"/></div>
              <div class="fg"><label>Káº¿t thÃºc</label><input type="time" id="ev_once_e" value="10:00"/></div>
            </div>
          </div>
          <!-- Repeat days (only for fixed/flex) -->
          <div id="ui_repeat" class="row" style="align-items:center">
            <div class="fg"><label>Láº·p láº¡i ngÃ y</label><div class="dpick" id="dayPick"></div></div>
            <div class="fg" style="max-width:115px"><label>MÃ u</label><div class="cpick" id="colPick"></div></div>
          </div>
          <!-- Color for once events -->
          <div id="ui_once_color" style="display:none;margin-bottom:9px">
            <div class="fg"><label>MÃ u</label><div class="cpick" id="colPickOnce"></div></div>
          </div>
          <button class="btn bp" onclick="addEvent()">â• ThÃªm sá»± kiá»‡n</button>
        </div>
        <div class="card">
          <div class="ct">ğŸ“‹ Sá»± kiá»‡n (<span id="evCount">0</span>)</div>
          <div id="evList"></div>
        </div>
      </div>
    </div>

    <!-- TASKS -->
    <div class="page" id="pg-tk">
      <div class="scroll">
        <div class="card">
          <div class="ct">â• ThÃªm cÃ´ng viá»‡c</div>
          <div class="row">
            <div class="fg" style="flex:2"><label>TÃªn cÃ´ng viá»‡c</label>
              <input id="tk_n" placeholder="LÃ m bÃ i ToÃ¡n, Viáº¿t vÄƒnâ€¦" oninput="autoDetectSubject(this.value)"/></div>
            <div class="fg" style="max-width:115px"><label>Thá»i lÆ°á»£ng (phÃºt)</label>
              <input type="number" id="tk_d" value="60" min="10" max="480" step="5"/></div>
          </div>
          <div class="fg" style="margin-bottom:9px">
            <label>MÃ´n há»c <span id="subjectAutoLabel" style="color:var(--grn);font-size:.68rem"></span></label>
            <div class="subj-btns" id="subjBtns"></div>
          </div>
          <div class="row">
            <div class="fg">
              <label>Äá»™ khÃ³</label>
              <div class="pri-btns" id="diffBtns">
                <div class="pri-btn" data-diff="easy" onclick="selectDiff('easy')">ğŸŸ¢ Dá»…</div>
                <div class="pri-btn on-med" data-diff="med" onclick="selectDiff('med')">ğŸŸ¡ Trung bÃ¬nh</div>
                <div class="pri-btn" data-diff="hard" onclick="selectDiff('hard')">ğŸ”´ KhÃ³</div>
              </div>
            </div>
            <div class="fg">
              <label>Æ¯u tiÃªn</label>
              <div class="pri-btns" id="priBtns">
                <div class="pri-btn" data-pri="high" onclick="selectPri('high')">ğŸ”´ Cao</div>
                <div class="pri-btn on-med" data-pri="med" onclick="selectPri('med')">ğŸŸ¡ TB</div>
                <div class="pri-btn" data-pri="low" onclick="selectPri('low')">ğŸŸ¢ Tháº¥p</div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="fg"><label>ğŸ“… Báº¯t Ä‘áº§u tá»« ngÃ y</label><input type="date" id="tk_dfrom"/></div>
            <div class="fg"><label>ğŸ Háº¡n chÃ³t</label><input type="date" id="tk_dto"/></div>
          </div>
          <div class="row">
            <div class="fg"><label>Khung giá» Æ°u tiÃªn</label>
              <select id="tk_pref">
                <option value="auto">ğŸ¤– Tá»± Ä‘á»™ng</option>
                <option value="morning">ğŸŒ… SÃ¡ng (6hâ€“12h)</option>
                <option value="afternoon">ğŸŒ¤ï¸ Chiá»u (12hâ€“18h)</option>
                <option value="evening">ğŸŒ™ Tá»‘i (18hâ€“22h)</option>
              </select></div>
            <div class="fg"><label>PhÆ°Æ¡ng phÃ¡p há»c</label>
              <select id="tk_method">
                <option value="normal">ğŸ“– BÃ¬nh thÆ°á»ng</option>
                <option value="pomodoro">ğŸ… Pomodoro (25+5)</option>
                <option value="spaced">ğŸ“… Spaced Repetition</option>
              </select></div>
          </div>
          <div class="row">
            <div class="fg"><label>Ghi chÃº</label><input id="tk_note" placeholder="Ghi chÃºâ€¦"/></div>
          </div>
          <div style="display:flex;gap:7px;flex-wrap:wrap">
            <button class="btn bg" onclick="addTask()">â• ThÃªm cÃ´ng viá»‡c</button>
            <button class="btn bp sm" onclick="runScheduler()">âš¡ Xáº¿p lá»‹ch</button>
          </div>
        </div>
        <div class="card">
          <div class="ct">ğŸ“‹ CÃ´ng viá»‡c (<span id="tkCount">0</span>)</div>
          <div style="display:flex;gap:6px;margin-bottom:11px;flex-wrap:wrap">
            <select id="schedMode" style="padding:5px 9px;border:1.5px solid var(--brd);border-radius:7px;background:var(--surf2);color:var(--txt);font:.78rem var(--font)">
              <option value="hard-first">ğŸ”´ KhÃ³ trÆ°á»›c</option>
              <option value="interleave">ğŸ”„ Xen káº½ khÃ³-dá»…</option>
              <option value="greedy">âš¡ Greedy (deadline)</option>
              <option value="energy">âš¡ Energy-based</option>
            </select>
            <button class="btn bgh sm" onclick="clearDone()">ğŸ—‘ï¸ XÃ³a Ä‘Ã£ xong</button>
          </div>
          <div id="tkList"></div>
        </div>
      </div>
    </div>

<!-- â•â•â•â• SEC-HTML-4 Â· Stats Â· Setup Â· Edit Modals â•â•â•â• -->
    <!-- STATS -->
    <div class="page" id="pg-stats">
      <div class="scroll">
        <div class="stat-tabs">
          <button class="stat-tab on" onclick="switchStatTab('day',this)">ğŸ“† NgÃ y</button>
          <button class="stat-tab" onclick="switchStatTab('week',this)">ğŸ—“ï¸ Tuáº§n</button>
          <button class="stat-tab" onclick="switchStatTab('month',this)">ğŸ“… ThÃ¡ng</button>
          <button class="stat-tab" onclick="switchStatTab('year',this)">ğŸ“Š NÄƒm</button>
        </div>
        <div id="statsContent"></div>
      </div>
    </div>

    <!-- SETUP -->
    <div class="page" id="pg-setup">
      <div class="scroll">
        <div class="card">
          <div class="ct">ğŸ¤– Cháº¿ Ä‘á»™ AI</div>
          <div class="mode-selector" style="margin-bottom:12px">
            <div class="mode-opt on" id="setup-mopt-fake" onclick="selectAiMode('fake');syncSetupModeUI()" style="background:var(--surf2);border-color:var(--brd)">
              <div class="mo-icon">ğŸ§ </div><div class="mo-title" style="color:var(--pri)">Fake AI</div>
              <div class="mo-desc" style="color:var(--txt2)">Offline, miá»…n phÃ­</div>
            </div>
            <div class="mode-opt" id="setup-mopt-gemini" onclick="selectAiMode('gemini');syncSetupModeUI()" style="background:var(--surf2);border-color:var(--brd)">
              <div class="mo-icon">âœ¨</div><div class="mo-title" style="color:var(--pri)">Gemini AI</div>
              <div class="mo-desc" style="color:var(--txt2)">Cáº§n API key</div>
            </div>
          </div>
          <div id="setup-gemini-section" style="display:none">
            <div class="row" style="align-items:flex-end">
              <div class="fg"><label>Gemini API Key</label><input type="password" id="setup_apikey" placeholder="AIzaâ€¦"/></div>
              <button class="btn bp sm" onclick="setupSaveGemini()">ğŸ’¾ Test</button>
            </div>
            <div id="setupTestResult2" style="font-size:.78rem;color:var(--txt2);margin-top:4px;min-height:18px"></div>
            <div class="setup-api-warning">âš ï¸ KhÃ´ng chia sáº» API key.</div>
          </div>
          <div id="setup-fake-section" style="margin-top:4px">
            <button class="btn bp sm" onclick="applyAiModeSave()">ğŸ’¾ Ãp dá»¥ng</button>
          </div>
        </div>
        <div class="card">
          <div class="ct">ğŸ”” ThÃ´ng bÃ¡o</div>
          <div id="notifStatus" style="font-size:.8rem;margin-bottom:8px;color:var(--txt2)">Äang kiá»ƒm traâ€¦</div>
          <button class="btn bp sm" onclick="requestNotif()">ğŸ”” Báº­t thÃ´ng bÃ¡o</button>
        </div>
        <div class="card">
          <div class="ct">âš¡ CÃ i Ä‘áº·t xáº¿p lá»‹ch</div>
          <div class="toggle-row"><label>Æ¯u tiÃªn mÃ´n khÃ³ buá»•i sÃ¡ng</label><input type="checkbox" class="tgl" id="cfg_hardMorning" checked/></div>
          <div class="toggle-row"><label>Pomodoro (25p há»c + nghá»‰ báº¯t buá»™c)</label><input type="checkbox" class="tgl" id="cfg_pomodoro" checked/></div>
          <div class="toggle-row"><label>Spaced Repetition tá»± Ä‘á»™ng</label><input type="checkbox" class="tgl" id="cfg_spaced" checked/></div>
          <div class="toggle-row"><label>Interleaving (xen káº½ mÃ´n)</label><input type="checkbox" class="tgl" id="cfg_interleave" checked/></div>
          <div class="toggle-row"><label>Tá»± tÃ¡ch task dÃ i (>&nbsp;90p)</label><input type="checkbox" class="tgl" id="cfg_splitLong" checked/></div>
          <div class="row" style="margin-top:9px">
            <div class="fg"><label>Energy peak (giá» táº­p trung tá»‘t nháº¥t)</label>
              <select id="cfg_energyPeak">
                <option value="morning">ğŸŒ… SÃ¡ng (6hâ€“12h)</option>
                <option value="afternoon">ğŸŒ¤ï¸ Chiá»u (12hâ€“18h)</option>
                <option value="evening">ğŸŒ™ Tá»‘i (18hâ€“22h)</option>
              </select>
            </div>
            <div class="fg"><label>NgÆ°á»¡ng tÃ¡ch task dÃ i (phÃºt)</label>
              <input type="number" id="cfg_splitThreshold" value="90" min="30" max="180" step="15"/>
            </div>
          </div>
          <div style="margin-top:10px"><button class="btn bp sm" onclick="saveCfg()">ğŸ’¾ LÆ°u cÃ i Ä‘áº·t</button></div>
        </div>
        <div class="card">
          <div class="ct">ğŸ“¥ Dá»¯ liá»‡u Demo</div>
          <p style="font-size:.8rem;color:var(--txt2);margin-bottom:9px">Táº£i lá»‹ch máº«u. <strong style="color:var(--red)">XÃ³a dá»¯ liá»‡u hiá»‡n táº¡i!</strong></p>
          <div style="display:flex;gap:7px;flex-wrap:wrap">
            <button class="btn bb sm" onclick="loadDemoData()">ğŸ“¥ Load Demo</button>
            <button class="btn br sm" onclick="resetAllData()">ğŸ—‘ï¸ XÃ³a táº¥t cáº£</button>
          </div>
        </div>
        <div class="card">
          <div class="ct">ğŸ“‹ Láº¥y Gemini API Key</div>
          <div class="step-g"><div class="sn-g">1</div><div><div class="code-b">https://aistudio.google.com<button class="cpbtn" onclick="cp('https://aistudio.google.com')">Copy</button></div></div></div>
          <div class="step-g"><div class="sn-g">2</div><div>ÄÄƒng nháº­p â†’ <strong>Get API Key</strong> â†’ <strong>Create API key</strong></div></div>
          <div class="tip-b">ğŸ’¡ Free tier: 15 req/phÃºt â€“ Ä‘á»§ dÃ¹ng cÃ¡ nhÃ¢n.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Slot/Task Edit Modal -->
  <div id="editModal" onclick="if(event.target===this)closeEdit()">
    <div class="m-box">
      <div class="m-hdr"><h3 id="editTitle">âœï¸ Chá»‰nh sá»­a</h3><button class="btn bgh sm" onclick="closeEdit()">âœ•</button></div>
      <div class="m-body">
        <div class="row"><div class="fg"><label>TÃªn</label><input id="e_name"/></div></div>
        <div class="row">
          <div class="fg"><label>Báº¯t Ä‘áº§u</label><input type="time" id="e_start"/></div>
          <div class="fg"><label>Káº¿t thÃºc</label><input type="time" id="e_end"/></div>
        </div>
        <div class="row">
          <div class="fg"><label>Æ¯u tiÃªn</label>
            <select id="e_pri"><option value="high">ğŸ”´ Cao</option><option value="med">ğŸŸ¡ TB</option><option value="low">ğŸŸ¢ Tháº¥p</option></select></div>
          <div class="fg"><label>Thá»i lÆ°á»£ng (phÃºt)</label><input type="number" id="e_dur" min="10" step="5"/></div>
        </div>
        <div class="row">
          <div class="fg"><label>ğŸ“… Tá»« ngÃ y</label><input type="date" id="e_dfrom"/></div>
          <div class="fg"><label>ğŸ Äáº¿n ngÃ y</label><input type="date" id="e_dto"/></div>
        </div>
        <div class="row"><div class="fg"><label>Ghi chÃº</label><textarea id="e_note" rows="2"></textarea></div></div>
      </div>
      <div class="m-ftr">
        <button class="btn br sm" onclick="deleteEditTarget()">ğŸ—‘ï¸ XÃ³a</button>
        <div style="flex:1"></div>
        <button class="btn bgh sm" onclick="closeEdit()">Huá»·</button>
        <button class="btn bp sm" onclick="saveEdit()">ğŸ’¾ LÆ°u</button>
      </div>
    </div>
  </div>

  <!-- Event Edit Modal -->
  <div id="evEditModal" onclick="if(event.target===this)closeEvEdit()">
    <div class="m-box">
      <div class="m-hdr"><h3>âœï¸ Chá»‰nh sá»­a sá»± kiá»‡n</h3><button class="btn bgh sm" onclick="closeEvEdit()">âœ•</button></div>
      <div class="m-body">
        <div class="row"><div class="fg"><label>TÃªn</label><input id="ee_name"/></div></div>
        <div class="row">
          <div class="fg"><label>Loáº¡i</label>
            <select id="ee_type" onchange="toggleEvEditType()">
              <option value="fixed">ğŸ“Œ Cá»‘ Ä‘á»‹nh</option>
              <option value="flex">ğŸ”€ Linh hoáº¡t</option>
              <option value="once">ğŸ“ Äá»™t xuáº¥t</option>
            </select></div>
          <div class="fg"><label>Æ¯u tiÃªn</label>
            <select id="ee_pri"><option value="high">ğŸ”´ Cao</option><option value="med">ğŸŸ¡ TB</option><option value="low">ğŸŸ¢ Tháº¥p</option></select></div>
        </div>
        <div id="ee_fix_ui">
          <div class="row">
            <div class="fg"><label>Báº¯t Ä‘áº§u</label><input type="time" id="ee_start"/></div>
            <div class="fg"><label>Káº¿t thÃºc</label><input type="time" id="ee_end"/></div>
          </div>
        </div>
        <div id="ee_flex_ui" style="display:none">
          <div class="row">
            <div class="fg"><label>Sá»›m nháº¥t</label><input type="time" id="ee_estart"/></div>
            <div class="fg"><label>Muá»™n nháº¥t</label><input type="time" id="ee_lend"/></div>
            <div class="fg"><label>Thá»i lÆ°á»£ng (phÃºt)</label><input type="number" id="ee_dur" min="5" step="5"/></div>
          </div>
        </div>
        <div id="ee_once_ui" style="display:none">
          <div class="row">
            <div class="fg"><label>NgÃ y</label><input type="date" id="ee_once_date"/></div>
            <div class="fg"><label>Báº¯t Ä‘áº§u</label><input type="time" id="ee_once_s"/></div>
            <div class="fg"><label>Káº¿t thÃºc</label><input type="time" id="ee_once_e"/></div>
          </div>
        </div>
        <div id="ee_repeat_row" class="fg" style="margin-top:8px"><label>Láº·p láº¡i ngÃ y</label><div class="dpick" id="ee_dayPick"></div></div>
        <div class="fg" style="margin-top:8px"><label>MÃ u</label><div class="cpick" id="ee_colPick"></div></div>
      </div>
      <div class="m-ftr">
        <button class="btn br sm" onclick="deleteEvEdit()">ğŸ—‘ï¸ XÃ³a</button>
        <div style="flex:1"></div>
        <button class="btn bgh sm" onclick="closeEvEdit()">Huá»·</button>
        <button class="btn bp sm" onclick="saveEvEdit()">ğŸ’¾ LÆ°u</button>
      </div>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
'use strict';
/* â•â•â•â• SEC-JS-1 Â· DB Â· Constants Â· Time Utils Â· Undo â•â•â•â• */
const COLORS=['#7c3aed','#3b82f6','#10b981','#f59e0b','#ef4444','#f97316','#ec4899','#0ea5e9','#84cc16'];
const DAY_VI=['CN','T2','T3','T4','T5','T6','T7'];
const DAY_FULL=['Chá»§ Nháº­t','Thá»© Hai','Thá»© Ba','Thá»© TÆ°','Thá»© NÄƒm','Thá»© SÃ¡u','Thá»© Báº£y'];
const MON_VI=['ThÃ¡ng 1','ThÃ¡ng 2','ThÃ¡ng 3','ThÃ¡ng 4','ThÃ¡ng 5','ThÃ¡ng 6','ThÃ¡ng 7','ThÃ¡ng 8','ThÃ¡ng 9','ThÃ¡ng 10','ThÃ¡ng 11','ThÃ¡ng 12'];

const DB={
  K:{TASKS:'ssp_tasks',EVENTS:'ssp_events',SCHED:'ssp_sched',CHAT:'ssp_chat',CFG:'ssp_cfg',UNDO:'ssp_undo',APIKEY:'ssp_apikey'},
  get(k,def=[]){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def;}catch{return def;}},
  set(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){console.warn(e);}},
  clear(){Object.values(this.K).forEach(k=>localStorage.removeItem(k));}
};

let weekOff=0,tlDate=null,selPri='med',selDiff='med',selSubj='',editCtx=null;
let undoSnap=null,notifTimer=null,nowTimer=null,pendingAiMode='fake';
let evEditId=null,aiPendingAction=null;
let aiCtx={waitingFor:null,tempData:{}};

let events=DB.get(DB.K.EVENTS);
let tasks=DB.get(DB.K.TASKS);
let schedule=DB.get(DB.K.SCHED,{});

function getCfg(){
  return Object.assign({
    aiMode:'fake',darkMode:false,hardMorning:true,pomodoro:true,
    spaced:true,interleave:true,energyPeak:'morning',
    splitLong:true,splitThreshold:90
  },DB.get(DB.K.CFG,{}));
}
let cfg=getCfg();

const t2m=s=>{const[h,m]=s.split(':').map(Number);return h*60+m;};
const m2t=m=>`${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
function dateToStr(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function todayStr(){return dateToStr(new Date());}
function dsToDate(ds){return new Date(ds+'T12:00:00');}
function getMonday(off=0){
  const d=new Date();d.setHours(12,0,0,0);
  const dow=d.getDay();
  d.setDate(d.getDate()+(dow===0?-6:1-dow)+off*7);
  d.setHours(0,0,0,0);return d;
}
function offStr(n){const d=new Date();d.setHours(12,0,0,0);d.setDate(d.getDate()+n);return dateToStr(d);}

function parseNatDate(text){
  const tl=text.toLowerCase();
  if(/hÃ´m nay|today/.test(tl))return todayStr();
  if(/ngÃ y mai|mai\b|tomorrow/.test(tl))return offStr(1);
  if(/hÃ´m qua|yesterday/.test(tl))return offStr(-1);
  if(/thá»© hai|monday/.test(tl))return nextWeekday(1);
  if(/thá»© ba|tuesday/.test(tl))return nextWeekday(2);
  if(/thá»© tÆ°|wednesday/.test(tl))return nextWeekday(3);
  if(/thá»© nÄƒm|thursday/.test(tl))return nextWeekday(4);
  if(/thá»© sÃ¡u|friday/.test(tl))return nextWeekday(5);
  if(/thá»© báº£y|saturday/.test(tl))return nextWeekday(6);
  if(/chá»§ nháº­t|sunday/.test(tl))return nextWeekday(0);
  const dm=text.match(/(\d{1,2})[\/\-](\d{1,2})/);
  if(dm){const y=new Date().getFullYear();return `${y}-${dm[2].padStart(2,'0')}-${dm[1].padStart(2,'0')}`;}
  const dn=text.match(/ngÃ y\s+(\d{1,2})/i);
  if(dn){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(+dn[1]).padStart(2,'0')}`;}
  return null;
}
function nextWeekday(target){
  const d=new Date();d.setHours(12,0,0,0);
  let diff=(target-d.getDay()+7)%7;if(diff===0)diff=7;
  d.setDate(d.getDate()+diff);return dateToStr(d);
}

function saveUndo(label){
  undoSnap={label,ts:Date.now(),
    tasks:JSON.parse(JSON.stringify(tasks)),
    events:JSON.parse(JSON.stringify(events)),
    schedule:JSON.parse(JSON.stringify(schedule))};
  DB.set(DB.K.UNDO,undoSnap);
  const btn=document.getElementById('btnUndo');
  btn.style.display='flex';btn.title=`HoÃ n tÃ¡c: ${label}`;
}
function applyUndo(){
  if(!undoSnap){showToast('âš ï¸ KhÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ hoÃ n tÃ¡c!');return;}
  if(!confirm(`HoÃ n tÃ¡c: "${undoSnap.label}"?`))return;
  ({tasks,events,schedule}=undoSnap);
  DB.set(DB.K.TASKS,tasks);DB.set(DB.K.EVENTS,events);DB.set(DB.K.SCHED,schedule);
  undoSnap=null;DB.set(DB.K.UNDO,null);
  document.getElementById('btnUndo').style.display='none';
  renderAll();showToast('â†© ÄÃ£ hoÃ n tÃ¡c!');
}
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();applyUndo();}});

/* â•â•â•â• SEC-JS-2 Â· Subject Classifier â•â•â•â• */
const SUBJECT_MAP=[
  [/\b(toÃ¡n|sá»‘ há»c|Ä‘áº¡i sá»‘|hÃ¬nh há»c|giáº£i tÃ­ch|bÃ i toÃ¡n|Ä‘áº¡o hÃ m|tÃ­ch phÃ¢n|lÆ°á»£ng giÃ¡c)\b/i,'ToÃ¡n','hard','#ef4444','ğŸ”¢'],
  [/\b(váº­t lÃ½|váº­t lÃ­|lÃ½|cÆ¡ há»c|Ä‘iá»‡n há»c|quang há»c|dao Ä‘á»™ng|nhiá»‡t há»c)\b/i,'Váº­t LÃ½','hard','#f97316','âš›ï¸'],
  [/\b(hÃ³a há»c|hoÃ¡ há»c|hÃ³a|hoÃ¡|pháº£n á»©ng|nguyÃªn tá»‘|há»¯u cÆ¡|vÃ´ cÆ¡|axit)\b/i,'HÃ³a Há»c','hard','#8b5cf6','ğŸ§ª'],
  [/\b(tin há»c|láº­p trÃ¬nh|code|coding|thuáº­t toÃ¡n|python|java|html|css)\b/i,'Tin Há»c','hard','#0ea5e9','ğŸ’»'],
  [/\b(tiáº¿ng anh|anh vÄƒn|english|tá»« vá»±ng|grammar|listening|speaking)\b/i,'Tiáº¿ng Anh','memory','#3b82f6','ğŸ‡¬ğŸ‡§'],
  [/\b(ngá»¯ vÄƒn|vÄƒn há»c|vÄƒn|viáº¿t vÄƒn|Ä‘á»c hiá»ƒu|táº­p lÃ m vÄƒn)\b/i,'Ngá»¯ VÄƒn','creative','#ec4899','âœï¸'],
  [/\b(lá»‹ch sá»­|sá»­|tháº¿ chiáº¿n|phong trÃ o|triá»u Ä‘áº¡i|cÃ¡ch máº¡ng)\b/i,'Lá»‹ch Sá»­','memory','#d97706','ğŸ“œ'],
  [/\b(Ä‘á»‹a lÃ½|Ä‘á»‹a|Ä‘á»‹a lÃ­|báº£n Ä‘á»“|khÃ­ háº­u|chÃ¢u lá»¥c)\b/i,'Äá»‹a LÃ½','memory','#16a34a','ğŸ—ºï¸'],
  [/\b(sinh há»c|sinh|táº¿ bÃ o|di truyá»n|há»‡ sinh thÃ¡i|vi sinh)\b/i,'Sinh Há»c','memory','#10b981','ğŸŒ±'],
  [/\b(thá»ƒ dá»¥c|thá»ƒ thao|váº­n Ä‘á»™ng|cháº¡y|bÆ¡i|yoga|gym)\b/i,'Thá»ƒ Dá»¥c','physical','#84cc16','ğŸƒ'],
  [/\b(gdcd|giÃ¡o dá»¥c cÃ´ng dÃ¢n|phÃ¡p luáº­t)\b/i,'GDCD','memory','#6b7280','ğŸ›ï¸'],
];
const SUBJECTS_LIST=['ToÃ¡n','Váº­t LÃ½','HÃ³a Há»c','Ngá»¯ VÄƒn','Tiáº¿ng Anh','Lá»‹ch Sá»­','Äá»‹a LÃ½','Sinh Há»c','Tin Há»c','Thá»ƒ Dá»¥c','GDCD','KhÃ¡c'];

function classifyTask(title,override=''){
  if(override){const f=SUBJECT_MAP.find(([,s])=>s===override);if(f)return{subject:f[1],type:f[2],color:f[3],emoji:f[4]};}
  for(const[re,subject,type,color,emoji]of SUBJECT_MAP)if(re.test(title))return{subject,type,color,emoji};
  if(/(Ã´n táº­p|Ã´n luyá»‡n|lÃ m bÃ i|bÃ i táº­p|kiá»ƒm tra)/.test(title.toLowerCase()))
    return{subject:'Chung',type:'hard',color:'#7c3aed',emoji:'ğŸ“–'};
  return{subject:'KhÃ¡c',type:'general',color:'#9ca3af',emoji:'âœï¸'};
}

/* â•â•â•â• SEC-JS-3 Â· Scheduler v12.1 â•â•â•â•
   FIX: Proper Pomodoro = 25min study + MANDATORY 5min break (not optional).
        Long tasks (>threshold) are always split into blocks.
        Breaks are actual free-time gaps, not overlapping slots.
        Energy-based, interleave, difficulty-time mapping all preserved.
*/
const SCHED_CFG={
  DAY_START:6*60,DAY_END:22*60,
  // Pomodoro constants
  POMO_STUDY:25,POMO_SHORT_BREAK:5,POMO_LONG_BREAK:15,POMO_LONG_AFTER:2,
  PREF:{
    hard    :[{from:6*60,to:12*60}],
    creative:[{from:9*60,to:12*60},{from:19*60,to:21*60}],
    memory  :[{from:7*60,to:9*60},{from:20*60,to:22*60}],
    physical:[{from:6*60,to:8*60},{from:16*60,to:18*60}],
    general :[{from:6*60,to:22*60}]
  },
  ENERGY:{morning:{from:6*60,to:12*60},afternoon:{from:12*60,to:18*60},evening:{from:18*60,to:22*60}}
};

/** Returns free intervals [from,to] not covered by placed slots */
function freeSlots(placed,from,to,minLen=5){
  const sorted=[...placed].sort((a,b)=>a.start-b.start);
  const free=[];let cur=from;
  for(const s of sorted){
    if(s.start>cur){
      const gEnd=Math.min(s.start,to);
      if(gEnd-cur>=minLen)free.push({start:cur,end:gEnd});
    }
    if(s.end>cur)cur=s.end;
    if(cur>=to)break;
  }
  if(cur<to&&to-cur>=minLen)free.push({start:cur,end:to});
  return free;
}

/** Find best starting minute from freeList for a block of `dur` minutes */
function findBestSlot(freeList,dur,prefWin){
  if(prefWin){
    for(const win of prefWin){
      for(const f of freeList){
        const ws=Math.max(f.start,win.from),we=Math.min(f.end,win.to);
        if(we-ws>=dur)return ws;
      }
    }
  }
  const fit=freeList.find(f=>f.end-f.start>=dur);
  return fit?fit.start:null;
}

/** Place a mandatory break block after a study block */
function placeBreak(placed,breakDur,name,color){
  const fr=freeSlots(placed,SCHED_CFG.DAY_START,SCHED_CFG.DAY_END,breakDur);
  if(!fr.length)return;
  const pos=fr[0].start;
  // Only place if it immediately follows the last placed item
  const lastEnd=Math.max(...placed.map(p=>p.end));
  if(pos<=lastEnd+1){ // adjacent or overlapping start â†’ snap to lastEnd
    placed.push({name,start:lastEnd,end:lastEnd+breakDur,kind:'buffer',color,done:false});
    placed.sort((a,b)=>a.start-b.start);
  }
}

/** Score a task for priority ordering */
function taskScore(t,ds){
  let s={high:300,med:200,low:100}[t.pri]||100;
  s+={hard:80,med:40,easy:10}[t.diff||'med']||40;
  if(t.dateTo){
    const diff=(new Date(t.dateTo)-new Date(ds))/86400000;
    if(diff<0)s+=300;else if(diff<1)s+=200;else if(diff<3)s+=120;else if(diff<7)s+=60;
  }
  return s;
}

/** Spaced repetition review dates */
function spacedDates(dateFrom){
  const base=new Date(dateFrom+'T12:00:00');
  return[1,3,7,14].map(d=>{const r=new Date(base);r.setDate(r.getDate()+d);return dateToStr(r);});
}

/** Main scheduler */
function runScheduler(){
  const mode=document.getElementById('schedMode')?.value||'hard-first';
  const newSched={};
  const mon=getMonday(weekOff);
  const energyWin=SCHED_CFG.ENERGY[cfg.energyPeak||'morning'];
  const splitThreshold=cfg.splitThreshold||90; // minutes before forcing split

  for(let d=0;d<21;d++){
    const date=new Date(mon);date.setDate(mon.getDate()+d);
    const ds=dateToStr(date),dow=date.getDay();
    const placed=[];

    /* 1. Fixed events */
    events.filter(e=>e.type==='fixed'&&(e.repeat||[]).includes(dow))
      .forEach(e=>placed.push({
        name:e.name,start:t2m(e.start),end:t2m(e.end),
        kind:'ev-fix',pri:e.pri,color:e.color||'#3b82f6',done:false,locked:true
      }));

    /* 2. Once (one-time) events */
    events.filter(e=>e.type==='once'&&e.onceDate===ds)
      .forEach(e=>placed.push({
        name:e.name,start:t2m(e.start),end:t2m(e.end),
        kind:'ev-once',pri:e.pri,color:e.color||'#f97316',done:false,locked:true
      }));

    /* 3. Flex events */
    events.filter(e=>e.type==='flex'&&(e.repeat||[]).includes(dow))
      .sort((a,b)=>({high:3,med:2,low:1}[b.pri]||1)-({high:3,med:2,low:1}[a.pri]||1))
      .forEach(e=>{
        const fr=freeSlots(placed,t2m(e.eStart),t2m(e.lEnd),e.dur);
        const pos=findBestSlot(fr,e.dur,null);
        if(pos!==null)placed.push({name:e.name,start:pos,end:pos+e.dur,kind:'ev-flex',pri:e.pri,color:e.color||'#f59e0b',done:false});
      });

    placed.sort((a,b)=>a.start-b.start);

    /* 4. Active tasks */
    let activeTasks=tasks.filter(t=>{
      if(t.done)return false;
      if(t.dateFrom&&ds<t.dateFrom)return false;
      if(t.dateTo&&ds>t.dateTo)return false;
      return true;
    }).map(t=>({...t,score:taskScore(t,ds),_cls:classifyTask(t.name,t.subjectOverride||'')}));

    /* 4b. Spaced repetition review tasks */
    if(cfg.spaced){
      tasks.filter(t=>t.method==='spaced'&&t.dateFrom).forEach(t=>{
        if(spacedDates(t.dateFrom).includes(ds)){
          const reviewDur=Math.max(20,Math.round(t.dur*0.3));
          activeTasks.push({...t,id:t.id+'_rev_'+ds,name:'ğŸ” Ã”n: '+t.name,
            dur:reviewDur,score:taskScore(t,ds)+50,
            _cls:classifyTask(t.name,t.subjectOverride||''),_isReview:true});
        }
      });
    }

    /* 5. Sort by strategy */
    let ordered=[];
    if(mode==='hard-first'){
      const dScore={hard:3,med:2,easy:1};
      ordered=[...activeTasks].sort((a,b)=>(dScore[b.diff||'med']||2)-(dScore[a.diff||'med']||2)||(b.score-a.score));
    } else if(mode==='interleave'){
      const groups={};
      activeTasks.forEach(t=>{const sub=t._cls.subject;if(!groups[sub])groups[sub]=[];groups[sub].push(t);});
      Object.values(groups).forEach(g=>g.sort((a,b)=>b.score-a.score));
      const keys=Object.keys(groups);const idxs={};keys.forEach(k=>idxs[k]=0);
      let rem=activeTasks.length;
      while(rem>0){for(const k of keys){if(idxs[k]<groups[k].length){ordered.push(groups[k][idxs[k]++]);rem--;}}}
    } else if(mode==='energy'){
      const hard=activeTasks.filter(t=>(t.diff||'med')==='hard').sort((a,b)=>b.score-a.score);
      const others=activeTasks.filter(t=>(t.diff||'med')!=='hard').sort((a,b)=>b.score-a.score);
      ordered=[...hard,...others];
    } else {
      ordered=[...activeTasks].sort((a,b)=>b.score-a.score);
    }

    /* 6. Place tasks */
    for(const t of ordered){
      // Determine preferred time window
      let prefWin;
      if(t.pref&&t.pref!=='auto'){
        const m={morning:{from:6*60,to:12*60},afternoon:{from:12*60,to:18*60},evening:{from:18*60,to:22*60}};
        prefWin=m[t.pref]?[m[t.pref]]:null;
      } else if(mode==='energy'&&(t.diff||'med')==='hard'){
        prefWin=[energyWin];
      } else if(cfg.hardMorning&&(t.diff||'med')==='hard'){
        prefWin=SCHED_CFG.PREF.hard;
      } else {
        const diffMap={hard:SCHED_CFG.PREF.hard,med:[{from:12*60,to:18*60}],easy:[{from:18*60,to:22*60}]};
        prefWin=diffMap[t.diff||'med']||SCHED_CFG.PREF[t._cls.type]||SCHED_CFG.PREF.general;
      }

      // Decide whether to use Pomodoro splitting
      const usePomodoro=!t._isReview&&(t.method==='pomodoro'||(cfg.pomodoro&&t.dur>=50));
      // Decide whether to split long task (even without full Pomodoro)
      const useSplit=!t._isReview&&cfg.splitLong&&t.dur>splitThreshold&&!usePomodoro;

      if(usePomodoro){
        /* === Pomodoro: 25p study â†’ 5p break â†’ 25p study â†’ â€¦ â†’ after 2 blocks: 15p long break === */
        let remaining=t.dur;
        let blockNum=1;
        let pomodoroCount=0; // count of completed study blocks

        while(remaining>0){
          const studyDur=Math.min(SCHED_CFG.POMO_STUDY,remaining);
          const fr=freeSlots(placed,SCHED_CFG.DAY_START,SCHED_CFG.DAY_END,studyDur);
          const pos=findBestSlot(fr,studyDur,prefWin);
          if(pos===null)break;

          // Place study block
          placed.push({
            name:`${t.name} (P${blockNum})`,
            start:pos,end:pos+studyDur,
            kind:'task',pri:t.pri,diff:t.diff||'med',color:t._cls.color,
            taskId:t.id,done:t.done||false,locked:false,
            tag:t._cls.subject,note:t.note||'',
            dateFrom:t.dateFrom||'',dateTo:t.dateTo||'',
            subjectOverride:t.subjectOverride||''
          });
          placed.sort((a,b)=>a.start-b.start);
          remaining-=studyDur;
          pomodoroCount++;
          blockNum++;

          if(remaining<=0)break;

          // After POMO_LONG_AFTER study blocks â†’ long break
          if(pomodoroCount%SCHED_CFG.POMO_LONG_AFTER===0){
            const lastEnd=Math.max(...placed.map(p=>p.end));
            placed.push({name:'ğŸ§˜ Nghá»‰ dÃ i (15p)',start:lastEnd,end:lastEnd+SCHED_CFG.POMO_LONG_BREAK,kind:'buffer',color:'#9ca3af',done:false});
          } else {
            // Short break â€“ mandatory
            const lastEnd=Math.max(...placed.map(p=>p.end));
            placed.push({name:'â˜• Nghá»‰ ngáº¯n (5p)',start:lastEnd,end:lastEnd+SCHED_CFG.POMO_SHORT_BREAK,kind:'buffer',color:'#6b7280',done:false});
          }
          placed.sort((a,b)=>a.start-b.start);
        }
        continue;
      }

      if(useSplit){
        /* === Split long task into blocks of splitThreshold minutes === */
        let remaining=t.dur;
        let blockNum=1;
        const blockSize=splitThreshold;

        while(remaining>0){
          const bDur=Math.min(blockSize,remaining);
          const fr=freeSlots(placed,SCHED_CFG.DAY_START,SCHED_CFG.DAY_END,bDur);
          const pos=findBestSlot(fr,bDur,prefWin);
          if(pos===null)break;

          placed.push({
            name:`${t.name} (${blockNum})`,
            start:pos,end:pos+bDur,
            kind:'task',pri:t.pri,diff:t.diff||'med',color:t._cls.color,
            taskId:t.id,done:t.done||false,locked:false,
            tag:t._cls.subject,note:t.note||'',
            dateFrom:t.dateFrom||'',dateTo:t.dateTo||'',
            subjectOverride:t.subjectOverride||''
          });
          placed.sort((a,b)=>a.start-b.start);
          remaining-=bDur;blockNum++;

          if(remaining>0){
            // 15-min break between split blocks
            const lastEnd=Math.max(...placed.map(p=>p.end));
            placed.push({name:'ğŸ§˜ Nghá»‰ giá»¯a hiá»‡p',start:lastEnd,end:lastEnd+15,kind:'buffer',color:'#9ca3af',done:false});
            placed.sort((a,b)=>a.start-b.start);
          }
        }
        continue;
      }

      /* === Normal placement === */
      const fr=freeSlots(placed,SCHED_CFG.DAY_START,SCHED_CFG.DAY_END,t.dur);
      const pos=findBestSlot(fr,t.dur,prefWin);
      if(pos===null)continue;

      placed.push({
        name:t.name,start:pos,end:pos+t.dur,kind:'task',
        pri:t.pri,diff:t.diff||'med',color:t._cls.color,
        taskId:t.id,done:t.done||false,locked:false,
        tag:t._cls.subject,note:t.note||'',
        dateFrom:t.dateFrom||'',dateTo:t.dateTo||'',
        subjectOverride:t.subjectOverride||''
      });
      placed.sort((a,b)=>a.start-b.start);
    }

    newSched[ds]=placed;
  }

  schedule=newSched;DB.set(DB.K.SCHED,schedule);
  renderCalendar();
  if(tlDate)renderTimeline(tlDate,dsToDate(tlDate));
  scheduleNotifications();
  showToast(`âš¡ ÄÃ£ xáº¿p lá»‹ch (${mode})!`);
}

/* â•â•â•â• SEC-JS-4 Â· Calendar Render â•â•â•â• */
function chgWeek(d,mode){weekOff=mode==='today'?0:weekOff+d;renderCalendar();}

function renderCalendar(){
  const mon=getMonday(weekOff),today=todayStr();
  const end=new Date(mon);end.setDate(mon.getDate()+6);
  document.getElementById('wkLbl').textContent=
    `${mon.getDate()}/${mon.getMonth()+1} â€“ ${end.getDate()}/${end.getMonth()+1}/${mon.getFullYear()}`;
  const grid=document.getElementById('weekGrid');grid.innerHTML='';

  for(let d=0;d<7;d++){
    const date=new Date(mon);date.setDate(mon.getDate()+d);
    const ds=dateToStr(date);
    // Show ALL non-buffer events (no cap â€“ cell scrolls)
    const evs=(schedule[ds]||[]).filter(e=>e.kind!=='buffer');
    const taskDone=evs.filter(e=>e.kind==='task'&&e.done).length;
    const taskTot=evs.filter(e=>e.kind==='task').length;

    const col=document.createElement('div');
    col.className='dc'+(ds===today?' today':'')+(ds===tlDate?' selected':'');
    col.onclick=()=>selectDay(ds,date);

    // Header
    col.innerHTML=`<div class="dh">${DAY_VI[date.getDay()]}</div><div class="dd">${date.getDate()}</div>`;

    // Progress bar
    if(taskTot>0){
      const pb=document.createElement('div');
      pb.className='dc-prog';
      pb.innerHTML=`<div class="dc-prog-b" style="width:${Math.round(taskDone/taskTot*100)}%"></div>`;
      col.appendChild(pb);
    }

    if(!evs.length){
      const ph=document.createElement('div');
      ph.style.cssText='font-size:.54rem;color:var(--txt2);text-align:center;opacity:.5;padding:3px 0;flex-shrink:0';
      ph.textContent='Trá»‘ng';col.appendChild(ph);
    } else {
      // ALL chips â€“ cell scrolls internally
      evs.forEach(s=>{
        const{emoji=''}=s.kind==='task'?classifyTask(s.name,s.subjectOverride||''):{};
        const bl=document.createElement('div');
        bl.className='ce'+(s.done?' done':'');
        bl.style.cssText=`background:${s.color}20;color:${s.color};border-left-color:${s.color}`;
        bl.innerHTML=`<span class="ce-time">${m2t(s.start)}</span><span class="ce-name">${emoji?emoji+' ':''}${s.name}</span>`;
        col.appendChild(bl);
      });
    }
    grid.appendChild(col);
  }
}

function selectDay(ds,dateObj){
  tlDate=ds;renderCalendar();
  document.getElementById('tl-placeholder').style.display='none';
  document.getElementById('tl-body').style.display='block';
  renderTimeline(ds,dateObj);
}

/* â•â•â•â• SEC-JS-5 Â· Timeline Render + Drag-Drop â•â•â•â•
   FIX: Use left/right percentage columns to avoid overlap when tasks share time.
        Buffer slots rendered smaller and lighter.
        Explicit white text on colored background (no black artifact).
*/
const PX=1.6,TLS=5,TLE=24;
let dragState=null;

function updateNowLine(){
  const line=document.getElementById('tl-now-line');
  const lbl=document.getElementById('nowLbl');
  if(!tlDate||tlDate!==todayStr()){line.style.display='none';return;}
  const now=new Date(),nm=now.getHours()*60+now.getMinutes();
  if(nm<TLS*60||nm>=TLE*60){line.style.display='none';return;}
  line.style.top=((nm-TLS*60)*PX)+'px';line.style.display='block';
  lbl.textContent=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
}

/** Compute column layout for overlapping slots to avoid visual mess */
function computeColumns(slots){
  // Returns array of {slot, col, totalCols}
  const result=slots.map(s=>({slot:s,col:0,totalCols:1}));
  for(let i=0;i<result.length;i++){
    const cols=[]; // which columns are occupied at slot i's time
    for(let j=0;j<i;j++){
      if(result[j].slot.start<result[i].slot.end&&result[j].slot.end>result[i].slot.start){
        cols.push(result[j].col);
      }
    }
    // Assign smallest unused column
    let c=0;while(cols.includes(c))c++;
    result[i].col=c;
  }
  // Compute totalCols for each slot (max col in its overlap group + 1)
  for(let i=0;i<result.length;i++){
    let max=result[i].col;
    for(let j=0;j<result.length;j++){
      if(i!==j&&result[j].slot.start<result[i].slot.end&&result[j].slot.end>result[i].slot.start){
        if(result[j].col>max)max=result[j].col;
      }
    }
    result[i].totalCols=max+1;
  }
  return result;
}

function renderTimeline(ds,dateObj){
  document.getElementById('tlTitle').textContent=
    `${DAY_FULL[dateObj.getDay()]}, ${dateObj.getDate()}/${dateObj.getMonth()+1}/${dateObj.getFullYear()}`;
  const inner=document.getElementById('tl-inner');
  const totalH=(TLE-TLS)*60*PX;
  inner.style.height=totalH+'px';
  // Clear old slots/lines but keep now-line
  [...inner.children].forEach(c=>{if(c.id!=='tl-now-line')c.remove();});

  // Hour lines
  for(let h=TLS;h<=TLE;h++){
    const top=(h-TLS)*60*PX;
    const lbl=document.createElement('div');
    lbl.className='tl-hour';lbl.style.top=(top-8)+'px';lbl.textContent=h<24?h+':00':'';
    inner.appendChild(lbl);
    const ln=document.createElement('div');ln.className='tl-line';ln.style.top=top+'px';inner.appendChild(ln);
    if(h<TLE){
      const ln2=document.createElement('div');ln2.className='tl-line-half';ln2.style.top=(top+30*PX)+'px';inner.appendChild(ln2);
    }
  }

  const allSlots=schedule[ds]||[];

  // Conflict detection (non-buffer)
  const nonBuf=allSlots.filter(s=>s.kind!=='buffer');
  const cf=new Set();
  for(let i=0;i<nonBuf.length;i++)for(let j=i+1;j<nonBuf.length;j++)
    if(nonBuf[i].start<nonBuf[j].end&&nonBuf[i].end>nonBuf[j].start){cf.add(nonBuf[i].name);cf.add(nonBuf[j].name);}
  const banner=document.getElementById('conflictBanner');
  if(cf.size){document.getElementById('conflictMsg').textContent=`TrÃ¹ng giá»: ${[...cf].join(', ')}`;banner.classList.add('show');}
  else banner.classList.remove('show');

  // Compute column layout for non-buffer slots only
  const nbWithLayout=computeColumns(nonBuf);

  // Render buffer slots first (behind others)
  allSlots.filter(s=>s.kind==='buffer').forEach(s=>{
    if(s.start<TLS*60||s.end>TLE*60)return;
    const top=(s.start-TLS*60)*PX;
    const ht=Math.max((s.end-s.start)*PX-1,10);
    const el=document.createElement('div');
    el.className='tl-slot buffer-slot';
    // Explicit safe color to avoid black artifacts
    el.style.cssText=`top:${top}px;height:${ht}px;left:0;right:4px;background:${s.color||'#9ca3af'};color:#fff;z-index:3;opacity:.5`;
    el.innerHTML=`<div class="ts-name" style="font-size:.6rem">${s.name}</div>`;
    inner.appendChild(el);
  });

  // Render non-buffer slots with column layout
  nbWithLayout.forEach(({slot:s,col,totalCols},i)=>{
    if(s.start<TLS*60||s.end>TLE*60)return;
    const top=(s.start-TLS*60)*PX;
    const ht=Math.max((s.end-s.start)*PX-2,22);
    const el=document.createElement('div');
    el.className='tl-slot'+(s.done?' done':'');

    // Column-based left/right positioning (percentage)
    const colW=100/totalCols;
    const leftPct=col*colW;
    const rightPct=100-(col+1)*colW;

    // Ensure color is valid (fallback to purple to avoid black)
    const bgColor=s.color&&s.color!=='undefined'?s.color:'#7c3aed';

    el.style.cssText=`top:${top}px;height:${ht}px;left:calc(${leftPct}% + 1px);right:calc(${rightPct}% + 2px);background:${bgColor};color:#fff;z-index:${5+col}`;

    const{emoji=''}=s.kind==='task'?classifyTask(s.name,s.subjectOverride||''):{};
    const diffMark=s.diff?({hard:'ğŸ”´',med:'ğŸŸ¡',easy:'ğŸŸ¢'}[s.diff]||''):'';
    el.innerHTML=`<div class="ts-time">${m2t(s.start)}â€“${m2t(s.end)}</div>
      <div class="ts-name">${emoji?emoji+' ':''}${s.name} ${diffMark}</div>
      ${s.tag?`<div class="ts-sub">${s.tag}</div>`:''}`;

    // Drag support for unlocked slots
    if(!s.locked){
      el.draggable=true;
      el.addEventListener('dragstart',e=>{
        dragState={ds,slotName:s.name,dur:s.end-s.start};
        el.classList.add('dragging');
        e.dataTransfer.effectAllowed='move';
      });
      el.addEventListener('dragend',()=>{el.classList.remove('dragging');dragState=null;});
    }

    if(s.kind==='task'){
      const cb=document.createElement('input');
      cb.type='checkbox';cb.checked=s.done;cb.className='ts-cb';
      const idx=allSlots.indexOf(s);
      cb.onchange=ev=>{ev.stopPropagation();toggleDone(ds,idx);};
      el.appendChild(cb);
      el.onclick=ev=>{if(ev.target.type!=='checkbox'){const idx=allSlots.indexOf(s);openEditSlot(ds,idx);}};
    } else if(s.kind==='ev-fix'||s.kind==='ev-flex'||s.kind==='ev-once'){
      const idx=allSlots.indexOf(s);
      el.onclick=()=>openEditSlot(ds,idx);
    }
    inner.appendChild(el);
  });

  // Drop zone
  inner.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='move';});
  inner.addEventListener('drop',e=>{
    e.preventDefault();
    if(!dragState)return;
    const rect=inner.getBoundingClientRect();
    const relY=e.clientY-rect.top;
    const rawMin=Math.round(relY/PX/15)*15+TLS*60;
    const newStart=Math.max(SCHED_CFG.DAY_START,Math.min(rawMin,SCHED_CFG.DAY_END-dragState.dur));
    const newEnd=newStart+dragState.dur;
    // Find slot by name
    const idx=schedule[dragState.ds].findIndex(s=>s.name===dragState.slotName&&!s.locked);
    if(idx===-1){dragState=null;return;}
    saveUndo('KÃ©o tháº£ slot');
    schedule[dragState.ds][idx].start=newStart;
    schedule[dragState.ds][idx].end=newEnd;
    schedule[dragState.ds].sort((a,b)=>a.start-b.start);
    DB.set(DB.K.SCHED,schedule);
    renderTimeline(tlDate,dsToDate(tlDate));renderCalendar();
    showToast(`ğŸ“Œ ÄÃ£ di chuyá»ƒn â†’ ${m2t(newStart)}`);
    dragState=null;
  });

  if(nowTimer)clearInterval(nowTimer);
  updateNowLine();
  nowTimer=setInterval(updateNowLine,30000);
}

function toggleDone(ds,i){
  if(!schedule[ds]?.[i])return;
  schedule[ds][i].done=!schedule[ds][i].done;
  const tid=schedule[ds][i].taskId;
  if(tid){const t=tasks.find(t=>t.id==tid);if(t){t.done=schedule[ds][i].done;DB.set(DB.K.TASKS,tasks);}}
  DB.set(DB.K.SCHED,schedule);renderTimeline(ds,dsToDate(ds));renderCalendar();
}

/* â•â•â•â• SEC-JS-6 Â· Events CRUD + Edit Modal â•â•â•â• */

function toggleEvType(){
  const t=document.getElementById('ev_t').value;
  document.getElementById('ui_fix').style.display=t==='fixed'?'block':'none';
  document.getElementById('ui_flex').style.display=t==='flex'?'block':'none';
  document.getElementById('ui_once').style.display=t==='once'?'block':'none';
  document.getElementById('ui_repeat').style.display=t==='once'?'none':'flex';
  document.getElementById('ui_once_color').style.display=t==='once'?'block':'none';
}
// Legacy alias
function toggleFlex(){toggleEvType();}

function addEvent(){
  const name=document.getElementById('ev_n').value.trim();if(!name){alert('Nháº­p tÃªn!');return;}
  const type=document.getElementById('ev_t').value;
  let ev={id:Date.now(),name,type,pri:document.getElementById('ev_p').value};

  if(type==='once'){
    const d=document.getElementById('ev_once_date').value;
    if(!d){alert('Chá»n ngÃ y cho sá»± kiá»‡n Ä‘á»™t xuáº¥t!');return;}
    ev.onceDate=d;
    ev.start=document.getElementById('ev_once_s').value;
    ev.end=document.getElementById('ev_once_e').value;
    ev.color=document.querySelector('#colPickOnce .copt.on')?.dataset.color||COLORS[5];
    ev.repeat=[];
  } else {
    const days=[...document.querySelectorAll('#dayPick .dchip.on')].map(d=>+d.dataset.day);
    ev.color=document.querySelector('#colPick .copt.on')?.dataset.color||COLORS[0];
    ev.repeat=days;
    if(type==='fixed'){ev.start=document.getElementById('ev_s').value;ev.end=document.getElementById('ev_e').value;}
    else{ev.eStart=document.getElementById('ev_es').value;ev.lEnd=document.getElementById('ev_le').value;ev.dur=+document.getElementById('ev_fd').value;}
  }

  saveUndo('ThÃªm sá»± kiá»‡n');
  events.push(ev);DB.set(DB.K.EVENTS,events);renderEvents();
  document.getElementById('ev_n').value='';
  showToast('âœ… ÄÃ£ thÃªm sá»± kiá»‡n!');
}

function delEvent(id){
  if(!confirm('XÃ³a sá»± kiá»‡n?'))return;
  saveUndo('XÃ³a sá»± kiá»‡n');
  events=events.filter(e=>e.id!==id);DB.set(DB.K.EVENTS,events);renderEvents();
}

function openEvEdit(id){
  const ev=events.find(e=>e.id===id);if(!ev)return;
  evEditId=id;
  document.getElementById('ee_name').value=ev.name;
  document.getElementById('ee_type').value=ev.type||'fixed';
  document.getElementById('ee_pri').value=ev.pri;
  toggleEvEditType();
  if(ev.type==='fixed'){document.getElementById('ee_start').value=ev.start||'07:00';document.getElementById('ee_end').value=ev.end||'08:00';}
  else if(ev.type==='flex'){document.getElementById('ee_estart').value=ev.eStart||'17:00';document.getElementById('ee_lend').value=ev.lEnd||'20:00';document.getElementById('ee_dur').value=ev.dur||30;}
  else if(ev.type==='once'){document.getElementById('ee_once_date').value=ev.onceDate||todayStr();document.getElementById('ee_once_s').value=ev.start||'08:00';document.getElementById('ee_once_e').value=ev.end||'10:00';}
  const dp=document.getElementById('ee_dayPick');
  dp.innerHTML=['CN','T2','T3','T4','T5','T6','T7'].map((d,i)=>
    `<div class="dchip${(ev.repeat||[]).includes(i)?' on':''}" data-day="${i}" onclick="this.classList.toggle('on')">${d}</div>`).join('');
  document.getElementById('ee_colPick').innerHTML=COLORS.map((c,i)=>
    `<div class="copt${c===ev.color?' on':''}" style="background:${c}" data-color="${c}"
      onclick="document.querySelectorAll('#ee_colPick .copt').forEach(e=>e.classList.remove('on'));this.classList.add('on')"></div>`).join('');
  document.getElementById('evEditModal').classList.add('open');
}

function toggleEvEditType(){
  const t=document.getElementById('ee_type').value;
  document.getElementById('ee_fix_ui').style.display=t==='fixed'?'block':'none';
  document.getElementById('ee_flex_ui').style.display=t==='flex'?'block':'none';
  document.getElementById('ee_once_ui').style.display=t==='once'?'block':'none';
  document.getElementById('ee_repeat_row').style.display=t==='once'?'none':'block';
}

function saveEvEdit(){
  const ev=events.find(e=>e.id===evEditId);if(!ev)return;
  saveUndo('Sá»­a sá»± kiá»‡n');
  ev.name=document.getElementById('ee_name').value.trim()||ev.name;
  ev.type=document.getElementById('ee_type').value;
  ev.pri=document.getElementById('ee_pri').value;
  ev.color=document.querySelector('#ee_colPick .copt.on')?.dataset.color||ev.color;
  if(ev.type==='fixed'){ev.start=document.getElementById('ee_start').value;ev.end=document.getElementById('ee_end').value;ev.repeat=[...document.querySelectorAll('#ee_dayPick .dchip.on')].map(d=>+d.dataset.day);}
  else if(ev.type==='flex'){ev.eStart=document.getElementById('ee_estart').value;ev.lEnd=document.getElementById('ee_lend').value;ev.dur=+document.getElementById('ee_dur').value;ev.repeat=[...document.querySelectorAll('#ee_dayPick .dchip.on')].map(d=>+d.dataset.day);}
  else if(ev.type==='once'){ev.onceDate=document.getElementById('ee_once_date').value;ev.start=document.getElementById('ee_once_s').value;ev.end=document.getElementById('ee_once_e').value;ev.repeat=[];}
  DB.set(DB.K.EVENTS,events);closeEvEdit();renderEvents();showToast('âœ… ÄÃ£ lÆ°u!');
}

function deleteEvEdit(){
  if(!confirm('XÃ³a?'))return;
  saveUndo('XÃ³a sá»± kiá»‡n');
  events=events.filter(e=>e.id!==evEditId);DB.set(DB.K.EVENTS,events);closeEvEdit();renderEvents();
}
function closeEvEdit(){document.getElementById('evEditModal').classList.remove('open');evEditId=null;}

function renderEvents(){
  const cnt=document.getElementById('evCount');if(cnt)cnt.textContent=events.length;
  const el=document.getElementById('evList');
  if(!events.length){el.innerHTML='<p style="color:var(--txt2);text-align:center;padding:16px">ChÆ°a cÃ³ sá»± kiá»‡n.</p>';return;}
  el.innerHTML=events.map(e=>{
    const typeLabel=e.type==='once'?`<span class="ev-once-badge">ğŸ“ Äá»™t xuáº¥t ${e.onceDate||''}</span>`
      :e.type==='flex'?'ğŸ”€':'ğŸ“Œ';
    const timeStr=e.type==='fixed'||e.type==='once'?(e.start+'â€“'+e.end):(e.eStart+'â†’'+e.lEnd);
    return `<div class="li">
      <div class="dot" style="background:${e.color||'#9ca3af'}"></div>
      <div class="n">${e.name} ${typeLabel}<br>
        <span style="font-size:.65rem;color:var(--txt2)">${timeStr}${e.repeat?.length?' Â· '+(e.repeat.map(d=>DAY_VI[d]).join(',')):''}
        </span></div>
      <button class="btn bgh sm" onclick="openEvEdit(${e.id})">âœï¸</button>
      <button class="btn br sm" onclick="delEvent(${e.id})">âœ•</button>
    </div>`;
  }).join('');
}

/* â•â•â•â• SEC-JS-7 Â· Tasks CRUD â•â•â•â• */
function addTask(){
  const name=document.getElementById('tk_n').value.trim();if(!name){alert('Nháº­p tÃªn!');return;}
  const{subject,color}=classifyTask(name,selSubj||'');
  const method=document.getElementById('tk_method').value;
  const t={
    id:Date.now(),name,dur:+document.getElementById('tk_d').value||60,
    pri:selPri,diff:selDiff,
    dateFrom:document.getElementById('tk_dfrom').value,
    dateTo:document.getElementById('tk_dto').value,
    pref:document.getElementById('tk_pref').value,
    method,note:document.getElementById('tk_note').value.trim(),
    subject:selSubj||subject,color,subjectOverride:selSubj||'',done:false
  };
  saveUndo('ThÃªm task');
  tasks.push(t);DB.set(DB.K.TASKS,tasks);renderTasks();
  document.getElementById('tk_n').value='';document.getElementById('tk_note').value='';
  document.getElementById('subjectAutoLabel').textContent='';
  selSubj='';selectSubject('');selectPri('med');selectDiff('med');
  showToast('âœ… Nháº¥n âš¡ Xáº¿p lá»‹ch Ä‘á»ƒ cáº­p nháº­t.');
}
function toggleTask(id){const t=tasks.find(t=>t.id===id);if(t){t.done=!t.done;DB.set(DB.K.TASKS,tasks);renderTasks();}}
function delTask(id){if(!confirm('XÃ³a?'))return;saveUndo('XÃ³a task');tasks=tasks.filter(t=>t.id!==id);DB.set(DB.K.TASKS,tasks);renderTasks();}
function clearDone(){saveUndo('XÃ³a xong');tasks=tasks.filter(t=>!t.done);DB.set(DB.K.TASKS,tasks);renderTasks();showToast('ğŸ—‘ï¸ XÃ³a xong!');}

function renderTasks(){
  const cnt=document.getElementById('tkCount');if(cnt)cnt.textContent=tasks.length;
  const el=document.getElementById('tkList');
  if(!tasks.length){el.innerHTML='<p style="color:var(--txt2);text-align:center;padding:16px">ChÆ°a cÃ³ cÃ´ng viá»‡c.</p>';return;}
  const pMap={high:'bh',med:'bm',low:'bl'},pLbl={high:'ğŸ”´ Cao',med:'ğŸŸ¡ TB',low:'ğŸŸ¢ Tháº¥p'};
  const dLbl={hard:'ğŸ”´ KhÃ³',med:'ğŸŸ¡ TB',easy:'ğŸŸ¢ Dá»…'};
  const mLbl={normal:'ğŸ“–',pomodoro:'ğŸ…',spaced:'ğŸ“…'};
  el.innerHTML=tasks.map(t=>{
    const{emoji=''}=classifyTask(t.name,t.subjectOverride||'');
    const dateRange=(t.dateFrom||t.dateTo)?`ğŸ“… ${t.dateFrom||'âˆ'} â†’ ${t.dateTo||'âˆ'}`:'';
    const daysLeft=t.dateTo?Math.ceil((new Date(t.dateTo)-new Date(todayStr()))/86400000):null;
    const urgency=daysLeft!==null&&daysLeft<=3?`<span class="badge bh">âš ï¸ ${daysLeft<=0?'Háº¿t háº¡n!':daysLeft+'ngÃ y'}</span>`:'';
    return `<div class="li" style="${t.done?'opacity:.45':''}">
      <input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" style="width:13px;height:13px;accent-color:var(--pri);flex-shrink:0"/>
      <div class="n" style="${t.done?'text-decoration:line-through':''}">
        <span style="font-size:.79rem">${emoji} ${t.name} ${mLbl[t.method||'normal']||''}</span><br>
        <span style="font-size:.63rem;color:var(--txt2)">${t.subject||''} Â· ${dLbl[t.diff||'med']} ${dateRange?'Â· '+dateRange:''}</span>
      </div>
      ${urgency}<span class="badge ${pMap[t.pri]}">${pLbl[t.pri]}</span>
      <span style="font-size:.67rem;color:var(--txt2)">â±${t.dur}p</span>
      <button class="btn bgh sm" onclick="openEditTask(${t.id})">âœï¸</button>
      <button class="btn br sm" onclick="delTask(${t.id})">âœ•</button>
    </div>`;
  }).join('');
}

/* â•â•â•â• SEC-JS-8 Â· Edit Modal â•â•â•â• */
function openEditSlot(ds,idx){
  const s=schedule[ds]?.[idx];if(!s)return;
  editCtx={mode:'slot',ds,idx};
  _fillModal(s.kind==='task'?'âœï¸ Sá»­a task':'âœï¸ Sá»­a sá»± kiá»‡n',
    s.name,m2t(s.start),m2t(s.end),s.pri||'med',s.end-s.start,s.dateFrom||'',s.dateTo||'',s.note||'');
}
function openEditTask(tid){
  const t=tasks.find(t=>t.id===tid);if(!t)return;
  editCtx={mode:'task',taskId:tid};
  _fillModal('âœï¸ Sá»­a cÃ´ng viá»‡c',t.name,'08:00','09:00',t.pri,t.dur,t.dateFrom||'',t.dateTo||'',t.note||'');
}
function openEditNew(){
  if(!tlDate){showToast('âš ï¸ Chá»n ngÃ y trÆ°á»›c!');return;}
  editCtx={mode:'new',ds:tlDate};
  _fillModal('â• ThÃªm vÃ o ngÃ y','','08:00','09:00','med',60,'','','');
}
function _fillModal(title,name,start,end,pri,dur,dfrom,dto,note){
  document.getElementById('editTitle').textContent=title;
  document.getElementById('e_name').value=name;
  document.getElementById('e_start').value=start;
  document.getElementById('e_end').value=end;
  document.getElementById('e_pri').value=pri;
  document.getElementById('e_dur').value=dur;
  document.getElementById('e_dfrom').value=dfrom;
  document.getElementById('e_dto').value=dto;
  document.getElementById('e_note').value=note;
  document.getElementById('editModal').classList.add('open');
}
function saveEdit(){
  if(!editCtx)return;
  const{mode,ds,idx,taskId}=editCtx;
  if(mode==='task'){
    const t=tasks.find(t=>t.id===taskId);if(!t)return;
    saveUndo('Sá»­a task');
    t.name=document.getElementById('e_name').value.trim()||t.name;
    t.pri=document.getElementById('e_pri').value;
    t.dur=+document.getElementById('e_dur').value||t.dur;
    t.dateFrom=document.getElementById('e_dfrom').value;t.dateTo=document.getElementById('e_dto').value;
    t.note=document.getElementById('e_note').value.trim();
    const{color,subject}=classifyTask(t.name);t.color=color;t.subject=subject;
    DB.set(DB.K.TASKS,tasks);closeEdit();renderTasks();showToast('âœ… ÄÃ£ lÆ°u!');return;
  }
  const ns=t2m(document.getElementById('e_start').value),ne=t2m(document.getElementById('e_end').value);
  if(ne<=ns){alert('Giá» káº¿t thÃºc pháº£i sau báº¯t Ä‘áº§u!');return;}
  saveUndo('Sá»­a slot');
  const priVal=document.getElementById('e_pri').value;
  const u={name:document.getElementById('e_name').value.trim()||'Task',start:ns,end:ne,
    pri:priVal,dateFrom:document.getElementById('e_dfrom').value,dateTo:document.getElementById('e_dto').value,
    note:document.getElementById('e_note').value.trim(),
    color:{high:'#ef4444',med:'#f59e0b',low:'#10b981'}[priVal]||'#7c3aed'};
  if(!schedule[ds])schedule[ds]=[];
  if(mode==='new')schedule[ds].push({...u,kind:'task',done:false,locked:false});
  else schedule[ds][idx]={...schedule[ds][idx],...u};
  schedule[ds].sort((a,b)=>a.start-b.start);DB.set(DB.K.SCHED,schedule);
  closeEdit();renderTimeline(ds,dsToDate(ds));renderCalendar();showToast('âœ… ÄÃ£ lÆ°u!');
}
function deleteEditTarget(){
  if(!editCtx)return;
  const{mode,ds,idx,taskId}=editCtx;
  if(mode==='task'){if(!confirm('XÃ³a?'))return;saveUndo('XÃ³a task');tasks=tasks.filter(t=>t.id!==taskId);DB.set(DB.K.TASKS,tasks);closeEdit();renderTasks();showToast('ğŸ—‘ï¸ ÄÃ£ xÃ³a!');return;}
  if(!confirm('XÃ³a slot?'))return;saveUndo('XÃ³a slot');schedule[ds].splice(idx,1);DB.set(DB.K.SCHED,schedule);
  closeEdit();renderTimeline(ds,dsToDate(ds));renderCalendar();showToast('ğŸ—‘ï¸ ÄÃ£ xÃ³a!');
}
function closeEdit(){document.getElementById('editModal').classList.remove('open');editCtx=null;}

/* â•â•â•â• SEC-JS-9 Â· Fake AI Engine â•â•â•â• */
const TIPS=[
  'ğŸ… <b>Pomodoro:</b> 25p há»c, 5p nghá»‰ â€“ nÃ£o cáº§n chu ká»³!',
  'ğŸ§  <b>Active Recall:</b> Tá»± Ä‘áº·t cÃ¢u há»i rá»“i tráº£ lá»i â€“ nhá»› lÃ¢u hÆ¡n 70%.',
  'ğŸ“… <b>Spaced Repetition:</b> Ã”n sau 1 ngÃ y â†’ 3 ngÃ y â†’ 1 tuáº§n â†’ 1 thÃ¡ng.',
  'âœï¸ <b>Feynman:</b> Giáº£i thÃ­ch nhÆ° Ä‘ang dáº¡y ngÆ°á»i khÃ¡c.',
  'ğŸŒ™ <b>Ngá»§ Ä‘á»§ 7-8h:</b> NÃ£o cá»§ng cá»‘ kÃ½ á»©c khi ngá»§!',
  'ğŸ”„ <b>Interleaving:</b> Xen káº½ ToÃ¡n â†’ VÄƒn â†’ Anh thay vÃ¬ há»c 1 mÃ´n 3 tiáº¿ng liÃªn tá»¥c.',
];

function deadlineAlert(){
  const urgent=tasks.filter(t=>{if(t.done||!t.dateTo)return false;return Math.ceil((new Date(t.dateTo)-new Date(todayStr()))/86400000)<=3;}).sort((a,b)=>a.dateTo.localeCompare(b.dateTo));
  if(!urgent.length)return null;
  return 'âš ï¸ <b>Deadline sáº¯p tá»›i:</b><br>'+urgent.map(t=>{const d=Math.ceil((new Date(t.dateTo)-new Date(todayStr()))/86400000);return `â€¢ <b>${t.name}</b> â€“ ${d<=0?'<span style="color:var(--red)">Háº¾T Háº N!</span>':`cÃ²n ${d} ngÃ y`}`;}).join('<br>');
}

function weeklyFeedback(){
  const mon=getMonday(0);const subMins={};let totMin=0,totDone=0,totTasks=0;
  for(let d=0;d<7;d++){const date=new Date(mon);date.setDate(mon.getDate()+d);const ds=dateToStr(date);
    (schedule[ds]||[]).filter(s=>s.kind==='task').forEach(s=>{const sub=s.tag||'KhÃ¡c';subMins[sub]=(subMins[sub]||0)+(s.end-s.start);totMin+=s.end-s.start;if(s.done)totDone++;totTasks++;});}
  const pct=totTasks?Math.round(totDone/totTasks*100):0;
  let fb=`ğŸ“Š <b>Nháº­n xÃ©t tuáº§n:</b><br>â€¢ Tá»•ng: <b>${Math.round(totMin/60*10)/10}h</b> Â· HoÃ n thÃ nh: <b>${pct}%</b><br><br>`;
  const sorted=Object.entries(subMins).sort((a,b)=>b[1]-a[1]);
  if(sorted.length){fb+=`ğŸ“š <b>PhÃ¢n bá»•:</b><br>`;sorted.forEach(([s,m])=>{fb+=`â€¢ ${s}: ${Math.round(m/60*10)/10}h<br>`;});fb+='<br>';}
  const sug=[];
  ['ToÃ¡n','Váº­t LÃ½','HÃ³a Há»c'].forEach(s=>{if((subMins[s]||0)<60)sug.push(`ğŸ“ˆ <b>${s}</b> chÆ°a Ä‘á»§ 1h/tuáº§n`);});
  if(pct<60)sug.push('âš ï¸ HoÃ n thÃ nh tháº¥p â€“ giáº£m sá»‘ task hoáº·c tÄƒng thá»i gian');
  if(totMin<5*60)sug.push('â° Há»c Ã­t quÃ¡ â€“ cá»‘ gáº¯ng â‰¥5h/tuáº§n');
  fb+=sug.length?'ğŸ’¡ <b>Gá»£i Ã½:</b><br>'+sug.join('<br>'):'âœ… Tuáº§n há»c tá»‘t!';
  return fb;
}

function findEventsOnDate(ds,keyword){
  const slots=schedule[ds]||[];
  if(!keyword)return slots.filter(s=>s.kind!=='buffer');
  const kl=keyword.toLowerCase();
  return slots.filter(s=>s.name.toLowerCase().includes(kl)||(s.tag||'').toLowerCase().includes(kl));
}
function removeSlotsFromDate(ds,keyword){
  if(!schedule[ds])return 0;
  const before=schedule[ds].length;
  const kl=(keyword||'').toLowerCase();
  if(keyword)schedule[ds]=schedule[ds].filter(s=>!s.name.toLowerCase().includes(kl)&&!(s.tag||'').toLowerCase().includes(kl));
  DB.set(DB.K.SCHED,schedule);return before-(schedule[ds]||[]).length;
}
function addSlotToDate(ds,name,startM,endM,color){
  if(!schedule[ds])schedule[ds]=[];
  schedule[ds].push({name,start:startM,end:endM,kind:'task',pri:'med',diff:'med',color:color||'#7c3aed',done:false,locked:false,tag:'',note:''});
  schedule[ds].sort((a,b)=>a.start-b.start);DB.set(DB.K.SCHED,schedule);
}

function fakeAIRespond(text){
  const tl=text.toLowerCase().trim();

  // Stateful replies
  if(aiCtx.waitingFor==='add_after_remove'){
    if(/cÃ³|thÃªm|Ä‘Æ°á»£c|ok|á»«/.test(tl)){aiCtx.waitingFor='add_replacement_detail';return `Báº¡n muá»‘n thÃªm gÃ¬ vÃ o ${aiCtx.tempData.ds}? (vd: "Äi ngoáº¡i khoÃ¡ tá»« 8h Ä‘áº¿n 16h")`;}
    else{
      aiCtx.waitingFor=null;const{ds}=aiCtx.tempData;aiCtx.tempData={};
      runScheduler();renderAll();return `âœ… ÄÃ£ xÃ³a vÃ  sáº¯p láº¡i lá»‹ch ngÃ y <b>${ds}</b>.`;
    }
  }
  if(aiCtx.waitingFor==='add_replacement_detail'){
    const ds=aiCtx.tempData.ds;aiCtx.waitingFor=null;aiCtx.tempData={};
    const tm=[...text.matchAll(/(\d{1,2})\s*[h:]\s*(\d{0,2})/gi)];
    let startM=null,endM=null;
    if(tm.length>=2){startM=+tm[0][1]*60+(+tm[0][2]||0);endM=+tm[1][1]*60+(+tm[1][2]||0);}
    else if(tm.length===1){startM=+tm[0][1]*60+(+tm[0][2]||0);endM=startM+60;}
    let evName=text.replace(/tá»«\s+\d+[h:]\d*\s+Ä‘áº¿n\s+\d+[h:]\d*/gi,'').replace(/\d+[h:]\d*/gi,'').replace(/Ä‘áº¿n|tá»«|lÃºc/gi,'').trim()||'Sá»± kiá»‡n má»›i';
    if(startM!==null){
      showAiConfirm(`â• ThÃªm "<b>${evName}</b>" ${m2t(startM)}â€“${m2t(endM||startM+60)} vÃ o ${ds}`,()=>{
        saveUndo('AI thÃªm sá»± kiá»‡n');addSlotToDate(ds,evName,startM,endM||startM+60);runScheduler();renderAll();
        addMsg('a',`âœ… ÄÃ£ thÃªm "<b>${evName}</b>"!`);});return null;
    }
    return `KhÃ´ng xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c giá». Thá»­: "${evName} tá»« 8h Ä‘áº¿n 16h"`;
  }

  // Cancel/remove event on date
  const skipPattern=/(ngÃ y mai|mai\b|hÃ´m nay|thá»©\s+\w+).*(khÃ´ng|nghá»‰|báº­n|há»§y|huá»·)/i.test(tl)||
                    /(khÃ´ng|nghá»‰|báº­n|há»§y|huá»·).*(ngÃ y mai|mai\b|hÃ´m nay|thá»©\s+\w+)/i.test(tl);
  if(skipPattern){
    const ds=parseNatDate(text)||todayStr();
    let kw='';
    if(/(há»c|trÆ°á»ng|lá»›p)/.test(tl))kw='há»c';
    else if(/toÃ¡n/.test(tl))kw='toÃ¡n';
    else if(/thá»ƒ dá»¥c/.test(tl))kw='thá»ƒ dá»¥c';
    const matched=findEventsOnDate(ds,kw);
    if(!matched.length)return `ğŸ“… NgÃ y <b>${ds}</b> khÃ´ng cÃ³ lá»‹ch${kw?' '+kw:''}. Cáº§n thÃªm gÃ¬ khÃ´ng?`;
    const names=matched.map(s=>s.name).join(', ');
    const hasRep=/(ngoáº¡i khoÃ¡|ngoáº¡i khÃ³a|thay|Ä‘i|há»p|dÃ£ ngoáº¡i)/.test(tl);
    if(hasRep){
      const tm=[...text.matchAll(/(\d{1,2})\s*[h:]\s*(\d{0,2})/gi)];
      let startM=null,endM=null;
      if(tm.length>=2){startM=+tm[0][1]*60+(+tm[0][2]||0);endM=+tm[1][1]*60+(+tm[1][2]||0);}
      let newName=text.replace(/ngÃ y mai|hÃ´m nay|mai\b|khÃ´ng Ä‘i há»c|thá»©\s+\w+/gi,'').replace(/tá»«\s+\d+[h:]\d*\s+Ä‘áº¿n\s+\d+[h:]\d*/gi,'').replace(/\d+[h:]\d*/gi,'').replace(/Ä‘áº¿n|tá»«|lÃºc|thay báº±ng|mÃ |tÃ´i|khÃ´ng Ä‘i há»c/gi,'').trim()||'Sá»± kiá»‡n má»›i';
      if(startM!==null){
        showAiConfirm(`ğŸ—‘ï¸ XÃ³a: <b>${names}</b><br>â• ThÃªm: <b>${newName}</b> ${m2t(startM)}â€“${m2t(endM||startM+60)}<br>âš¡ Xáº¿p láº¡i`,()=>{
          saveUndo('AI thay tháº¿');removeSlotsFromDate(ds,kw);addSlotToDate(ds,newName,startM,endM||startM+60);runScheduler();renderAll();
          addMsg('a',`âœ… ÄÃ£ thay "<b>${names}</b>" báº±ng "<b>${newName}</b>"!`);});return null;
      }
      showAiConfirm(`ğŸ—‘ï¸ XÃ³a: <b>${names}</b> khá»i ${ds}<br>âš¡ Xáº¿p láº¡i`,()=>{
        saveUndo('AI xÃ³a');removeSlotsFromDate(ds,kw);runScheduler();renderAll();
        aiCtx.waitingFor='add_replacement_detail';aiCtx.tempData={ds};
        addMsg('a',`âœ… ÄÃ£ xÃ³a. Báº¡n muá»‘n thÃªm gÃ¬ thay tháº¿? (vd: "Ngoáº¡i khoÃ¡ tá»« 8h Ä‘áº¿n 16h")`);});return null;
    }
    showAiConfirm(`ğŸ—‘ï¸ XÃ³a: <b>${names}</b> khá»i <b>${ds}</b><br>âš¡ Xáº¿p láº¡i lá»‹ch`,()=>{
      saveUndo('AI xÃ³a');const rm=matched.map(s=>s.name).join(', ');removeSlotsFromDate(ds,kw);runScheduler();renderAll();
      aiCtx.waitingFor='add_after_remove';aiCtx.tempData={ds,removedName:rm};
      addMsg('a',`âœ… ÄÃ£ xÃ³a "<b>${rm}</b>" ngÃ y ${ds}.<br>Báº¡n cÃ³ muá»‘n thÃªm lá»‹ch thay tháº¿ khÃ´ng?`);});return null;
  }

  // Move task
  const moveM=/(chuyá»ƒn|dá»i|Ä‘á»•i)\s+(.+?)\s+(?:sang|qua|tá»›i|Ä‘áº¿n)\s+(.+)/i.exec(text);
  if(moveM){
    const kw=moveM[2].trim(),targetDs=parseNatDate(moveM[3]);
    if(!targetDs)return `KhÃ´ng hiá»ƒu ngÃ y Ä‘áº¿n. Thá»­: "Chuyá»ƒn bÃ i ToÃ¡n sang thá»© 5"`;
    let foundDs=null,foundIdx=null;
    for(const[ds,slots]of Object.entries(schedule)){const i=slots.findIndex(s=>s.name.toLowerCase().includes(kw.toLowerCase()));if(i!==-1){foundDs=ds;foundIdx=i;break;}}
    if(!foundDs){const t=tasks.find(t=>t.name.toLowerCase().includes(kw.toLowerCase()));
      if(t){showAiConfirm(`ğŸ“… Chuyá»ƒn "<b>${t.name}</b>" â†’ <b>${targetDs}</b>`,()=>{saveUndo('AI chuyá»ƒn');t.dateFrom=targetDs;t.dateTo=targetDs;DB.set(DB.K.TASKS,tasks);runScheduler();renderAll();addMsg('a',`âœ… ÄÃ£ chuyá»ƒn!`);});return null;}
      return `KhÃ´ng tÃ¬m tháº¥y task "<b>${kw}</b>".`;}
    const sl=schedule[foundDs][foundIdx];
    showAiConfirm(`ğŸ“… Di chuyá»ƒn "<b>${sl.name}</b>" ${foundDs} â†’ <b>${targetDs}</b>`,()=>{
      saveUndo('AI di chuyá»ƒn');const mv={...sl};schedule[foundDs].splice(foundIdx,1);
      if(!schedule[targetDs])schedule[targetDs]=[];schedule[targetDs].push(mv);schedule[targetDs].sort((a,b)=>a.start-b.start);
      DB.set(DB.K.SCHED,schedule);renderAll();addMsg('a',`âœ… ÄÃ£ chuyá»ƒn!`);});return null;
  }

  // Add task via chat
  if(/(thÃªm|táº¡o|lÃªn lá»‹ch)/.test(tl)){
    const durM=text.match(/(\d+)\s*(phÃºt|p\b)/i),durH=text.match(/(\d+)\s*tiáº¿ng/i);
    const dur=durM?+durM[1]:durH?+durH[1]*60:60;
    const nm=text.replace(/^.*(thÃªm|táº¡o|lÃªn lá»‹ch)\s*/i,'').replace(/\s*\d+\s*(phÃºt|p\b|tiáº¿ng).*/i,'').trim();
    if(nm.length>2){
      const{color,subject}=classifyTask(nm);
      showAiConfirm(`â• ThÃªm task: <b>${nm}</b> (${dur}p) Â· ${subject}`,()=>{
        saveUndo('AI thÃªm');tasks.push({id:Date.now(),name:nm,dur,pri:'med',diff:'med',dateFrom:todayStr(),dateTo:offStr(7),pref:'auto',method:'normal',subject,color,subjectOverride:'',done:false,note:''});
        DB.set(DB.K.TASKS,tasks);renderTasks();runScheduler();addMsg('a',`âœ… ÄÃ£ thÃªm "<b>${nm}</b>"!`);});return null;
    }
  }

  // View schedule
  if(/(hÃ´m nay|ngÃ y mai|lá»‹ch|cÃ³ gÃ¬|cáº§n lÃ m)/.test(tl)){
    const ds=/ngÃ y mai|mai\b/.test(tl)?offStr(1):todayStr();const dt=dsToDate(ds);
    const slots=(schedule[ds]||[]).filter(e=>e.kind!=='buffer');
    const ts=slots.filter(s=>s.kind==='task');const done=ts.filter(t=>t.done).length;const mins=ts.reduce((s,t)=>s+(t.end-t.start),0);
    const lbl=ds===todayStr()?'HÃ´m nay':'NgÃ y mai';
    if(!slots.length)return `ğŸ“… <b>${lbl}</b> chÆ°a cÃ³ lá»‹ch. Nháº¥n âš¡ Xáº¿p lá»‹ch!`;
    return `ğŸ“… <b>${lbl} (${DAY_FULL[dt.getDay()]})</b> â€“ ${done}/${ts.length}âœ… Â· ${Math.round(mins/60*10)/10}h<br><br>`+slots.map(s=>`â€¢ ${m2t(s.start)}â€“${m2t(s.end)}: ${s.name}${s.done?' âœ…':''}`).join('<br>');
  }
  if(/(deadline|háº¡n|sáº¯p thi)/.test(tl))return deadlineAlert()||'âœ… KhÃ´ng cÃ³ deadline sáº¯p tá»›i!';
  if(/(nháº­n xÃ©t|feedback|tuáº§n|hiá»‡u suáº¥t)/.test(tl))return weeklyFeedback();
  if(/(lá»i khuyÃªn|máº¹o|há»c tá»‘t|pomodoro|spaced)/.test(tl))return `ğŸ’¡ ${TIPS[Math.floor(Math.random()*TIPS.length)]}`;
  if(/(khÃ³|Æ°u tiÃªn|mÃ´n khÃ³)/.test(tl)){
    const hard=tasks.filter(t=>!t.done&&(t.diff||'med')==='hard');
    if(!hard.length)return 'ğŸ’¡ ChÆ°a cÃ³ task nÃ o khÃ³.';
    return `ğŸ¯ <b>MÃ´n cáº§n Æ°u tiÃªn:</b><br>`+hard.map(t=>`â€¢ ğŸ”´ <b>${t.name}</b> (${t.dur}p)`).join('<br>');
  }
  if(/(má»‡t|giáº£m|quÃ¡ táº£i)/.test(tl)){let c=0;tasks.forEach(t=>{if(t.pri==='high'&&!t.done){t.pri='med';c++;}});DB.set(DB.K.TASKS,tasks);renderTasks();return `ğŸ˜Œ ÄÃ£ giáº£m Æ°u tiÃªn ${c} task.`;}
  if(/(báº¡n lÃ  ai|em lÃ  ai)/.test(tl))return 'ğŸ“š MÃ¬nh lÃ  <b>Smart Student Planner AI v12.1</b>.';
  const al=deadlineAlert();
  return al?al+'<br><br>ğŸ’¬ Thá»­: "Lá»‹ch hÃ´m nay", "Mai khÃ´ng Ä‘i há»c", "Chuyá»ƒn bÃ i ToÃ¡n sang thá»© 5"â€¦'
    :'ğŸ¤– Thá»­: "Lá»‹ch hÃ´m nay?", "Mai tÃ´i khÃ´ng Ä‘i há»c", "ThÃªm bÃ i ToÃ¡n 60 phÃºt", "Nháº­n xÃ©t tuáº§n nÃ y"';
}

function showAiConfirm(html,onConfirm){
  aiPendingAction=onConfirm;
  document.getElementById('aiConfirmBody').innerHTML=html;
  document.getElementById('aiConfirmBox').classList.add('open');
}
function confirmAiChange(){document.getElementById('aiConfirmBox').classList.remove('open');if(aiPendingAction)aiPendingAction();aiPendingAction=null;}
function rejectAiChange(){document.getElementById('aiConfirmBox').classList.remove('open');aiPendingAction=null;addMsg('a','â†© ÄÃ£ huá»·.');aiCtx.waitingFor=null;aiCtx.tempData={};}

/* â•â•â•â• SEC-JS-10 Â· Gemini AI â•â•â•â• */
const GEMINI_URL='https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=';
let GEMINI_URL_ACTIVE=GEMINI_URL;

async function callGemini(userMsg,key){
  if(!key)return{ok:false,text:'ChÆ°a cÃ³ API key.'};
  const ds=todayStr(),dt=dsToDate(ds);
  const ctx=`Báº¡n lÃ  trá»£ lÃ½ lá»‹ch há»c. HÃ´m nay ${DAY_FULL[dt.getDay()]} ${ds}. CÃ´ng viá»‡c: ${tasks.filter(t=>!t.done).slice(0,5).map(t=>t.name).join(', ')||'khÃ´ng cÃ³'}. Tráº£ lá»i tiáº¿ng Viá»‡t, ngáº¯n gá»n.`;
  try{
    const res=await fetch(GEMINI_URL_ACTIVE+key,{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({contents:[{role:'user',parts:[{text:ctx+'\n\n'+userMsg}]}],generationConfig:{temperature:0.7,maxOutputTokens:512}})});
    const data=await res.json();
    if(!res.ok)return{ok:false,text:`[${data.error?.code||res.status}] ${data.error?.message||'Lá»—i'}`};
    const c=data.candidates?.[0];
    if(!c)return{ok:false,text:'KhÃ´ng cÃ³ káº¿t quáº£.'};
    return{ok:true,text:c.content?.parts?.[0]?.text||'(Trá»‘ng)'};
  }catch(e){return{ok:false,text:`Lá»—i: ${e.message}`};}
}
async function validateGeminiKey(key){
  const r=await callGemini('Hi',key);if(r.ok)return r;
  const betaUrl='https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=';
  try{const res=await fetch(betaUrl+key,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:'user',parts:[{text:'Hi'}]}],generationConfig:{maxOutputTokens:10}})});
    const data=await res.json();if(res.ok){GEMINI_URL_ACTIVE=betaUrl;return{ok:true,text:'ok'};}
    return{ok:false,text:`${r.text} | ${data.error?.message||res.status}`};}
  catch(e){return{ok:false,text:e.message};}
}
async function saveAiSetup(){
  if(pendingAiMode==='fake'){applyAiModeSave('fake');closeAiSetup();return;}
  const key=(document.getElementById('geminiKeyInput')?.value||'').trim();
  const rEl=document.getElementById('setupTestResult');
  if(!key){if(rEl)rEl.innerHTML='<span style="color:#f87171">âš ï¸ Nháº­p key!</span>';return;}
  if(rEl)rEl.innerHTML='<span style="color:#a78bfa">â³ Kiá»ƒm traâ€¦</span>';
  const r=await validateGeminiKey(key);
  if(!r.ok){if(rEl)rEl.innerHTML=`<span style="color:#f87171">âŒ ${r.text}</span>`;showToast('âŒ Key khÃ´ng há»£p lá»‡!');return;}
  DB.set(DB.K.APIKEY,key);if(rEl)rEl.innerHTML='<span style="color:#34d399">âœ… OK!</span>';
  applyAiModeSave('gemini');setTimeout(closeAiSetup,900);
}
async function setupSaveGemini(){
  const key=document.getElementById('setup_apikey')?.value.trim()||'';
  const rEl=document.getElementById('setupTestResult2');
  if(!key){if(rEl)rEl.innerHTML='<span style="color:var(--red)">âš ï¸ Nháº­p key!</span>';return;}
  if(rEl)rEl.innerHTML='<span style="color:var(--yel)">â³â€¦</span>';
  const r=await validateGeminiKey(key);
  if(!r.ok){if(rEl)rEl.innerHTML=`<span style="color:var(--red)">âŒ ${r.text}</span>`;return;}
  DB.set(DB.K.APIKEY,key);applyAiModeSave('gemini');
  if(rEl)rEl.innerHTML='<span style="color:var(--grn)">âœ… ÄÃ£ kÃ­ch hoáº¡t!</span>';showToast('âœ… Gemini AI!');
}
function applyAiModeSave(mode){
  const m=mode||pendingAiMode;cfg.aiMode=m;DB.set(DB.K.CFG,cfg);cfg=getCfg();updateAIModeUI();
}

/* â•â•â•â• SEC-JS-11 Â· Chat UI â•â•â•â• */
function quickSend(el){document.getElementById('chatIn').value=el.textContent;sendChat();}
async function sendChat(){
  const inp=document.getElementById('chatIn'),text=inp.value.trim();if(!text)return;
  inp.value='';addMsg('u',text);
  const hist=DB.get(DB.K.CHAT,[]);hist.push({role:'user',content:text,ts:Date.now()});DB.set(DB.K.CHAT,hist);
  const sendBtn=document.getElementById('btnSend');sendBtn.disabled=true;
  const key=DB.get(DB.K.APIKEY,'')||'';
  const isGemini=cfg.aiMode==='gemini'&&!!key;
  if(isGemini){
    const bubble=addMsg('a','<span class="dots"><span></span><span></span><span></span></span>');
    const r=await callGemini(text,key);
    bubble.innerHTML=r.ok?renderAIText(r.text):`âŒ ${r.text}`;
    const all=DB.get(DB.K.CHAT,[]);all.push({role:'assistant',content:bubble.textContent,ts:Date.now()});DB.set(DB.K.CHAT,all);
  } else {
    const reply=fakeAIRespond(text);
    if(reply!==null){addMsg('a',reply);const all=DB.get(DB.K.CHAT,[]);all.push({role:'assistant',content:reply,ts:Date.now()});DB.set(DB.K.CHAT,all);}
  }
  sendBtn.disabled=false;
}
function renderAIText(t){return t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\*(.*?)\*/g,'<i>$1</i>').replace(/`(.*?)`/g,'<code style="background:var(--surf3);padding:0 3px;border-radius:4px">$1</code>').replace(/\n/g,'<br>');}
function addMsg(role,html){const box=document.getElementById('chatBox');const div=document.createElement('div');div.className='msg '+role;div.innerHTML=html;box.appendChild(div);box.scrollTop=9999;return div;}
function clearChatHistory(){if(!confirm('XÃ³a chat?'))return;DB.set(DB.K.CHAT,[]);document.getElementById('chatBox').innerHTML='';addMsg('sys','ğŸ—‘ï¸ ÄÃ£ xÃ³a.');aiCtx={waitingFor:null,tempData:{}};}
function loadChatHistory(){DB.get(DB.K.CHAT,[]).slice(-10).forEach(m=>addMsg(m.role==='user'?'u':'a',renderAIText(m.content)));}

/* â•â•â•â• SEC-JS-12 Â· Stats â•â•â•â• */
let statDayOff=0,statWeekOff=0,statMonthOff=0,statYear=new Date().getFullYear();
function switchStatTab(tab,btn){document.querySelectorAll('.stat-tab').forEach(b=>b.classList.toggle('on',b===btn));renderStats(tab);}
function renderStats(tab){const tabs={day:renderDay,week:renderWeek,month:renderMonth,year:renderYear};document.getElementById('statsContent').innerHTML=(tabs[tab]||renderDay)();}
function getTasksForDate(ds){return(schedule[ds]||[]).filter(s=>s.kind==='task');}
function getMinsForDate(ds){return getTasksForDate(ds).reduce((s,t)=>s+(t.end-t.start),0);}
function getDoneForDate(ds){return getTasksForDate(ds).filter(t=>t.done).length;}
function getTotForDate(ds){return getTasksForDate(ds).length;}

function renderDay(){
  const dt=new Date();dt.setDate(dt.getDate()+statDayOff);const ds=dateToStr(dt);
  const slots=getTasksForDate(ds);const done=slots.filter(e=>e.done).length,tot=slots.length,mins=getMinsForDate(ds),pct=tot?Math.round(done/tot*100):0;
  const byS={};slots.forEach(s=>{const sub=s.tag||'KhÃ¡c';byS[sub]=(byS[sub]||0)+(s.end-s.start);});const mx=Math.max(...Object.values(byS),1);
  return `<div class="card"><div class="ct">ğŸ“† ${DAY_FULL[dt.getDay()]} ${ds}</div>
  <div style="display:flex;gap:5px;margin-bottom:8px">
    <button class="btn bgh sm" onclick="statDayOff--;renderStats('day')">â—€</button>
    <button class="btn bgh sm" onclick="statDayOff++;renderStats('day')">â–¶</button>
    <button class="btn bp sm" onclick="statDayOff=0;renderStats('day')">HÃ´m nay</button>
  </div>
  <div class="stat-cards">
    <div class="sc"><div class="sv">${tot}</div><div class="sl">Task</div></div>
    <div class="sc"><div class="sv">${done}</div><div class="sl">âœ… Xong</div></div>
    <div class="sc"><div class="sv">${pct}%</div><div class="sl">Tá»‰ lá»‡</div></div>
    <div class="sc"><div class="sv">${Math.round(mins/60*10)/10}h</div><div class="sl">Há»c</div></div>
  </div>
  <div class="prog"><div class="prog-b" style="width:${pct}%"></div></div></div>
  <div class="card"><div class="ct">ğŸ“š PhÃ¢n bá»• mÃ´n</div>
    ${Object.entries(byS).sort((a,b)=>b[1]-a[1]).map(([s,d])=>`<div class="stat-bar-row"><div class="lbl">${s}</div><div class="bar-wrap"><div class="bar-fill" style="width:${Math.round(d/mx*100)}%;background:var(--pri)"></div></div><div class="val">${Math.round(d/60*10)/10}h</div></div>`).join('')||'<p style="color:var(--txt2);font-size:.78rem">KhÃ´ng cÃ³ dá»¯ liá»‡u.</p>'}
  </div>`;
}

function renderWeek(){
  const mon=getMonday(statWeekOff);const days=Array.from({length:7},(_,i)=>{const d=new Date(mon);d.setDate(mon.getDate()+i);return dateToStr(d);});
  const end=new Date(mon);end.setDate(mon.getDate()+6);
  const maxM=Math.max(...days.map(ds=>getMinsForDate(ds)),1);
  const totM=days.reduce((s,ds)=>s+getMinsForDate(ds),0);const totD=days.reduce((s,ds)=>s+getDoneForDate(ds),0);const totT=days.reduce((s,ds)=>s+getTotForDate(ds),0);
  const fb=statWeekOff===0?`<div class="card"><div class="ct">ğŸ¤– AI Nháº­n xÃ©t</div><div style="font-size:.82rem;line-height:1.7">${weeklyFeedback()}</div></div>`:'';
  return `<div class="card"><div class="ct">ğŸ—“ï¸ Tuáº§n ${mon.getDate()}/${mon.getMonth()+1} â€“ ${end.getDate()}/${end.getMonth()+1}</div>
  <div style="display:flex;gap:5px;margin-bottom:9px">
    <button class="btn bgh sm" onclick="statWeekOff--;renderStats('week')">â—€</button>
    <button class="btn bgh sm" onclick="statWeekOff++;renderStats('week')">â–¶</button>
    <button class="btn bp sm" onclick="statWeekOff=0;renderStats('week')">Tuáº§n nÃ y</button>
  </div>
  <div class="stat-cards">
    <div class="sc"><div class="sv">${totT}</div><div class="sl">Task</div></div>
    <div class="sc"><div class="sv">${totD}</div><div class="sl">Xong</div></div>
    <div class="sc"><div class="sv">${Math.round(totM/60)}h</div><div class="sl">Tá»•ng</div></div>
    <div class="sc"><div class="sv">${Math.round(totM/7/60*10)/10}h</div><div class="sl">TB/ngÃ y</div></div>
  </div>
  ${days.map(ds=>{const dt=dsToDate(ds),m=getMinsForDate(ds),done=getDoneForDate(ds),tot=getTotForDate(ds);return `<div class="stat-bar-row"><div class="lbl">${DAY_VI[dt.getDay()]} ${dt.getDate()}/${dt.getMonth()+1}</div><div class="bar-wrap"><div class="bar-fill" style="width:${Math.round(m/maxM*100)}%;background:${ds===todayStr()?'var(--acc)':'var(--pri)'}"></div></div><div class="val">${Math.round(m/60*10)/10}h <span style="font-size:.62rem;color:var(--txt2)">${done}/${tot}</span></div></div>`;}).join('')}
  </div>${fb}`;
}

function renderMonth(){
  const now=new Date(new Date().getFullYear(),new Date().getMonth()+statMonthOff,1);const year=now.getFullYear(),month=now.getMonth();
  const dim=new Date(year,month+1,0).getDate();const allDays=Array.from({length:dim},(_,i)=>dateToStr(new Date(year,month,i+1)));
  const tMin=allDays.reduce((s,ds)=>s+getMinsForDate(ds),0),tDone=allDays.reduce((s,ds)=>s+getDoneForDate(ds),0),tTot=allDays.reduce((s,ds)=>s+getTotForDate(ds),0);
  return `<div class="card"><div class="ct">ğŸ“… ${MON_VI[month]} ${year}</div>
  <div style="display:flex;gap:5px;margin-bottom:9px">
    <button class="btn bgh sm" onclick="statMonthOff--;renderStats('month')">â—€</button>
    <button class="btn bgh sm" onclick="statMonthOff++;renderStats('month')">â–¶</button>
    <button class="btn bp sm" onclick="statMonthOff=0;renderStats('month')">ThÃ¡ng nÃ y</button>
  </div>
  <div class="stat-cards">
    <div class="sc"><div class="sv">${tTot}</div><div class="sl">Task</div></div>
    <div class="sc"><div class="sv">${tDone}</div><div class="sl">Xong</div></div>
    <div class="sc"><div class="sv">${tTot?Math.round(tDone/tTot*100):0}%</div><div class="sl">Tá»‰ lá»‡</div></div>
    <div class="sc"><div class="sv">${Math.round(tMin/60)}h</div><div class="sl">Há»c</div></div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px">
    ${['CN','T2','T3','T4','T5','T6','T7'].map(d=>`<div style="text-align:center;font-size:.58rem;font-weight:700;color:var(--txt2)">${d}</div>`).join('')}
    ${Array.from({length:new Date(year,month,1).getDay()},()=>'<div></div>').join('')}
    ${Array.from({length:dim},(_,i)=>{const ds=dateToStr(new Date(year,month,i+1));const m=getMinsForDate(ds),alpha=m>0?Math.min(0.15+m/300,1):0.05,isToday=ds===todayStr();return `<div title="${ds}" style="aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.66rem;font-weight:700;background:rgba(124,58,237,${alpha});color:${alpha>0.5?'#fff':'var(--txt)'};border:${isToday?'2px solid var(--acc)':'1.5px solid var(--brd)'}cursor:pointer" onclick="statDayOff=${Math.ceil((new Date(ds)-new Date(todayStr()))/86400000)};switchStatTab('day',document.querySelector('.stat-tab'))">${i+1}</div>`;}).join('')}
  </div></div>`;
}

function renderYear(){
  const y=statYear;const md=Array.from({length:12},(_,m)=>{const dim=new Date(y,m+1,0).getDate();const days=Array.from({length:dim},(_,i)=>dateToStr(new Date(y,m,i+1)));return{mins:days.reduce((s,ds)=>s+getMinsForDate(ds),0),done:days.reduce((s,ds)=>s+getDoneForDate(ds),0),tot:days.reduce((s,ds)=>s+getTotForDate(ds),0)};});
  const maxM=Math.max(...md.map(d=>d.mins),1),totMin=md.reduce((s,d)=>s+d.mins,0),totDone=md.reduce((s,d)=>s+d.done,0),totTot=md.reduce((s,d)=>s+d.tot,0);
  const byS={};tasks.forEach(t=>{const sub=t.subjectOverride||t.subject||'KhÃ¡c';byS[sub]=(byS[sub]||0)+t.dur;});const mxS=Math.max(...Object.values(byS),1);
  return `<div class="card"><div class="ct">ğŸ“Š NÄƒm ${y}</div>
  <div style="display:flex;gap:5px;margin-bottom:9px">
    <button class="btn bgh sm" onclick="statYear--;renderStats('year')">â—€</button>
    <button class="btn bgh sm" onclick="statYear++;renderStats('year')">â–¶</button>
    <button class="btn bp sm" onclick="statYear=new Date().getFullYear();renderStats('year')">NÄƒm nay</button>
  </div>
  <div class="stat-cards">
    <div class="sc"><div class="sv">${totTot}</div><div class="sl">Task</div></div>
    <div class="sc"><div class="sv">${totDone}</div><div class="sl">Xong</div></div>
    <div class="sc"><div class="sv">${totTot?Math.round(totDone/totTot*100):0}%</div><div class="sl">Tá»‰ lá»‡</div></div>
    <div class="sc"><div class="sv">${Math.round(totMin/60)}h</div><div class="sl">Há»c</div></div>
  </div></div>
  <div class="card"><div class="ct">ğŸ“ˆ Theo thÃ¡ng</div>
  ${md.map((d,m)=>`<div class="stat-bar-row"><div class="lbl">${MON_VI[m].replace('ThÃ¡ng ','T')}</div><div class="bar-wrap"><div class="bar-fill" style="width:${Math.round(d.mins/maxM*100)}%;background:${m===new Date().getMonth()&&y===new Date().getFullYear()?'var(--acc)':'var(--pri)'}"></div></div><div class="val">${Math.round(d.mins/60)}h</div></div>`).join('')}
  </div>
  <div class="card"><div class="ct">ğŸ“š PhÃ¢n bá»• mÃ´n</div>
  ${Object.entries(byS).sort((a,b)=>b[1]-a[1]).map(([sub,dur])=>{const f=SUBJECT_MAP.find(([,s])=>s===sub);const color=f?f[3]:'var(--pri)',emoji=f?f[4]:'ğŸ“–';return `<div class="stat-bar-row"><div class="lbl">${emoji} ${sub}</div><div class="bar-wrap"><div class="bar-fill" style="width:${Math.round(dur/mxS*100)}%;background:${color}"></div></div><div class="val">${Math.round(dur/60*10)/10}h</div></div>`;}).join('')||'<p style="color:var(--txt2);font-size:.78rem">ChÆ°a cÃ³ dá»¯ liá»‡u.</p>'}
  </div>`;
}

/* â•â•â•â• SEC-JS-13 Â· Notifications â•â•â•â• */
function requestNotif(){
  if(!('Notification' in window)){showToast('âš ï¸ KhÃ´ng há»— trá»£!');return;}
  Notification.requestPermission().then(p=>{cfg.notifGranted=p==='granted';DB.set(DB.K.CFG,cfg);document.getElementById('notifBanner').classList.remove('show');updateNotifStatus();if(p==='granted'){showToast('ğŸ”” ÄÃ£ báº­t!');scheduleNotifications();}else showToast('âš ï¸ ChÆ°a cáº¥p quyá»n.');});
}
function updateNotifStatus(){const el=document.getElementById('notifStatus');if(!el)return;const p='Notification' in window?Notification.permission:'unsupported';const map={granted:'âœ… ÄÃ£ báº­t',denied:'âŒ Bá»‹ tá»« chá»‘i',default:'âš ï¸ ChÆ°a cáº¥p quyá»n',unsupported:'âš ï¸ KhÃ´ng há»— trá»£'};el.textContent=map[p]||p;el.style.color=p==='granted'?'var(--grn)':p==='denied'?'var(--red)':'var(--yel)';}
function sendNotif(title,body){if(!('Notification' in window)||Notification.permission!=='granted')return;try{new Notification(title,{body});}catch(e){}}
function scheduleNotifications(){
  if(notifTimer)clearInterval(notifTimer);
  if(!('Notification' in window)||Notification.permission!=='granted')return;
  notifTimer=setInterval(()=>{
    const now=new Date(),hm=now.getHours()*60+now.getMinutes(),ds=todayStr();
    (schedule[ds]||[]).filter(s=>s.kind!=='buffer').forEach(s=>{const diff=s.start-hm;if(diff===15)sendNotif(`â° Sáº¯p: ${s.name}`,'CÃ²n 15 phÃºt');if(diff===0)sendNotif(`ğŸ”” Báº¯t Ä‘áº§u: ${s.name}`,`${m2t(s.start)}â€“${m2t(s.end)}`);});
    tasks.filter(t=>!t.done&&t.dateTo).forEach(t=>{const d=Math.ceil((new Date(t.dateTo)-new Date(todayStr()))/86400000);if(d<=1&&now.getHours()===8&&now.getMinutes()===0)sendNotif('ğŸš¨ Deadline!',t.name);});
  },60000);
}

/* â•â•â•â• SEC-JS-14 Â· UI Helpers Â· Setup Â· Demo Â· Init â•â•â•â• */
function buildSubjectBtns(){document.getElementById('subjBtns').innerHTML=SUBJECTS_LIST.map(s=>`<div class="subj-btn" data-s="${s}" onclick="selectSubject('${s}')">${s}</div>`).join('');}
function selectSubject(s){selSubj=s;document.querySelectorAll('.subj-btn').forEach(b=>b.classList.toggle('on',b.dataset.s===s));}
function autoDetectSubject(title){const{subject}=classifyTask(title);const lbl=document.getElementById('subjectAutoLabel');if(subject&&subject!=='KhÃ¡c'){lbl.textContent=`(nháº­n diá»‡n: ${subject})`;selectSubject(subject);}else lbl.textContent='';}
function selectPri(p){selPri=p;document.querySelectorAll('.pri-btn[data-pri]').forEach(b=>{b.className='pri-btn'+(b.dataset.pri===p?` on-${p}`:'');});}
function selectDiff(d){selDiff=d;document.querySelectorAll('.pri-btn[data-diff]').forEach(b=>{const on=b.dataset.diff===d;b.className='pri-btn'+(on?d==='hard'?' on-high':d==='easy'?' on-low':' on-med':'');});}

function buildPickers(){
  const dp=document.getElementById('dayPick');
  dp.innerHTML=['CN','T2','T3','T4','T5','T6','T7'].map((d,i)=>`<div class="dchip" data-day="${i}" onclick="this.classList.toggle('on')">${d}</div>`).join('');
  [1,2,3,4,5].forEach(i=>dp.children[i].classList.add('on'));
  const mkCol=(id,selIdx=0)=>document.getElementById(id).innerHTML=COLORS.map((c,i)=>`<div class="copt ${i===selIdx?'on':''}" style="background:${c}" data-color="${c}" onclick="document.querySelectorAll('#${id} .copt').forEach(e=>e.classList.remove('on'));this.classList.add('on')"></div>`).join('');
  mkCol('colPick',0);mkCol('colPickOnce',5);
}

function selectAiMode(mode){
  pendingAiMode=mode;
  ['fake','gemini'].forEach(m=>{const a=document.getElementById('mopt-'+m);if(a)a.classList.toggle('on',m===mode);});
  const gs=document.getElementById('geminiKeySection');if(gs)gs.style.display=mode==='gemini'?'block':'none';
  const fb=document.getElementById('fakeSaveBtn');if(fb)fb.style.display=mode==='fake'?'block':'none';
}
function syncSetupModeUI(){
  ['fake','gemini'].forEach(m=>{const el=document.getElementById('setup-mopt-'+m);if(el){el.style.borderColor=m===pendingAiMode?'var(--pri)':'var(--brd)';el.style.background=m===pendingAiMode?'var(--pri-l)':'var(--surf2)';}});
  const ss=document.getElementById('setup-gemini-section');if(ss)ss.style.display=pendingAiMode==='gemini'?'block':'none';
  const fs=document.getElementById('setup-fake-section');if(fs)fs.style.display=pendingAiMode==='fake'?'block':'none';
}
function updateAIModeUI(){
  const isG=cfg.aiMode==='gemini'&&!!DB.get(DB.K.APIKEY,'');
  const dot=document.getElementById('sDot');if(dot)dot.className='sdot '+(isG?'dot-ok':'dot-chk');
  const txt=document.getElementById('sTxt');if(txt)txt.textContent=isG?'âœ¨ Gemini':'ğŸ§  Fake AI';
  const badge=document.getElementById('modeBadge');if(badge){badge.className='mode-badge '+(isG?'mode-gemini':'mode-fake');badge.textContent=isG?'âœ¨ Gemini AI':'ğŸ§  Fake AI';}
  pendingAiMode=cfg.aiMode;selectAiMode(pendingAiMode);syncSetupModeUI();
}
function goTo(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  document.getElementById('pg-'+name).classList.add('on');btn.classList.add('on');
  if(name==='stats')renderStats('day');if(name==='setup'){syncSetupModeUI();updateNotifStatus();}
}
function toggleDark(){const dark=document.documentElement.dataset.theme==='dark';document.documentElement.dataset.theme=dark?'light':'dark';document.getElementById('btnDark').textContent=dark?'ğŸŒ™':'â˜€ï¸';cfg.darkMode=!dark;DB.set(DB.K.CFG,cfg);}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',3200);}
function cp(txt){navigator.clipboard?.writeText(txt).then(()=>showToast('âœ… Copied!')).catch(()=>{const e=document.createElement('textarea');e.value=txt;document.body.appendChild(e);e.select();document.execCommand('copy');e.remove();showToast('âœ… Copied!');});}
function saveCfg(){
  cfg.hardMorning=document.getElementById('cfg_hardMorning').checked;
  cfg.pomodoro=document.getElementById('cfg_pomodoro').checked;
  cfg.spaced=document.getElementById('cfg_spaced').checked;
  cfg.interleave=document.getElementById('cfg_interleave').checked;
  cfg.splitLong=document.getElementById('cfg_splitLong').checked;
  cfg.energyPeak=document.getElementById('cfg_energyPeak').value;
  cfg.splitThreshold=+document.getElementById('cfg_splitThreshold').value||90;
  DB.set(DB.K.CFG,cfg);showToast('âœ… ÄÃ£ lÆ°u!');
}
function openGuide(){document.getElementById('guideModal').classList.add('open');}
function closeGuide(){document.getElementById('guideModal').classList.remove('open');}
function openAiSetup(){selectAiMode(cfg.aiMode||'fake');const ki=document.getElementById('geminiKeyInput');if(ki)ki.value=DB.get(DB.K.APIKEY,'')||'';const ri=document.getElementById('setupTestResult');if(ri)ri.textContent='';document.getElementById('aiSetupModal').classList.add('open');}
function closeAiSetup(){document.getElementById('aiSetupModal').classList.remove('open');}
function renderAll(){renderCalendar();renderEvents();renderTasks();if(tlDate)renderTimeline(tlDate,dsToDate(tlDate));}

function loadDemoData(){
  if(!confirm('Táº£i demo sáº½ XÃ“A dá»¯ liá»‡u. Tiáº¿p tá»¥c?'))return;
  events=[
    {id:1,name:'ğŸ« Äi há»c',type:'fixed',start:'07:00',end:'11:30',repeat:[1,2,3,4,5],pri:'high',color:'#3b82f6'},
    {id:2,name:'ğŸš Ä‚n trÆ°a',type:'flex',eStart:'11:30',lEnd:'13:30',dur:45,repeat:[0,1,2,3,4,5,6],pri:'med',color:'#f59e0b'},
    {id:3,name:'ğŸ“– Há»c thÃªm ToÃ¡n',type:'fixed',start:'13:30',end:'15:30',repeat:[2,4],pri:'high',color:'#ef4444'},
    {id:4,name:'ğŸƒ Thá»ƒ dá»¥c',type:'flex',eStart:'17:00',lEnd:'18:30',dur:40,repeat:[1,3,5],pri:'med',color:'#84cc16'},
    {id:5,name:'ğŸ½ï¸ Ä‚n tá»‘i',type:'flex',eStart:'18:00',lEnd:'19:30',dur:40,repeat:[0,1,2,3,4,5,6],pri:'med',color:'#f97316'},
    {id:6,name:'ğŸ˜´ Ngá»§',type:'fixed',start:'22:00',end:'23:59',repeat:[0,1,2,3,4,5,6],pri:'high',color:'#8b5cf6'},
    {id:7,name:'ğŸ‰ Há»p lá»›p',type:'once',onceDate:offStr(2),start:'09:00',end:'11:00',pri:'med',color:'#f97316',repeat:[]},
  ];
  tasks=[
    {id:101,name:'LÃ m bÃ i táº­p ToÃ¡n chÆ°Æ¡ng 2',dur:75,pri:'high',diff:'hard',dateFrom:todayStr(),dateTo:offStr(4),pref:'morning',method:'pomodoro',subject:'ToÃ¡n',color:'#ef4444',subjectOverride:'',done:false,note:''},
    {id:102,name:'Viáº¿t vÄƒn nghá»‹ luáº­n',dur:45,pri:'med',diff:'med',dateFrom:todayStr(),dateTo:offStr(6),pref:'auto',method:'normal',subject:'Ngá»¯ VÄƒn',color:'#ec4899',subjectOverride:'',done:false,note:''},
    {id:103,name:'Ã”n tá»« vá»±ng Tiáº¿ng Anh',dur:30,pri:'med',diff:'easy',dateFrom:todayStr(),dateTo:offStr(10),pref:'evening',method:'spaced',subject:'Tiáº¿ng Anh',color:'#3b82f6',subjectOverride:'',done:false,note:''},
    {id:104,name:'Giáº£i bÃ i Váº­t LÃ½ cÆ¡ há»c',dur:60,pri:'high',diff:'hard',dateFrom:todayStr(),dateTo:offStr(2),pref:'morning',method:'pomodoro',subject:'Váº­t LÃ½',color:'#f97316',subjectOverride:'',done:false,note:''},
    {id:105,name:'Há»c HÃ³a há»¯u cÆ¡',dur:50,pri:'med',diff:'hard',dateFrom:todayStr(),dateTo:offStr(7),pref:'auto',method:'normal',subject:'HÃ³a Há»c',color:'#8b5cf6',subjectOverride:'',done:false,note:''},
    {id:106,name:'Ã”n Lá»‹ch Sá»­',dur:35,pri:'low',diff:'easy',dateFrom:todayStr(),dateTo:offStr(14),pref:'evening',method:'normal',subject:'Lá»‹ch Sá»­',color:'#d97706',subjectOverride:'',done:false,note:''},
    {id:107,name:'Láº­p trÃ¬nh Tin há»c bÃ i 5',dur:120,pri:'med',diff:'hard',dateFrom:todayStr(),dateTo:offStr(5),pref:'afternoon',method:'normal',subject:'Tin Há»c',color:'#0ea5e9',subjectOverride:'',done:false,note:''},
  ];
  DB.set(DB.K.EVENTS,events);DB.set(DB.K.TASKS,tasks);DB.set(DB.K.SCHED,{});schedule={};
  renderEvents();renderTasks();runScheduler();
  goTo('cal',document.querySelector('.tab'));showToast('âœ… Demo loaded!');
}
function resetAllData(){if(!confirm('XÃ³a TOÃ€N Bá»˜?'))return;DB.clear();location.reload();}

function startApp(){
  const land=document.getElementById('landing');land.style.transition='opacity .35s';land.style.opacity='0';
  setTimeout(()=>{land.style.display='none';document.getElementById('app').style.display='flex';initApp();},350);
}

function initApp(){
  cfg=getCfg();
  if(cfg.darkMode){document.documentElement.dataset.theme='dark';document.getElementById('btnDark').textContent='â˜€ï¸';}
  buildPickers();buildSubjectBtns();
  undoSnap=DB.get(DB.K.UNDO,null);if(undoSnap)document.getElementById('btnUndo').style.display='flex';
  document.getElementById('tk_dfrom').value=todayStr();document.getElementById('tk_dto').value=offStr(7);
  document.getElementById('cfg_hardMorning').checked=cfg.hardMorning!==false;
  document.getElementById('cfg_pomodoro').checked=cfg.pomodoro!==false;
  document.getElementById('cfg_spaced').checked=cfg.spaced!==false;
  document.getElementById('cfg_interleave').checked=cfg.interleave!==false;
  document.getElementById('cfg_splitLong').checked=cfg.splitLong!==false;
  if(document.getElementById('cfg_energyPeak'))document.getElementById('cfg_energyPeak').value=cfg.energyPeak||'morning';
  if(document.getElementById('cfg_splitThreshold'))document.getElementById('cfg_splitThreshold').value=cfg.splitThreshold||90;
  const savedKey=DB.get(DB.K.APIKEY,'')||'';const skIn=document.getElementById('setup_apikey');if(skIn)skIn.value=savedKey;
  pendingAiMode=cfg.aiMode||'fake';updateAIModeUI();
  if('Notification' in window&&Notification.permission==='default')document.getElementById('notifBanner').classList.add('show');
  updateNotifStatus();renderEvents();renderTasks();renderCalendar();
  loadChatHistory();
  if(!DB.get(DB.K.CHAT,[]).length){
    addMsg('a',`ğŸ‘‹ Xin chÃ o! <b>Smart Student Planner AI v12.1</b><br><br>
âœ¨ <b>TÃ­nh nÄƒng v12.1:</b><br>
â€¢ ğŸ“… <b>Ã” ngÃ y</b> hiá»ƒn thá»‹ táº¥t cáº£, cÃ³ thá»ƒ cuá»™n<br>
â€¢ ğŸ… <b>Pomodoro</b> Ä‘Ãºng chuáº©n: 25p há»c + nghá»‰ báº¯t buá»™c<br>
â€¢ âœ‚ï¸ <b>TÃ¡ch task dÃ i</b> tá»± Ä‘á»™ng (>90p)<br>
â€¢ ğŸ—“ï¸ <b>Tá»‰ lá»‡ 3:4</b>, cÃ³ thá»ƒ kÃ©o Ä‘iá»u chá»‰nh<br>
â€¢ ğŸ“ <b>Sá»± kiá»‡n Ä‘á»™t xuáº¥t</b> (1 láº§n)<br>
â€¢ ğŸ¨ <b>Timeline</b> khÃ´ng cÃ²n lá»—i mÃ u Ä‘en<br><br>
DÃ¹ng <em>Load Demo</em> trong âš™ï¸ Ä‘á»ƒ xem thá»­!`);
  }
  if('Notification' in window&&Notification.permission==='granted')scheduleNotifications();
}
</script>
</body>
</html>
