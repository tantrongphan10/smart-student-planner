<!DOCTYPE html>
<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Smart Student Planner AI â€“ v11.0                           â•‘
â•‘  Single-file â€¢ Offline Fake AI + Gemini 1.5 Flash           â•‘
â•‘  localStorage â€¢ Notification API â€¢ Landing Slide            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<html lang="vi" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ğŸ“š Smart Student Planner AI</title>
<style>
/* â”€â”€ ROOT VARIABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --bg:#f0ebff;--surf:#fff;--surf2:#f7f3ff;--surf3:#ede9ff;
  --pri:#7c3aed;--pri-l:#ede9fe;--pri-d:#5b21b6;
  --acc:#f472b6;--grn:#10b981;--yel:#f59e0b;--red:#ef4444;--blue:#3b82f6;
  --txt:#111827;--txt2:#6b7280;--brd:#e5e7eb;
  --shd:0 2px 16px rgba(124,58,237,.12);--r:12px;
  --font:'Segoe UI',system-ui,sans-serif;
}
[data-theme=dark]{
  --bg:#0e0b1a;--surf:#17142a;--surf2:#1e1a33;--surf3:#252040;
  --pri-l:#28204a;--txt:#ede9ff;--txt2:#9ca3af;--brd:#38305a;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:var(--font);font-size:15px}
body{background:var(--bg);color:var(--txt);transition:background .25s,color .25s}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--pri-l);border-radius:99px}

/* â”€â”€ LANDING SLIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#landing{
  position:fixed;inset:0;z-index:9999;
  background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:24px;overflow:auto;
}
#landing .land-logo{font-size:3.5rem;margin-bottom:10px;animation:floatLogo 3s ease-in-out infinite}
@keyframes floatLogo{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
#landing h1{font-size:2.2rem;font-weight:900;color:#fff;letter-spacing:-0.5px;line-height:1.2;margin-bottom:8px}
#landing h1 span{background:linear-gradient(90deg,#a78bfa,#f472b6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#landing .slogan{font-size:1rem;color:#c4b5fd;margin-bottom:10px;font-style:italic}
#landing .desc{max-width:480px;font-size:.88rem;color:#94a3b8;line-height:1.7;margin-bottom:32px}
.land-btns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:28px}
.land-btn{padding:12px 26px;border-radius:99px;font-weight:700;font-size:.9rem;cursor:pointer;border:none;transition:all .2s}
.land-btn.primary{background:linear-gradient(135deg,#7c3aed,#f472b6);color:#fff;box-shadow:0 4px 20px rgba(124,58,237,.4)}
.land-btn.primary:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(124,58,237,.5)}
.land-btn.secondary{background:rgba(255,255,255,.1);color:#fff;border:1.5px solid rgba(255,255,255,.2)}
.land-btn.secondary:hover{background:rgba(255,255,255,.2)}
.land-features{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;max-width:600px}
.lf{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;
  padding:10px 16px;font-size:.78rem;color:#c4b5fd;display:flex;align-items:center;gap:6px}

/* â”€â”€ GUIDE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#guideModal,#aiSetupModal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:10000;
  align-items:center;justify-content:center;padding:16px}
#guideModal.open,#aiSetupModal.open{display:flex}
.gm-box{background:#1e1a33;border-radius:16px;width:min(520px,100%);
  max-height:85vh;overflow-y:auto;box-shadow:0 30px 60px rgba(0,0,0,.5)}
.gm-hdr{padding:18px 22px;background:linear-gradient(135deg,#7c3aed,#f472b6);
  border-radius:16px 16px 0 0;display:flex;align-items:center;gap:10px}
.gm-hdr h3{flex:1;color:#fff;font-size:1rem;font-weight:800}
.gm-body{padding:20px 22px;color:#c4b5fd;font-size:.86rem;line-height:1.8}
.gm-body h4{color:#a78bfa;font-size:.9rem;margin:14px 0 6px}
.gm-body code{background:#28204a;padding:3px 8px;border-radius:6px;color:#f472b6;font-size:.82rem}
.gm-body .step{display:flex;gap:10px;margin-bottom:10px;align-items:flex-start}
.gm-body .sn{width:24px;height:24px;border-radius:50%;background:#7c3aed;color:#fff;
  font-weight:800;font-size:.75rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px}
.gm-body .warn{background:#2a1a00;border:1px solid #f59e0b;border-radius:8px;
  padding:8px 12px;color:#fcd34d;margin-top:10px;font-size:.8rem}
.gm-ftr{padding:12px 22px;border-top:1px solid #38305a;display:flex;gap:8px;justify-content:flex-end}

/* â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:none;flex-direction:column;height:100%}
#app.show{display:flex}

/* Header */
#hdr{flex-shrink:0;display:flex;align-items:center;gap:10px;
  padding:10px 18px;background:var(--surf);border-bottom:2px solid var(--brd);
  box-shadow:var(--shd);z-index:100;flex-wrap:wrap}
.logo{font-size:1rem;font-weight:900;color:var(--pri);white-space:nowrap;letter-spacing:-.3px}
.logo em{color:var(--acc);font-style:normal}
.hdr-r{display:flex;gap:6px;align-items:center;margin-left:auto;flex-wrap:wrap}
.ai-mode-pill{display:flex;align-items:center;gap:5px;padding:5px 11px;border-radius:99px;
  border:1.5px solid var(--brd);background:var(--surf2);font-size:.73rem;font-weight:700;
  cursor:pointer;transition:all .2s;white-space:nowrap}
.ai-mode-pill:hover{border-color:var(--pri)}
.sdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dot-ok{background:var(--grn)}.dot-err{background:var(--red)}.dot-chk{background:var(--yel);animation:pulse .7s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

/* Tabs */
#tabs{flex-shrink:0;display:flex;gap:2px;padding:8px 18px 0;
  background:var(--surf);border-bottom:2px solid var(--brd);overflow-x:auto}
.tab{padding:8px 14px;border:none;border-radius:9px 9px 0 0;background:transparent;
  color:var(--txt2);font:700 .8rem var(--font);white-space:nowrap;cursor:pointer;transition:all .18s}
.tab:hover{background:var(--pri-l);color:var(--pri)}
.tab.on{background:var(--pri);color:#fff}

/* Main */
#main{flex:1;overflow:hidden;display:flex;min-height:0}
.page{display:none;flex:1;overflow:hidden;flex-direction:column;min-height:0}
.page.on{display:flex}
.scroll{flex:1;overflow-y:auto;padding:18px}

/* Card */
.card{background:var(--surf);border:1.5px solid var(--brd);border-radius:var(--r);
  padding:16px;margin-bottom:14px;box-shadow:var(--shd)}
.ct{font-size:.9rem;font-weight:700;color:var(--pri);margin-bottom:12px}

/* Form */
.row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;align-items:flex-end}
.fg{display:flex;flex-direction:column;gap:4px;flex:1;min-width:100px}
.fg label{font-size:.71rem;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.3px}
.fg input,.fg select,.fg textarea{padding:8px 11px;border:1.5px solid var(--brd);border-radius:8px;
  background:var(--surf2);color:var(--txt);font:.86rem var(--font);transition:border .18s;outline:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--pri)}
.fg textarea{resize:vertical;min-height:52px}

/* Buttons */
.btn{padding:8px 15px;border:none;border-radius:8px;font:700 .82rem var(--font);
  cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn:active{transform:scale(.95)}
.bp{background:var(--pri);color:#fff}.bp:hover{background:var(--pri-d)}
.bg{background:var(--grn);color:#fff}
.bgh{background:var(--pri-l);color:var(--pri)}.bgh:hover{background:var(--pri);color:#fff}
.br{background:var(--red);color:#fff}
.by{background:var(--yel);color:#fff}
.bb{background:var(--blue);color:#fff}
.sm{padding:5px 10px;font-size:.75rem}
.bundo{background:#fef3c7;color:#92400e;border:1.5px solid #fbbf24}
.bundo:hover{background:#fbbf24;color:#fff}

/* Badge / Li */
.badge{padding:2px 8px;border-radius:99px;font-size:.68rem;font-weight:700}
.bh{background:#fecaca;color:#991b1b}.bm{background:#fef3c7;color:#92400e}.bl{background:#d1fae5;color:#065f46}
.li{display:flex;align-items:center;gap:8px;padding:9px 12px;border-radius:9px;
  border:1.5px solid var(--brd);background:var(--surf2);margin-bottom:7px;font-size:.84rem}
.li .n{flex:1;font-weight:600}
.dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

/* Toggle */
.toggle-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--brd)}
.toggle-row label{flex:1;font-size:.84rem;font-weight:600}
input[type=checkbox].tgl{width:36px;height:20px;appearance:none;background:var(--brd);
  border-radius:99px;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0}
input[type=checkbox].tgl:checked{background:var(--pri)}
input[type=checkbox].tgl::after{content:'';position:absolute;width:14px;height:14px;
  border-radius:50%;background:#fff;top:3px;left:3px;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
input[type=checkbox].tgl:checked::after{left:19px}

/* Toast */
#toast{position:fixed;bottom:20px;right:20px;z-index:9998;background:var(--pri);color:#fff;
  padding:10px 18px;border-radius:10px;font-size:.84rem;font-weight:700;
  box-shadow:var(--shd);display:none;animation:slideUp .25s ease}
@keyframes slideUp{from{transform:translateY(12px);opacity:0}to{transform:none;opacity:1}}

/* â”€â”€ CALENDAR SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#pg-cal{flex-direction:row}
#cal-left{display:flex;flex-direction:column;min-height:0;width:55%;flex-shrink:0;border-right:2px solid var(--brd)}
#cal-nav{flex-shrink:0;display:flex;align-items:center;gap:6px;padding:9px 12px;
  border-bottom:1.5px solid var(--brd);background:var(--surf);flex-wrap:wrap}
.wk-lbl{flex:1;text-align:center;font-weight:700;font-size:.86rem;min-width:100px}
#weekGrid{flex:1;overflow:auto;padding:8px;display:grid;grid-template-columns:repeat(7,1fr);gap:5px;align-content:start}
.dc{background:var(--surf);border:1.5px solid var(--brd);border-radius:10px;padding:7px 5px;
  min-height:220px;cursor:pointer;transition:all .18s;display:flex;flex-direction:column;gap:3px;overflow:hidden}
.dc:hover{border-color:var(--pri);box-shadow:0 2px 10px rgba(124,58,237,.12);transform:translateY(-1px)}
.dc.today{border-color:var(--pri);background:var(--pri-l)}
.dc.selected{border-color:var(--acc);box-shadow:0 0 0 2px rgba(244,114,182,.3)}
.dh{text-align:center;font-weight:700;font-size:.62rem;color:var(--txt2);text-transform:uppercase}
.dc.today .dh{color:var(--pri)}
.dd{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:.94rem;font-weight:800;margin:1px auto 3px}
.dc.today .dd{background:var(--pri);color:#fff}
.dc.selected .dd{background:var(--acc);color:#fff}
.ce{border-radius:5px;padding:3px 6px;font-size:.66rem;font-weight:600;
  overflow:hidden;border-left:3px solid transparent;cursor:pointer;flex-shrink:0;line-height:1.4}
.ce.done{opacity:.35;text-decoration:line-through}
.ce-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}
.ce-time{font-size:.58rem;opacity:.75;display:block}
#cal-right{flex:1;display:flex;flex-direction:column;min-height:0;background:var(--surf2)}
#tl-hdr{flex-shrink:0;padding:9px 13px;background:var(--surf);border-bottom:1.5px solid var(--brd);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
#tl-hdr h3{flex:1;font-size:.88rem;font-weight:700;color:var(--pri)}
#tl-placeholder{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;color:var(--txt2);font-size:.88rem;padding:20px;text-align:center}
#tl-placeholder .ph-icon{font-size:2.5rem}
#tl-body{flex:1;overflow-y:auto;padding:10px 12px 10px 54px;position:relative;display:none}
#tl-inner{position:relative}
.tl-hour{position:absolute;left:-46px;font-size:.64rem;color:var(--txt2);line-height:1;user-select:none}
.tl-line{position:absolute;left:-3px;right:0;border-top:1px dashed var(--brd)}
.tl-line-half{position:absolute;left:-3px;right:0;border-top:1px dotted var(--brd);opacity:.4}
#tl-now-line{position:absolute;left:-3px;right:0;border-top:2.5px solid var(--red);z-index:20;display:none}
.tl-now-lbl{position:absolute;left:2px;top:-10px;font-size:.63rem;color:var(--red);
  font-weight:700;background:var(--surf2);padding:1px 4px;border-radius:4px;white-space:nowrap}
.tl-slot{position:absolute;left:0;right:4px;border-radius:8px;padding:5px 9px;
  font-size:.76rem;font-weight:600;cursor:pointer;overflow:hidden;user-select:none;z-index:5;
  transition:filter .15s;display:flex;flex-direction:column;gap:1px}
.tl-slot:hover{filter:brightness(.88)}
.tl-slot.done{opacity:.4;text-decoration:line-through}
.ts-time{font-size:.63rem;opacity:.8;font-weight:500}
.ts-name{font-size:.76rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ts-sub{font-size:.6rem;opacity:.7;font-style:italic}
.ts-cb{position:absolute;right:6px;top:50%;transform:translateY(-50%);width:14px;height:14px;cursor:pointer;z-index:6}
.conflict-banner{background:#fef2f2;border:1.5px solid var(--red);border-radius:8px;
  padding:8px 12px;font-size:.78rem;color:#991b1b;flex-shrink:0;display:none;align-items:center;gap:8px}
.conflict-banner.show{display:flex}

/* â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#pg-ai{flex-direction:column}
#chat-top{flex-shrink:0;padding:10px 18px;background:var(--surf);border-bottom:1.5px solid var(--brd);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
#chat-top h3{font-size:.88rem;font-weight:700;color:var(--pri);flex:1}
.mode-badge{font-size:.7rem;padding:3px 9px;border-radius:99px;font-weight:700}
.mode-fake{background:#d1fae5;color:#065f46}.mode-gemini{background:#ede9fe;color:#5b21b6}
#chatBox{flex:1;overflow-y:auto;padding:14px 18px;display:flex;flex-direction:column;gap:10px;min-height:0}
.msg{max-width:82%;border-radius:14px;padding:10px 14px;font-size:.86rem;line-height:1.65;animation:msgIn .2s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg.u{background:var(--pri);color:#fff;align-self:flex-end;border-bottom-right-radius:3px}
.msg.a{background:var(--surf);border:1.5px solid var(--brd);align-self:flex-start;border-bottom-left-radius:3px}
.msg.sys{background:var(--surf3);border:1.5px dashed var(--brd);align-self:center;color:var(--txt2);font-size:.74rem;max-width:92%;text-align:center}
.cursor::after{content:'â–';animation:blink .7s infinite}
@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
.dots span{width:7px;height:7px;border-radius:50%;background:var(--pri);animation:bou .8s infinite;display:inline-block;margin:0 2px}
.dots span:nth-child(2){animation-delay:.15s}.dots span:nth-child(3){animation-delay:.3s}
@keyframes bou{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-7px)}}
#suggestions{display:flex;gap:6px;flex-wrap:wrap;padding:8px 18px;flex-shrink:0;border-bottom:1px solid var(--brd)}
.sugg{padding:5px 11px;border-radius:99px;border:1.5px solid var(--brd);background:var(--surf2);
  color:var(--txt2);font-size:.73rem;font-weight:600;cursor:pointer;transition:all .18s}
.sugg:hover{border-color:var(--pri);color:var(--pri);background:var(--pri-l)}
#chat-inp{flex-shrink:0;display:flex;gap:8px;padding:12px 18px;background:var(--surf);border-top:1.5px solid var(--brd)}
#chatIn{flex:1;padding:10px 13px;border:1.5px solid var(--brd);border-radius:10px;
  background:var(--surf2);color:var(--txt);font:.86rem var(--font);outline:none;
  resize:none;height:44px;max-height:100px;overflow-y:auto;transition:border .18s;line-height:1.4}
#chatIn:focus{border-color:var(--pri)}

/* Difficulty badges */
.diff-easy{background:#d1fae5;color:#065f46}.diff-med{background:#fef3c7;color:#92400e}.diff-hard{background:#fecaca;color:#991b1b}

/* Stats */
.stat-tabs{display:flex;gap:4px;margin-bottom:14px;flex-wrap:wrap}
.stat-tab{padding:7px 14px;border:1.5px solid var(--brd);border-radius:8px;background:var(--surf2);color:var(--txt2);font-size:.78rem;font-weight:700;cursor:pointer;transition:all .15s}
.stat-tab:hover{border-color:var(--pri);color:var(--pri)}
.stat-tab.on{background:var(--pri);color:#fff;border-color:var(--pri)}
.stat-cards{display:flex;gap:9px;flex-wrap:wrap;margin-bottom:14px}
.sc{background:var(--surf);border:1.5px solid var(--brd);border-radius:10px;padding:10px 14px;flex:1;min-width:70px}
.sv{font-size:1.35rem;font-weight:800;color:var(--pri)}.sl{font-size:.69rem;color:var(--txt2);margin-top:1px}
.prog{background:var(--brd);border-radius:99px;height:7px;overflow:hidden;margin-top:5px}
.prog-b{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--pri),var(--acc));transition:width .4s}
.stat-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.stat-bar-row .lbl{min-width:80px;font-size:.76rem;font-weight:600;color:var(--txt2);text-align:right}
.stat-bar-row .bar-wrap{flex:1;background:var(--brd);border-radius:99px;height:13px;overflow:hidden}
.stat-bar-row .bar-fill{height:100%;border-radius:99px;transition:width .4s}
.stat-bar-row .val{min-width:36px;font-size:.72rem;font-weight:700;color:var(--pri)}

/* Modal */
#editModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:500;align-items:center;justify-content:center;padding:14px}
#editModal.open{display:flex}
.m-box{background:var(--surf);border-radius:14px;width:min(460px,100%);box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden}
.m-hdr{display:flex;align-items:center;padding:14px 18px;border-bottom:1.5px solid var(--brd);background:var(--surf2)}
.m-hdr h3{flex:1;font-size:.93rem;font-weight:700;color:var(--pri)}
.m-body{padding:16px 18px;max-height:65vh;overflow-y:auto}
.m-ftr{display:flex;gap:8px;justify-content:flex-end;padding:12px 18px;border-top:1.5px solid var(--brd)}

/* Setup - API key area */
.api-key-box{background:var(--surf2);border:1.5px solid var(--brd);border-radius:10px;padding:14px;margin-bottom:14px}
.api-warning{background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:8px 12px;font-size:.78rem;color:#78350f;margin-top:8px;display:flex;align-items:flex-start;gap:6px}
[data-theme=dark] .api-warning{background:#2a1f0a;color:var(--yel)}
.mode-selector{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.mode-opt{flex:1;min-width:140px;border:2px solid var(--brd);border-radius:12px;padding:14px;cursor:pointer;transition:all .2s;text-align:center;background:var(--surf)}
.mode-opt:hover{border-color:var(--pri)}
.mode-opt.on{border-color:var(--pri);background:var(--pri-l)}
.mode-opt .mo-icon{font-size:1.8rem;margin-bottom:6px}
.mode-opt .mo-title{font-weight:700;font-size:.86rem;color:var(--pri)}
.mode-opt .mo-desc{font-size:.72rem;color:var(--txt2);margin-top:3px;line-height:1.5}

/* Notification banner */
#notifBanner{display:none;background:linear-gradient(135deg,var(--pri),var(--acc));
  color:#fff;padding:8px 18px;font-size:.8rem;font-weight:600;flex-shrink:0;
  align-items:center;gap:8px;flex-wrap:wrap}
#notifBanner.show{display:flex}

/* Subj buttons */
.subj-btns{display:flex;gap:5px;flex-wrap:wrap;margin-top:4px}
.subj-btn{padding:4px 10px;border-radius:99px;border:1.5px solid var(--brd);background:var(--surf2);color:var(--txt2);font-size:.72rem;font-weight:700;cursor:pointer;transition:all .15s}
.subj-btn:hover,.subj-btn.on{border-color:var(--pri);color:var(--pri);background:var(--pri-l)}
.pri-btns{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.pri-btn{padding:5px 12px;border-radius:8px;border:1.5px solid var(--brd);background:var(--surf2);font-size:.76rem;font-weight:700;cursor:pointer;transition:all .15s;color:var(--txt2)}
.pri-btn.on-high{background:#fecaca;color:#991b1b;border-color:#f87171}
.pri-btn.on-med{background:#fef3c7;color:#92400e;border-color:#fbbf24}
.pri-btn.on-low{background:#d1fae5;color:#065f46;border-color:#34d399}
.dpick{display:flex;gap:4px;flex-wrap:wrap}
.dchip{width:29px;height:29px;border-radius:50%;border:1.5px solid var(--brd);background:var(--surf2);
  color:var(--txt2);font-size:.72rem;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .18s}
.dchip.on{background:var(--pri);color:#fff;border-color:var(--pri)}
.cpick{display:flex;gap:6px;flex-wrap:wrap}
.copt{width:22px;height:22px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border .18s}
.copt.on{border-color:var(--txt)}
.tip-b{background:#fef9c3;border:1.5px solid #f59e0b;border-radius:8px;padding:8px 12px;font-size:.78rem;color:#78350f;margin-top:6px}
[data-theme=dark] .tip-b{background:#2a1f0a;color:var(--txt2)}
.code-b{background:var(--surf3);border:1.5px solid var(--brd);border-radius:8px;padding:8px 12px;
  font-family:monospace;font-size:.78rem;color:var(--pri);position:relative;white-space:pre-wrap;word-break:break-all;line-height:1.6}
.cpbtn{position:absolute;right:6px;top:6px;background:var(--pri-l);border:none;border-radius:5px;padding:2px 7px;font-size:.66rem;color:var(--pri);font-weight:700;cursor:pointer}
.step{display:flex;gap:12px;margin-bottom:12px}
.sn{width:26px;height:26px;border-radius:50%;background:var(--pri);color:#fff;font-weight:800;font-size:.82rem;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* Responsive */
@media(max-width:900px){#pg-cal{flex-direction:column}#cal-left{width:100%;height:46%;border-right:none;border-bottom:2px solid var(--brd)}#weekGrid{grid-template-columns:repeat(4,1fr)}#cal-right{height:54%}}
@media(max-width:600px){#weekGrid{grid-template-columns:repeat(3,1fr)}.dc{min-height:150px}.msg{max-width:92%}.hdr-r{gap:4px}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LANDING SLIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="landing">
  <div class="land-logo">ğŸ“š</div>
  <h1>Smart Student <span>Planner AI</span></h1>
  <div class="slogan">"Há»c thÃ´ng minh hÆ¡n, khÃ´ng pháº£i chÄƒm chá»‰ hÆ¡n."</div>
  <div class="desc">
    Trá»£ lÃ½ láº­p lá»‹ch há»c cÃ¡ nhÃ¢n Ä‘Æ°á»£c há»— trá»£ bá»Ÿi <strong style="color:#a78bfa">Gemini AI</strong> 
    hoáº·c <strong style="color:#f472b6">Fake AI offline</strong>.<br>
    Quáº£n lÃ½ thá»i gian, theo dÃµi deadline, tá»‘i Æ°u lá»‹ch há»c theo Ä‘á»™ khÃ³ tá»«ng mÃ´n.
  </div>
  <div class="land-btns">
    <button class="land-btn primary" onclick="startApp()">ğŸš€ Báº¯t Ä‘áº§u</button>
    <button class="land-btn secondary" onclick="openGuide()">ğŸ“– HÆ°á»›ng dáº«n</button>
    <button class="land-btn secondary" onclick="openAiSetup()">âš™ï¸ CÃ i Ä‘áº·t AI</button>
  </div>
  <div class="land-features">
    <div class="lf">ğŸ¤– Gemini AI + Fake AI</div>
    <div class="lf">ğŸ“… Xáº¿p lá»‹ch thÃ´ng minh</div>
    <div class="lf">ğŸ”” Nháº¯c nhá»Ÿ deadline</div>
    <div class="lf">ğŸ“Š Thá»‘ng kÃª há»c táº­p</div>
    <div class="lf">ğŸ’¾ LÆ°u trá»¯ cá»¥c bá»™</div>
    <div class="lf">ğŸ“± Há»— trá»£ Ä‘iá»‡n thoáº¡i</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GUIDE MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="guideModal">
  <div class="gm-box">
    <div class="gm-hdr">
      <span style="font-size:1.2rem">ğŸ“–</span>
      <h3>HÆ°á»›ng dáº«n sá»­ dá»¥ng</h3>
      <button class="btn bgh sm" onclick="closeGuide()">âœ•</button>
    </div>
    <div class="gm-body">
      <h4>ğŸš€ Báº¯t Ä‘áº§u nhanh</h4>
      <div class="step"><div class="sn">1</div><div>VÃ o tab <strong>Sá»± kiá»‡n</strong> â†’ thÃªm lá»‹ch há»c, Äƒn, ngá»§â€¦</div></div>
      <div class="step"><div class="sn">2</div><div>VÃ o tab <strong>CÃ´ng viá»‡c</strong> â†’ thÃªm bÃ i táº­p + Ä‘á»™ khÃ³ + deadline</div></div>
      <div class="step"><div class="sn">3</div><div>Nháº¥n <strong>âš¡ Xáº¿p lá»‹ch</strong> Ä‘á»ƒ AI tá»± Ä‘á»™ng sáº¯p xáº¿p</div></div>
      <div class="step"><div class="sn">4</div><div>Chat vá»›i AI Ä‘á»ƒ Ä‘iá»u chá»‰nh lá»‹ch báº±ng ngÃ´n ngá»¯ tá»± nhiÃªn</div></div>

      <h4>ğŸ¤– Láº¥y API Key Gemini miá»…n phÃ­</h4>
      <div class="step"><div class="sn">1</div><div>Truy cáº­p <code>aistudio.google.com</code></div></div>
      <div class="step"><div class="sn">2</div><div>ÄÄƒng nháº­p báº±ng tÃ i khoáº£n Google</div></div>
      <div class="step"><div class="sn">3</div><div>Nháº¥n <strong>"Get API Key"</strong> â†’ <strong>"Create API key"</strong></div></div>
      <div class="step"><div class="sn">4</div><div>Copy key â†’ DÃ¡n vÃ o âš™ï¸ CÃ i Ä‘áº·t â†’ Gemini API Key</div></div>
      <div class="warn">âš ï¸ <strong>Cáº£nh bÃ¡o báº£o máº­t:</strong> KhÃ´ng chia sáº» API key vá»›i ngÆ°á»i khÃ¡c. Key nÃ y cÃ³ thá»ƒ bá»‹ láº¡m dá»¥ng Ä‘á»ƒ gá»i API tÃ­nh vÃ o quota cá»§a báº¡n. Náº¿u bá»‹ lá»™, hÃ£y xÃ³a vÃ  táº¡o key má»›i táº¡i Google AI Studio.</div>

      <h4>ğŸ§  Fake AI (Offline)</h4>
      Náº¿u khÃ´ng cÃ³ internet hoáº·c khÃ´ng muá»‘n dÃ¹ng Gemini, chá»n cháº¿ Ä‘á»™ <strong>Fake AI</strong> â€“ hoáº¡t Ä‘á»™ng hoÃ n toÃ n báº±ng thuáº­t toÃ¡n JavaScript, khÃ´ng cáº§n internet.

      <h4>ğŸ”” ThÃ´ng bÃ¡o</h4>
      Nháº¥n <strong>Báº­t thÃ´ng bÃ¡o</strong> khi Ä‘Æ°á»£c há»i Ä‘á»ƒ nháº­n nháº¯c nhá»Ÿ trÆ°á»›c deadline vÃ  giá» há»c.

      <h4>ğŸ“Š Äá»™ khÃ³ mÃ´n há»c</h4>
      Khi thÃªm cÃ´ng viá»‡c, chá»n Ä‘á»™ khÃ³: <strong>Dá»… / Trung bÃ¬nh / KhÃ³</strong>. AI sáº½ Æ°u tiÃªn mÃ´n khÃ³ vÃ o buá»•i sÃ¡ng vÃ  xen káº½ Ä‘á»ƒ trÃ¡nh quÃ¡ táº£i.
    </div>
    <div class="gm-ftr">
      <button class="btn bp sm" onclick="closeGuide()">ÄÃ£ hiá»ƒu âœ“</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AI SETUP MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="aiSetupModal">
  <div class="gm-box">
    <div class="gm-hdr">
      <span style="font-size:1.2rem">âš™ï¸</span>
      <h3>Chá»n cháº¿ Ä‘á»™ AI</h3>
      <button class="btn bgh sm" onclick="closeAiSetup()">âœ•</button>
    </div>
    <div class="gm-body">
      <div class="mode-selector">
        <div class="mode-opt on" id="mopt-fake" onclick="selectAiMode('fake')">
          <div class="mo-icon">ğŸ§ </div>
          <div class="mo-title">Fake AI (Offline)</div>
          <div class="mo-desc">Thuáº­t toÃ¡n JS thuáº§n<br>KhÃ´ng cáº§n internet<br>Miá»…n phÃ­ 100%</div>
        </div>
        <div class="mode-opt" id="mopt-gemini" onclick="selectAiMode('gemini')">
          <div class="mo-icon">âœ¨</div>
          <div class="mo-title">Gemini AI</div>
          <div class="mo-desc">Google Gemini 2.0 Flash<br>Cáº§n API key + internet<br>ThÃ´ng minh hÆ¡n</div>
        </div>
      </div>
      <div id="geminiKeySection" style="display:none">
        <div class="fg" style="margin-bottom:10px">
          <label>Gemini API Key</label>
          <input type="password" id="geminiKeyInput" placeholder="AIzaâ€¦"/>
        </div>
        <div class="toggle-row" style="border:none;padding:0;margin-bottom:10px">
          <label style="font-size:.8rem">LÆ°u API key vÃ o localStorage (thiáº¿t bá»‹ cÃ¡ nhÃ¢n)</label>
          <input type="checkbox" class="tgl" id="saveKeyToggle" checked/>
        </div>
        <div class="api-warning">âš ï¸ KhÃ´ng chia sáº» API key. ÄÃ¢y lÃ  thÃ´ng tin nháº¡y cáº£m!</div>
      </div>
    </div>
    <div class="gm-ftr">
      <button class="btn bgh sm" onclick="closeAiSetup()">Huá»·</button>
      <button class="btn bp sm" onclick="saveAiSetup()">ğŸ’¾ LÆ°u & Ãp dá»¥ng</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">
  <!-- Notification banner -->
  <div id="notifBanner">
    ğŸ”” Báº­t thÃ´ng bÃ¡o Ä‘á»ƒ nháº­n nháº¯c nhá»Ÿ deadline vÃ  giá» há»c!
    <button class="btn sm" style="background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3)" onclick="requestNotif()">Báº­t thÃ´ng bÃ¡o</button>
    <button class="btn sm" style="background:transparent;color:rgba(255,255,255,.6);border:none;margin-left:auto" onclick="document.getElementById('notifBanner').classList.remove('show')">âœ•</button>
  </div>

  <!-- Header -->
  <div id="hdr">
    <div class="logo">ğŸ“š Smart <em>Student</em> Planner</div>
    <div class="hdr-r">
      <div class="ai-mode-pill" onclick="openAiSetup()">
        <div class="sdot" id="sDot"></div>
        <span id="sTxt">Fake AI</span>
      </div>
      <button class="btn bundo sm" id="btnUndo" onclick="applyUndo()" style="display:none">â†© HoÃ n tÃ¡c</button>
      <button class="btn bgh sm" onclick="toggleDark()">ğŸŒ™</button>
      <button class="btn bp sm" onclick="runScheduler()">âš¡ Xáº¿p lá»‹ch</button>
    </div>
  </div>

  <!-- Tabs -->
  <div id="tabs">
    <button class="tab on" onclick="goTo('cal',this)">ğŸ“… Lá»‹ch tuáº§n</button>
    <button class="tab" onclick="goTo('ai',this)">ğŸ¤– AI Chat</button>
    <button class="tab" onclick="goTo('ev',this)">ğŸ“Œ Sá»± kiá»‡n</button>
    <button class="tab" onclick="goTo('tk',this)">ğŸ“ CÃ´ng viá»‡c</button>
    <button class="tab" onclick="goTo('stats',this)">ğŸ“Š Thá»‘ng kÃª</button>
    <button class="tab" onclick="goTo('setup',this)">âš™ï¸ CÃ i Ä‘áº·t</button>
  </div>

  <div id="main">

    <!-- CALENDAR -->
    <div class="page on" id="pg-cal">
      <div id="cal-left">
        <div id="cal-nav">
          <button class="btn bgh sm" onclick="chgWeek(-1)">â—€</button>
          <span class="wk-lbl" id="wkLbl"></span>
          <button class="btn bgh sm" onclick="chgWeek(1)">â–¶</button>
          <button class="btn bgh sm" onclick="chgWeek(0,'today')">HÃ´m nay</button>
          <button class="btn bp sm" onclick="runScheduler()">âš¡</button>
        </div>
        <div id="weekGrid"></div>
      </div>
      <div id="cal-right">
        <div id="tl-hdr">
          <h3 id="tlTitle">â† Nháº¥p vÃ o ngÃ y Ä‘á»ƒ xem</h3>
          <button class="btn bgh sm" onclick="openEditNew()">â• ThÃªm</button>
        </div>
        <div id="conflictBanner" class="conflict-banner">âš ï¸ <span id="conflictMsg"></span></div>
        <div id="tl-placeholder">
          <div class="ph-icon">ğŸ“…</div>
          <div style="font-weight:700;color:var(--pri)">Chá»n má»™t ngÃ y Ä‘á»ƒ xem chi tiáº¿t</div>
          <div style="font-size:.78rem">Nháº¥p vÃ o báº¥t ká»³ Ã´ nÃ o bÃªn trÃ¡i</div>
          <div style="margin-top:8px"><button class="btn bp sm" onclick="runScheduler()">âš¡ Xáº¿p lá»‹ch ngay</button></div>
        </div>
        <div id="tl-body">
          <div id="tl-inner">
            <div id="tl-now-line"><span class="tl-now-lbl" id="nowLbl">BÃ¢y giá»</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI CHAT -->
    <div class="page" id="pg-ai">
      <div id="chat-top">
        <h3>ğŸ¤– AI Chat</h3>
        <span id="modeBadge" class="mode-badge mode-fake">ğŸ§  Fake AI</span>
        <button class="btn bgh sm" onclick="clearChatHistory()">ğŸ—‘ï¸ XÃ³a</button>
      </div>
      <div id="suggestions">
        <div class="sugg" onclick="quickSend(this)">HÃ´m nay tÃ´i cÃ³ gÃ¬?</div>
        <div class="sugg" onclick="quickSend(this)">ThÃªm bÃ i ToÃ¡n 60 phÃºt</div>
        <div class="sugg" onclick="quickSend(this)">Sáº¯p xáº¿p mÃ´n khÃ³ trÆ°á»›c</div>
        <div class="sugg" onclick="quickSend(this)">Deadline sáº¯p tá»›i?</div>
        <div class="sugg" onclick="quickSend(this)">Lá»i khuyÃªn há»c táº­p</div>
      </div>
      <div id="chatBox"></div>
      <div id="chat-inp">
        <textarea id="chatIn" placeholder="Nháº­p yÃªu cáº§uâ€¦ (Enter gá»­i, Shift+Enter xuá»‘ng dÃ²ng)"
          onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
        <button class="btn bp" onclick="sendChat()">Gá»­i ğŸš€</button>
      </div>
    </div>

    <!-- EVENTS -->
    <div class="page" id="pg-ev">
      <div class="scroll">
        <div class="card">
          <div class="ct">â• ThÃªm sá»± kiá»‡n</div>
          <div class="row">
            <div class="fg" style="flex:2"><label>TÃªn sá»± kiá»‡n</label><input id="ev_n" placeholder="Äi há»c, Ä‚n cÆ¡mâ€¦"/></div>
            <div class="fg"><label>Loáº¡i</label>
              <select id="ev_t" onchange="toggleFlex()">
                <option value="fixed">ğŸ“Œ Cá»‘ Ä‘á»‹nh</option>
                <option value="flex">ğŸ”€ Linh hoáº¡t</option>
              </select></div>
            <div class="fg"><label>Æ¯u tiÃªn</label>
              <select id="ev_p"><option value="high">ğŸ”´ Cao</option><option value="med" selected>ğŸŸ¡ TB</option><option value="low">ğŸŸ¢ Tháº¥p</option></select></div>
          </div>
          <div id="ui_fix">
            <div class="row">
              <div class="fg"><label>Báº¯t Ä‘áº§u</label><input type="time" id="ev_s" value="07:00"/></div>
              <div class="fg"><label>Káº¿t thÃºc</label><input type="time" id="ev_e" value="11:30"/></div>
            </div>
          </div>
          <div id="ui_flex" style="display:none">
            <div class="row">
              <div class="fg"><label>Sá»›m nháº¥t</label><input type="time" id="ev_es" value="17:30"/></div>
              <div class="fg"><label>Muá»™n nháº¥t</label><input type="time" id="ev_le" value="20:00"/></div>
              <div class="fg"><label>Thá»i lÆ°á»£ng (phÃºt)</label><input type="number" id="ev_fd" value="30" min="5" step="5"/></div>
            </div>
          </div>
          <div class="row" style="align-items:center">
            <div class="fg"><label>Láº·p láº¡i ngÃ y</label><div class="dpick" id="dayPick"></div></div>
            <div class="fg" style="max-width:120px"><label>MÃ u</label><div class="cpick" id="colPick"></div></div>
          </div>
          <button class="btn bp" onclick="addEvent()">â• ThÃªm sá»± kiá»‡n</button>
        </div>
        <div class="card">
          <div class="ct">ğŸ“‹ Danh sÃ¡ch sá»± kiá»‡n (<span id="evCount">0</span>)</div>
          <div id="evList"></div>
        </div>
      </div>
    </div>

    <!-- TASKS -->
    <div class="page" id="pg-tk">
      <div class="scroll">
        <div class="card">
          <div class="ct">â• ThÃªm cÃ´ng viá»‡c</div>
          <div class="row">
            <div class="fg" style="flex:2"><label>TÃªn cÃ´ng viá»‡c</label>
              <input id="tk_n" placeholder="LÃ m bÃ i ToÃ¡n, Viáº¿t vÄƒnâ€¦" oninput="autoDetectSubject(this.value)"/></div>
            <div class="fg" style="max-width:120px"><label>Thá»i lÆ°á»£ng (phÃºt)</label>
              <input type="number" id="tk_d" value="60" min="10" max="360" step="5"/></div>
          </div>
          <div class="row">
            <div class="fg">
              <label>MÃ´n há»c <span id="subjectAutoLabel" style="color:var(--grn);font-size:.68rem"></span></label>
              <div class="subj-btns" id="subjBtns"></div>
            </div>
          </div>
          <div class="row">
            <div class="fg">
              <label>Äá»™ khÃ³</label>
              <div class="pri-btns" id="diffBtns">
                <div class="pri-btn" data-diff="easy" onclick="selectDiff('easy')">ğŸŸ¢ Dá»…</div>
                <div class="pri-btn on-med" data-diff="med" onclick="selectDiff('med')">ğŸŸ¡ Trung bÃ¬nh</div>
                <div class="pri-btn" data-diff="hard" onclick="selectDiff('hard')">ğŸ”´ KhÃ³</div>
              </div>
            </div>
            <div class="fg">
              <label>Má»©c Æ°u tiÃªn</label>
              <div class="pri-btns" id="priBtns">
                <div class="pri-btn" data-pri="high" onclick="selectPri('high')">ğŸ”´ Cao</div>
                <div class="pri-btn on-med" data-pri="med" onclick="selectPri('med')">ğŸŸ¡ TB</div>
                <div class="pri-btn" data-pri="low" onclick="selectPri('low')">ğŸŸ¢ Tháº¥p</div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="fg"><label>ğŸ“… Báº¯t Ä‘áº§u tá»« ngÃ y</label><input type="date" id="tk_dfrom"/></div>
            <div class="fg"><label>ğŸ Háº¡n chÃ³t</label><input type="date" id="tk_dto"/></div>
          </div>
          <div class="row">
            <div class="fg"><label>Khung giá» Æ°u tiÃªn</label>
              <select id="tk_pref">
                <option value="auto">ğŸ¤– Tá»± Ä‘á»™ng</option>
                <option value="morning">ğŸŒ… SÃ¡ng (6hâ€“12h)</option>
                <option value="afternoon">ğŸŒ¤ï¸ Chiá»u (12hâ€“18h)</option>
                <option value="evening">ğŸŒ™ Tá»‘i (18hâ€“22h)</option>
              </select></div>
            <div class="fg"><label>Ghi chÃº</label><input id="tk_note" placeholder="Ghi chÃºâ€¦"/></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn bg" onclick="addTask()">â• ThÃªm cÃ´ng viá»‡c</button>
            <button class="btn bp sm" onclick="runScheduler()">âš¡ Xáº¿p lá»‹ch</button>
          </div>
        </div>
        <div class="card">
          <div class="ct">ğŸ“‹ CÃ´ng viá»‡c (<span id="tkCount">0</span>)</div>
          <div style="display:flex;gap:7px;margin-bottom:12px;flex-wrap:wrap">
            <select id="schedMode" style="padding:6px 10px;border:1.5px solid var(--brd);border-radius:8px;background:var(--surf2);color:var(--txt);font:.8rem var(--font)">
              <option value="hard-first">ğŸ”´ KhÃ³ trÆ°á»›c</option>
              <option value="interleave">ğŸ”„ Xen káº½ khÃ³-dá»…</option>
              <option value="greedy">âš¡ Greedy</option>
            </select>
            <button class="btn bgh sm" onclick="clearDone()">ğŸ—‘ï¸ XÃ³a Ä‘Ã£ xong</button>
          </div>
          <div id="tkList"></div>
        </div>
      </div>
    </div>

    <!-- STATS -->
    <div class="page" id="pg-stats">
      <div class="scroll">
        <div class="stat-tabs">
          <button class="stat-tab on" onclick="switchStatTab('day',this)">ğŸ“† NgÃ y</button>
          <button class="stat-tab" onclick="switchStatTab('week',this)">ğŸ—“ï¸ Tuáº§n</button>
          <button class="stat-tab" onclick="switchStatTab('month',this)">ğŸ“… ThÃ¡ng</button>
        </div>
        <div id="statsContent"></div>
      </div>
    </div>

    <!-- SETUP -->
    <div class="page" id="pg-setup">
      <div class="scroll">
        <!-- AI Mode -->
        <div class="card">
          <div class="ct">ğŸ¤– Cháº¿ Ä‘á»™ AI hiá»‡n táº¡i</div>
          <div class="mode-selector">
            <div class="mode-opt on" id="setup-mopt-fake" onclick="selectAiMode('fake');updateSetupModeUI()">
              <div class="mo-icon">ğŸ§ </div>
              <div class="mo-title">Fake AI (Offline)</div>
              <div class="mo-desc">Thuáº­t toÃ¡n JS thuáº§n, khÃ´ng cáº§n internet</div>
            </div>
            <div class="mode-opt" id="setup-mopt-gemini" onclick="selectAiMode('gemini');updateSetupModeUI()">
              <div class="mo-icon">âœ¨</div>
              <div class="mo-title">Gemini AI</div>
              <div class="mo-desc">Google Gemini 2.0 Flash</div>
            </div>
          </div>
          <div id="setup-gemini-section" style="display:none">
            <div class="fg" style="margin-bottom:10px">
              <label>Gemini API Key</label>
              <div style="display:flex;gap:6px">
                <input type="password" id="setup_apikey" placeholder="AIzaâ€¦" style="flex:1;padding:8px 11px;border:1.5px solid var(--brd);border-radius:8px;background:var(--surf2);color:var(--txt);font:.86rem var(--font);outline:none"/>
                <button class="btn bp sm" onclick="saveGeminiKey()">ğŸ’¾</button>
                <button class="btn bgh sm" onclick="testGemini()">ğŸ§ª Test</button>
              </div>
            </div>
            <div class="api-warning">âš ï¸ KhÃ´ng chia sáº» API key. Key nÃ y cho phÃ©p gá»i Gemini API trong quota cá»§a báº¡n.</div>
          </div>
        </div>

        <!-- Notifications -->
        <div class="card">
          <div class="ct">ğŸ”” ThÃ´ng bÃ¡o</div>
          <p style="font-size:.82rem;color:var(--txt2);margin-bottom:10px">Nháº­n thÃ´ng bÃ¡o nháº¯c nhá»Ÿ trÆ°á»›c deadline vÃ  giá» há»c 10-15 phÃºt.</p>
          <div id="notifStatus" style="font-size:.82rem;margin-bottom:8px;color:var(--txt2)">Tráº¡ng thÃ¡i: chÆ°a xÃ¡c Ä‘á»‹nh</div>
          <button class="btn bp sm" onclick="requestNotif()">ğŸ”” Báº­t thÃ´ng bÃ¡o</button>
        </div>

        <!-- Scheduler settings -->
        <div class="card">
          <div class="ct">âš¡ CÃ i Ä‘áº·t xáº¿p lá»‹ch</div>
          <div class="toggle-row">
            <label>Æ¯u tiÃªn mÃ´n khÃ³ buá»•i sÃ¡ng</label>
            <input type="checkbox" class="tgl" id="cfg_hardMorning" checked/>
          </div>
          <div class="toggle-row">
            <label>Xen káº½ khÃ³ â€“ dá»… Ä‘á»ƒ giáº£m quÃ¡ táº£i</label>
            <input type="checkbox" class="tgl" id="cfg_interleave"/>
          </div>
          <div class="toggle-row">
            <label>Tá»± Ä‘á»™ng thÃªm nghá»‰ Pomodoro</label>
            <input type="checkbox" class="tgl" id="cfg_pomodoro" checked/>
          </div>
          <div style="margin-top:10px">
            <button class="btn bp sm" onclick="saveCfg()">ğŸ’¾ LÆ°u cÃ i Ä‘áº·t</button>
          </div>
        </div>

        <!-- Demo / Reset -->
        <div class="card">
          <div class="ct">ğŸ“¥ Dá»¯ liá»‡u Demo</div>
          <p style="font-size:.82rem;color:var(--txt2);margin-bottom:10px">Táº£i lá»‹ch máº«u Ä‘á»ƒ xem thá»­ á»©ng dá»¥ng.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn bb sm" onclick="loadDemoData()">ğŸ“¥ Load Demo</button>
            <button class="btn br sm" onclick="resetAllData()">ğŸ—‘ï¸ XÃ³a táº¥t cáº£</button>
          </div>
        </div>

        <!-- Guide for API -->
        <div class="card">
          <div class="ct">ğŸ“‹ HÆ°á»›ng dáº«n láº¥y Gemini API Key</div>
          <div class="step"><div class="sn">1</div><div>Truy cáº­p <div class="code-b">https://aistudio.google.com<button class="cpbtn" onclick="cp('https://aistudio.google.com')">Copy</button></div></div></div>
          <div class="step"><div class="sn">2</div><div>ÄÄƒng nháº­p Google â†’ Nháº¥n <strong>"Get API Key"</strong></div></div>
          <div class="step"><div class="sn">3</div><div>Nháº¥n <strong>"Create API key in new project"</strong></div></div>
          <div class="step"><div class="sn">4</div><div>Copy key báº¯t Ä‘áº§u báº±ng <code style="background:var(--surf3);padding:2px 6px;border-radius:4px;font-size:.8rem">AIza</code></div></div>
          <div class="step"><div class="sn">5</div><div>DÃ¡n vÃ o Ã´ <strong>Gemini API Key</strong> bÃªn trÃªn â†’ nháº¥n ğŸ’¾</div></div>
          <div class="api-warning" style="margin-top:4px">âš ï¸ API key miá»…n phÃ­ cÃ³ giá»›i háº¡n 15 requests/phÃºt. Äá»§ dÃ¹ng cho há»c táº­p cÃ¡ nhÃ¢n.</div>
        </div>
      </div>
    </div>

  </div><!-- /#main -->

  <!-- EDIT MODAL -->
  <div id="editModal" onclick="if(event.target===this)closeEdit()">
    <div class="m-box">
      <div class="m-hdr">
        <h3 id="editTitle">âœï¸ Chá»‰nh sá»­a</h3>
        <button class="btn bgh sm" onclick="closeEdit()">âœ•</button>
      </div>
      <div class="m-body">
        <div class="row"><div class="fg"><label>TÃªn</label><input id="e_name"/></div></div>
        <div class="row">
          <div class="fg"><label>Báº¯t Ä‘áº§u</label><input type="time" id="e_start"/></div>
          <div class="fg"><label>Káº¿t thÃºc</label><input type="time" id="e_end"/></div>
        </div>
        <div class="row">
          <div class="fg"><label>Æ¯u tiÃªn</label>
            <select id="e_pri"><option value="high">ğŸ”´ Cao</option><option value="med">ğŸŸ¡ TB</option><option value="low">ğŸŸ¢ Tháº¥p</option></select></div>
          <div class="fg"><label>Thá»i lÆ°á»£ng (phÃºt)</label><input type="number" id="e_dur" min="10" step="5"/></div>
        </div>
        <div class="row">
          <div class="fg"><label>ğŸ“… Tá»« ngÃ y</label><input type="date" id="e_dfrom"/></div>
          <div class="fg"><label>ğŸ Äáº¿n ngÃ y</label><input type="date" id="e_dto"/></div>
        </div>
        <div class="row"><div class="fg"><label>Tag / MÃ´n</label><input id="e_tag"/></div></div>
        <div class="row"><div class="fg"><label>Ghi chÃº</label><textarea id="e_note" rows="2"></textarea></div></div>
      </div>
      <div class="m-ftr">
        <button class="btn br sm" onclick="deleteEditTarget()">ğŸ—‘ï¸ XÃ³a</button>
        <div style="flex:1"></div>
        <button class="btn bgh sm" onclick="closeEdit()">Huá»·</button>
        <button class="btn bp sm" onclick="saveEdit()">ğŸ’¾ LÆ°u</button>
      </div>
    </div>
  </div>

</div><!-- /#app -->

<div id="toast"></div>

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS & STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const APP_VER = '11.0';
const COLORS  = ['#7c3aed','#3b82f6','#10b981','#f59e0b','#ef4444','#f97316','#ec4899','#0ea5e9','#84cc16'];
const DAY_VI  = ['CN','T2','T3','T4','T5','T6','T7'];
const DAY_FULL= ['Chá»§ Nháº­t','Thá»© Hai','Thá»© Ba','Thá»© TÆ°','Thá»© NÄƒm','Thá»© SÃ¡u','Thá»© Báº£y'];

// Runtime state
let weekOff  = 0;
let tlDate   = null;
let selPri   = 'med';
let selDiff  = 'med';
let selSubj  = '';
let editCtx  = null;
let undoSnap = null;
let notifTimer = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DB â€“ localStorage wrapper
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB = {
  K: {
    TASKS:'ssp_tasks', EVENTS:'ssp_events', SCHED:'ssp_sched',
    CHAT:'ssp_chat',   CFG:'ssp_cfg',       UNDO:'ssp_undo',
    APIKEY:'ssp_apikey'
  },
  get(k, def=[]) {
    try { const v=localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch { return def; }
  },
  set(k, v) { localStorage.setItem(k, JSON.stringify(v)); },
  cfg(k, v) {
    if (v === undefined) return this.get(this.K.CFG, {})[k];
    const s = this.get(this.K.CFG, {}); s[k] = v; this.set(this.K.CFG, s);
  },
  clear() { Object.values(this.K).forEach(k => localStorage.removeItem(k)); }
};

// Load persistent data
let events   = DB.get(DB.K.EVENTS);
let tasks    = DB.get(DB.K.TASKS);
let schedule = DB.get(DB.K.SCHED, {});

// Config with defaults
function getCfg() {
  return Object.assign({
    aiMode: 'fake', darkMode: false,
    hardMorning: true, interleave: false, pomodoro: true,
    notifGranted: false
  }, DB.get(DB.K.CFG, {}));
}
let cfg = getCfg();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIME UTILITIES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const t2m = s => { const [h,m] = s.split(':').map(Number); return h*60+m; };
const m2t = m => `${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;

function dateToStr(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function todayStr() { return dateToStr(new Date()); }
function dsToDate(ds) { return new Date(ds + 'T12:00:00'); }
function getMonday(off = 0) {
  const d = new Date(); d.setHours(12,0,0,0);
  const dow = d.getDay();
  d.setDate(d.getDate() + (dow===0?-6:1-dow) + off*7);
  d.setHours(0,0,0,0);
  return d;
}
function offStr(n) {
  const d = new Date(); d.setHours(12,0,0,0); d.setDate(d.getDate()+n); return dateToStr(d);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UNDO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveUndo(label) {
  undoSnap = { label, ts: Date.now(),
    tasks:    JSON.parse(JSON.stringify(tasks)),
    events:   JSON.parse(JSON.stringify(events)),
    schedule: JSON.parse(JSON.stringify(schedule))
  };
  DB.set(DB.K.UNDO, undoSnap);
  const btn = document.getElementById('btnUndo');
  btn.style.display = 'flex';
  btn.title = `HoÃ n tÃ¡c: ${label} (Ctrl+Z)`;
}
function applyUndo() {
  if (!undoSnap) { showToast('âš ï¸ KhÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ hoÃ n tÃ¡c!'); return; }
  if (!confirm(`HoÃ n tÃ¡c: "${undoSnap.label}"?`)) return;
  ({ tasks, events, schedule } = undoSnap);
  DB.set(DB.K.TASKS, tasks); DB.set(DB.K.EVENTS, events); DB.set(DB.K.SCHED, schedule);
  undoSnap = null; DB.set(DB.K.UNDO, null);
  document.getElementById('btnUndo').style.display = 'none';
  renderAll(); showToast('â†© ÄÃ£ hoÃ n tÃ¡c!');
}
document.addEventListener('keydown', e => {
  if ((e.ctrlKey||e.metaKey) && e.key==='z' && !e.shiftKey) { e.preventDefault(); applyUndo(); }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBJECT CLASSIFIER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SUBJECT_MAP = [
  [/\b(toÃ¡n|sá»‘ há»c|Ä‘áº¡i sá»‘|hÃ¬nh há»c|giáº£i tÃ­ch|tÃ­nh toÃ¡n|bÃ i toÃ¡n|Ä‘áº¡o hÃ m|tÃ­ch phÃ¢n)\b/i,  'ToÃ¡n','hard','#ef4444','ğŸ”¢'],
  [/\b(váº­t lÃ½|váº­t lÃ­|lÃ½|cÆ¡ há»c|Ä‘iá»‡n há»c|quang há»c|dao Ä‘á»™ng|sÃ³ng)\b/i,                    'Váº­t LÃ½','hard','#f97316','âš›ï¸'],
  [/\b(hÃ³a há»c|hoÃ¡ há»c|hÃ³a|hoÃ¡|pháº£n á»©ng|nguyÃªn tá»‘|há»¯u cÆ¡|vÃ´ cÆ¡|axit)\b/i,               'HÃ³a Há»c','hard','#8b5cf6','ğŸ§ª'],
  [/\b(tin há»c|láº­p trÃ¬nh|code|coding|thuáº­t toÃ¡n|python|java|html|css)\b/i,                'Tin Há»c','hard','#0ea5e9','ğŸ’»'],
  [/\b(tiáº¿ng anh|anh vÄƒn|english|tá»« vá»±ng|grammar|listening|speaking)\b/i,                 'Tiáº¿ng Anh','memory','#3b82f6','ğŸ‡¬ğŸ‡§'],
  [/\b(ngá»¯ vÄƒn|vÄƒn há»c|vÄƒn|viáº¿t vÄƒn|Ä‘á»c hiá»ƒu|táº­p lÃ m vÄƒn)\b/i,                           'Ngá»¯ VÄƒn','creative','#ec4899','âœï¸'],
  [/\b(lá»‹ch sá»­|sá»­|tháº¿ chiáº¿n|phong trÃ o|triá»u Ä‘áº¡i|cÃ¡ch máº¡ng)\b/i,                         'Lá»‹ch Sá»­','memory','#d97706','ğŸ“œ'],
  [/\b(Ä‘á»‹a lÃ½|Ä‘á»‹a|Ä‘á»‹a lÃ­|báº£n Ä‘á»“|khÃ­ háº­u|chÃ¢u lá»¥c)\b/i,                                  'Äá»‹a LÃ½','memory','#16a34a','ğŸ—ºï¸'],
  [/\b(sinh há»c|sinh|táº¿ bÃ o|di truyá»n|há»‡ sinh thÃ¡i|vi sinh)\b/i,                          'Sinh Há»c','memory','#10b981','ğŸŒ±'],
  [/\b(thá»ƒ dá»¥c|thá»ƒ thao|váº­n Ä‘á»™ng|cháº¡y|bÆ¡i|yoga|gym)\b/i,                                 'Thá»ƒ Dá»¥c','physical','#84cc16','ğŸƒ'],
];

function classifyTask(title, override='') {
  if (override) {
    const f = SUBJECT_MAP.find(([,s]) => s===override);
    if (f) return { subject:f[1], type:f[2], color:f[3], emoji:f[4] };
  }
  for (const [re, subject, type, color, emoji] of SUBJECT_MAP) {
    if (re.test(title)) return { subject, type, color, emoji };
  }
  if (/(Ã´n táº­p|Ã´n luyá»‡n|lÃ m bÃ i|bÃ i táº­p|kiá»ƒm tra)/.test(title.toLowerCase()))
    return { subject:'Chung', type:'hard', color:'#7c3aed', emoji:'ğŸ“–' };
  return { subject:'KhÃ¡c', type:'general', color:'#9ca3af', emoji:'âœï¸' };
}

const SUBJECTS_LIST = ['ToÃ¡n','Váº­t LÃ½','HÃ³a Há»c','Ngá»¯ VÄƒn','Tiáº¿ng Anh','Lá»‹ch Sá»­','Äá»‹a LÃ½','Sinh Há»c','Tin Há»c','Thá»ƒ Dá»¥c','KhÃ¡c'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SMART SCHEDULER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SCHED = {
  DAY_START: 6*60, DAY_END: 22*60,
  BUFFER: 15, BREAK_S: 5, BREAK_L: 15, MAX_CONT: 120,
  PREF_WIN: {
    hard:     [{from:6*60,  to:12*60}],
    creative: [{from:9*60,  to:12*60},{from:19*60,to:21*60}],
    memory:   [{from:7*60,  to:9*60}, {from:20*60,to:22*60}],
    physical: [{from:6*60,  to:8*60}, {from:16*60,to:18*60}],
    general:  [{from:6*60,  to:22*60}]
  }
};

function taskScore(t, ds) {
  let s = { high:300, med:200, low:100 }[t.pri] || 100;
  // Difficulty bonus
  s += { hard:80, med:40, easy:10 }[t.diff||'med'] || 40;
  // Deadline urgency
  const deadline = t.dateTo || '';
  if (deadline) {
    const diff = (new Date(deadline) - new Date(ds)) / 86400000;
    if (diff<0) s+=300; else if (diff<1) s+=200; else if (diff<3) s+=120; else if (diff<7) s+=60;
  }
  return s;
}

function freeSlots(occ, from, to, minLen=10) {
  const sorted = [...occ].sort((a,b) => a.start-b.start);
  const free = []; let cur = from;
  for (const s of sorted) {
    if (s.start > cur+minLen-1) free.push({start:cur, end:Math.min(s.start,to)});
    cur = Math.max(cur, s.end);
    if (cur >= to) break;
  }
  if (cur < to-minLen+1) free.push({start:cur, end:to});
  return free.filter(f => f.end-f.start >= minLen);
}

function findBestSlot(freeList, dur, prefWin) {
  if (prefWin) {
    for (const win of prefWin) {
      for (const f of freeList) {
        const ws = Math.max(f.start, win.from), we = Math.min(f.end, win.to);
        if (we-ws >= dur) return ws;
      }
    }
  }
  const fit = freeList.find(f => f.end-f.start >= dur);
  return fit ? fit.start : null;
}

function runScheduler() {
  const mode = document.getElementById('schedMode')?.value || 'hard-first';
  const newSched = {};
  const mon = getMonday(0);
  saveUndo('Xáº¿p lá»‹ch');

  for (let d = 0; d < 14; d++) {
    const date = new Date(mon); date.setDate(mon.getDate()+d);
    const ds = dateToStr(date), dow = date.getDay();
    const placed = [];

    // Place fixed events
    events.filter(e => e.type==='fixed' && e.repeat.includes(dow)).forEach(e => {
      placed.push({ name:e.name, start:t2m(e.start), end:t2m(e.end),
        kind:'ev-fix', pri:e.pri, color:e.color, done:false, locked:true });
    });
    // Place flex events
    events.filter(e => e.type==='flex' && e.repeat.includes(dow))
      .sort((a,b) => ({high:3,med:2,low:1}[b.pri]||1) - ({high:3,med:2,low:1}[a.pri]||1))
      .forEach(e => {
        const fr = freeSlots(placed, t2m(e.eStart), t2m(e.lEnd), e.dur);
        const pos = findBestSlot(fr, e.dur, null);
        if (pos !== null) placed.push({ name:e.name, start:pos, end:pos+e.dur, kind:'ev-flex', pri:e.pri, color:e.color, done:false });
      });
    placed.sort((a,b) => a.start-b.start);

    // Active tasks for this date range
    const activeTasks = tasks.filter(t => {
      if (t.done) return false;
      if (t.dateFrom && ds < t.dateFrom) return false;
      if (t.dateTo   && ds > t.dateTo)   return false;
      return true;
    }).map(t => ({ ...t, score:taskScore(t,ds), _cls:classifyTask(t.name, t.subjectOverride||'') }));

    // Sort by scheduling mode
    let ordered;
    if (mode === 'hard-first') {
      ordered = [...activeTasks].sort((a,b) => {
        const dScore = {hard:3,med:2,easy:1};
        const da = dScore[a.diff||'med']||2, db = dScore[b.diff||'med']||2;
        return (db-da) || (b.score-a.score);
      });
    } else if (mode === 'interleave') {
      const hard = activeTasks.filter(t => (t.diff||'med')==='hard').sort((a,b)=>b.score-a.score);
      const easy = activeTasks.filter(t => (t.diff||'med')!=='hard').sort((a,b)=>b.score-a.score);
      ordered = []; let hi=0, ei=0;
      while (hi<hard.length||ei<easy.length) {
        if (hi<hard.length) ordered.push(hard[hi++]);
        if (ei<easy.length) ordered.push(easy[ei++]);
      }
    } else {
      ordered = [...activeTasks].sort((a,b) => b.score-a.score);
    }

    let contMin = 0;
    for (const t of ordered) {
      // Force break if over continuous limit
      if (contMin >= SCHED.MAX_CONT && cfg.pomodoro) {
        const br = freeSlots(placed, SCHED.DAY_START, SCHED.DAY_END, SCHED.BREAK_L);
        if (br.length) {
          placed.push({ name:'ğŸ§˜ Nghá»‰ dÃ i', start:br[0].start, end:br[0].start+SCHED.BREAK_L, kind:'buffer', color:'#9ca3af', done:false });
          placed.sort((a,b) => a.start-b.start); contMin = 0;
        }
      }
      const pref = t.pref && t.pref!=='auto'
        ? [{ morning:{from:6*60,to:12*60}, afternoon:{from:12*60,to:18*60}, evening:{from:18*60,to:22*60} }[t.pref]].filter(Boolean)
        : (cfg.hardMorning && (t.diff||'med')==='hard' ? SCHED.PREF_WIN.hard : SCHED.PREF_WIN[t._cls.type]||SCHED.PREF_WIN.general);
      const fr = freeSlots(placed, SCHED.DAY_START, SCHED.DAY_END, t.dur);
      const pos = findBestSlot(fr, t.dur, pref);
      if (pos === null) continue;
      placed.push({
        name:t.name, start:pos, end:pos+t.dur, kind:'task',
        pri:t.pri, diff:t.diff||'med', color:t._cls.color,
        taskId:t.id, done:t.done||false, locked:false,
        tag:t._cls.subject, dateFrom:t.dateFrom||'', dateTo:t.dateTo||'',
        note:t.note||'', subjectOverride:t.subjectOverride||'',
        tip:`${m2t(pos)}â€“${m2t(pos+t.dur)} | ${t.dur}p | ${t._cls.emoji} ${t._cls.subject}`
      });
      placed.sort((a,b) => a.start-b.start);
      contMin += t.dur;
      // Pomodoro break
      if (cfg.pomodoro && t._cls.type!=='physical' && t.dur>=25) {
        const bf = freeSlots(placed, SCHED.DAY_START, SCHED.DAY_END, SCHED.BREAK_S);
        if (bf.length && bf[0].end-bf[0].start >= SCHED.BREAK_S) {
          placed.push({ name:'â˜• Pomodoro', start:bf[0].start, end:bf[0].start+SCHED.BREAK_S, kind:'buffer', color:'#6b7280', done:false });
          placed.sort((a,b) => a.start-b.start);
        }
      }
    }
    newSched[ds] = placed;
  }
  schedule = newSched; DB.set(DB.K.SCHED, schedule);
  renderCalendar();
  if (tlDate) renderTimeline(tlDate, dsToDate(tlDate));
  scheduleNotifications();
  showToast(`âš¡ ÄÃ£ xáº¿p lá»‹ch (${mode})!`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function requestNotif() {
  if (!('Notification' in window)) { showToast('âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ thÃ´ng bÃ¡o!'); return; }
  Notification.requestPermission().then(p => {
    cfg.notifGranted = p === 'granted'; DB.set(DB.K.CFG, cfg);
    document.getElementById('notifBanner').classList.remove('show');
    updateNotifStatus();
    if (p === 'granted') { showToast('ğŸ”” ÄÃ£ báº­t thÃ´ng bÃ¡o!'); scheduleNotifications(); }
    else showToast('âš ï¸ ChÆ°a Ä‘Æ°á»£c cáº¥p quyá»n thÃ´ng bÃ¡o.');
  });
}

function updateNotifStatus() {
  const el = document.getElementById('notifStatus'); if (!el) return;
  const p = Notification.permission;
  el.textContent = p==='granted' ? 'âœ… ÄÃ£ báº­t thÃ´ng bÃ¡o' : p==='denied' ? 'âŒ Bá»‹ tá»« chá»‘i â€“ vÃ o cÃ i Ä‘áº·t trÃ¬nh duyá»‡t Ä‘á»ƒ báº­t' : 'âš ï¸ ChÆ°a cáº¥p quyá»n';
  el.style.color = p==='granted' ? 'var(--grn)' : p==='denied' ? 'var(--red)' : 'var(--yel)';
}

function sendNotif(title, body) {
  if (Notification.permission !== 'granted') return;
  try { new Notification(title, { body, icon:'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>' }); } catch(e) {}
}

function scheduleNotifications() {
  if (notifTimer) clearInterval(notifTimer);
  if (Notification.permission !== 'granted') return;
  // Check every minute
  notifTimer = setInterval(() => {
    const now = new Date();
    const hm  = now.getHours()*60 + now.getMinutes();
    const ds  = todayStr();
    const slots = (schedule[ds]||[]).filter(s => s.kind!=='buffer');
    slots.forEach(s => {
      const diff = s.start - hm;
      if (diff===15) sendNotif(`â° Sáº¯p Ä‘áº¿n giá»: ${s.name}`, `CÃ²n 15 phÃºt â€“ ${m2t(s.start)} â†’ ${m2t(s.end)}`);
      if (diff===0)  sendNotif(`ğŸ”” Báº¯t Ä‘áº§u: ${s.name}`, `${m2t(s.start)} â€“ ${m2t(s.end)}`);
    });
    // Deadline check
    tasks.filter(t => !t.done && t.dateTo).forEach(t => {
      const daysLeft = (new Date(t.dateTo) - new Date(todayStr())) / 86400000;
      const h = now.getHours(), m2 = now.getMinutes();
      if (daysLeft <= 1 && h===8 && m2===0) sendNotif(`ğŸš¨ Deadline sáº¯p tá»›i!`, `"${t.name}" háº¡n ${t.dateTo}`);
    });
  }, 60000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function chgWeek(d, mode) { weekOff = mode==='today' ? 0 : weekOff+d; renderCalendar(); }

function renderCalendar() {
  const mon = getMonday(weekOff), today = todayStr();
  const end = new Date(mon); end.setDate(mon.getDate()+6);
  document.getElementById('wkLbl').textContent =
    `${mon.getDate()}/${mon.getMonth()+1} â€“ ${end.getDate()}/${end.getMonth()+1}/${mon.getFullYear()}`;
  const grid = document.getElementById('weekGrid'); grid.innerHTML = '';

  for (let d = 0; d < 7; d++) {
    const date = new Date(mon); date.setDate(mon.getDate()+d);
    const ds = dateToStr(date);
    const evs = schedule[ds] || [];
    const main = evs.filter(e => e.kind!=='buffer');
    const taskDone = main.filter(e => e.kind==='task'&&e.done).length;
    const taskTot  = main.filter(e => e.kind==='task').length;

    const col = document.createElement('div');
    col.className = 'dc' + (ds===today?' today':'') + (ds===tlDate?' selected':'');
    col.onclick = () => selectDay(ds, date);
    col.innerHTML = `<div class="dh">${DAY_VI[date.getDay()]}</div><div class="dd">${date.getDate()}</div>`;

    if (taskTot > 0) {
      const pb = document.createElement('div');
      pb.style.cssText = 'height:3px;border-radius:99px;background:var(--brd);margin-bottom:3px;overflow:hidden;flex-shrink:0';
      pb.innerHTML = `<div style="height:100%;border-radius:99px;background:var(--grn);width:${Math.round(taskDone/taskTot*100)}%"></div>`;
      col.appendChild(pb);
    }
    if (!main.length) {
      const ph = document.createElement('div');
      ph.style.cssText = 'font-size:.63rem;color:var(--txt2);text-align:center;padding:6px 0;opacity:.5;margin-top:auto';
      ph.textContent = '( Trá»‘ng )';
      col.appendChild(ph);
    } else {
      main.slice(0,5).forEach(s => {
        const {emoji=''} = s.kind==='task' ? classifyTask(s.name,s.subjectOverride||'') : {};
        const bl = document.createElement('div');
        bl.className = 'ce' + (s.done?' done':'');
        bl.style.cssText = `background:${s.color}22;color:${s.color};border-left-color:${s.color}`;
        bl.innerHTML = `<span class="ce-time">${m2t(s.start)}</span><span class="ce-name">${emoji?emoji+' ':''}${s.name}</span>`;
        col.appendChild(bl);
      });
      if (main.length > 5) {
        const more = document.createElement('div');
        more.style.cssText = 'font-size:.6rem;color:var(--txt2);text-align:center;margin-top:2px';
        more.textContent = `+${main.length-5} ná»¯aâ€¦`;
        col.appendChild(more);
      }
    }
    grid.appendChild(col);
  }
}

function selectDay(ds, dateObj) {
  tlDate = ds; renderCalendar();
  document.getElementById('tl-placeholder').style.display = 'none';
  document.getElementById('tl-body').style.display = 'block';
  renderTimeline(ds, dateObj);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMELINE RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PX=1.5, TLS=5, TLE=24;
let nowTimer = null;

function updateNowLine() {
  const line = document.getElementById('tl-now-line');
  const lbl  = document.getElementById('nowLbl');
  if (!tlDate || tlDate !== todayStr()) { line.style.display='none'; return; }
  const now = new Date(), nm = now.getHours()*60+now.getMinutes();
  if (nm<TLS*60||nm>=TLE*60) { line.style.display='none'; return; }
  line.style.top = ((nm-TLS*60)*PX)+'px';
  line.style.display = 'block';
  lbl.textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
}

function renderTimeline(ds, dateObj) {
  document.getElementById('tlTitle').textContent =
    `${DAY_FULL[dateObj.getDay()]}, ${dateObj.getDate()}/${dateObj.getMonth()+1}/${dateObj.getFullYear()}`;
  const inner = document.getElementById('tl-inner');
  inner.style.height = ((TLE-TLS)*60*PX)+'px';
  [...inner.children].forEach(c => { if (c.id!=='tl-now-line') c.remove(); });

  for (let h=TLS; h<=TLE; h++) {
    const top = (h-TLS)*60*PX;
    const lbl = document.createElement('div');
    lbl.className='tl-hour'; lbl.style.top=(top-8)+'px'; lbl.textContent=h<24?h+':00':'';
    inner.appendChild(lbl);
    const ln = document.createElement('div');
    ln.className='tl-line'; ln.style.top=top+'px'; inner.appendChild(ln);
    if (h < TLE) {
      const ln2 = document.createElement('div');
      ln2.className='tl-line-half'; ln2.style.top=(top+30*PX)+'px'; inner.appendChild(ln2);
    }
  }

  // Conflict detect
  const evs = (schedule[ds]||[]).filter(e=>e.kind!=='buffer');
  const cf = new Set();
  for (let i=0;i<evs.length;i++) for (let j=i+1;j<evs.length;j++) {
    if (evs[i].start<evs[j].end && evs[i].end>evs[j].start) { cf.add(evs[i].name); cf.add(evs[j].name); }
  }
  const banner = document.getElementById('conflictBanner');
  if (cf.size) { document.getElementById('conflictMsg').textContent=`TrÃ¹ng giá»: ${[...cf].join(', ')}`; banner.classList.add('show'); }
  else banner.classList.remove('show');

  (schedule[ds]||[]).forEach((s,i) => {
    if (s.start<TLS*60||s.end>TLE*60) return;
    const top=(s.start-TLS*60)*PX, ht=Math.max((s.end-s.start)*PX-2,22);
    const el=document.createElement('div');
    el.className='tl-slot'+(s.done?' done':'')+(cf.has(s.name)?' conflict':'');
    el.style.cssText=`top:${top}px;height:${ht}px;background:${s.color};color:#fff;z-index:5`;
    const {emoji=''}=s.kind==='task'?classifyTask(s.name,s.subjectOverride||''):{};
    const diffLbl=s.diff?({hard:'ğŸ”´',med:'ğŸŸ¡',easy:'ğŸŸ¢'}[s.diff]||''):'';
    el.innerHTML=`<div class="ts-time">${m2t(s.start)}â€“${m2t(s.end)}</div>
      <div class="ts-name">${emoji?emoji+' ':''}${s.name} ${diffLbl}</div>
      ${s.tag?`<div class="ts-sub">${s.tag}</div>`:''}`;
    if (s.kind==='task') {
      const cb=document.createElement('input');
      cb.type='checkbox'; cb.checked=s.done; cb.className='ts-cb';
      cb.onchange=e=>{e.stopPropagation();toggleDone(ds,i)};
      el.appendChild(cb);
      el.onclick=e=>{if(e.target.type!=='checkbox')openEditSlot(ds,i)};
    } else if (s.kind!=='buffer') el.onclick=()=>openEditSlot(ds,i);
    inner.appendChild(el);
  });

  if (nowTimer) clearInterval(nowTimer);
  updateNowLine();
  nowTimer = setInterval(updateNowLine, 30000);
}

function toggleDone(ds, i) {
  if (!schedule[ds]?.[i]) return;
  schedule[ds][i].done = !schedule[ds][i].done;
  const tid = schedule[ds][i].taskId;
  if (tid) { const t=tasks.find(t=>t.id===tid); if(t){t.done=schedule[ds][i].done;DB.set(DB.K.TASKS,tasks);} }
  DB.set(DB.K.SCHED, schedule); renderTimeline(ds, dsToDate(ds)); renderCalendar();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EVENTS CRUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addEvent() {
  const name = document.getElementById('ev_n').value.trim(); if (!name){alert('Nháº­p tÃªn!');return;}
  const days  = [...document.querySelectorAll('.dchip.on')].map(d => +d.dataset.day);
  const color = document.querySelector('.copt.on')?.dataset.color || COLORS[0];
  const type  = document.getElementById('ev_t').value;
  let ev = { id:Date.now(), name, type, repeat:days, pri:document.getElementById('ev_p').value, color };
  if (type==='fixed') { ev.start=document.getElementById('ev_s').value; ev.end=document.getElementById('ev_e').value; }
  else { ev.eStart=document.getElementById('ev_es').value; ev.lEnd=document.getElementById('ev_le').value; ev.dur=+document.getElementById('ev_fd').value; }
  saveUndo('ThÃªm sá»± kiá»‡n');
  events.push(ev); DB.set(DB.K.EVENTS, events); renderEvents();
  document.getElementById('ev_n').value = '';
  showToast('âœ… ÄÃ£ thÃªm sá»± kiá»‡n!');
}

function delEvent(id) {
  if (!confirm('XÃ³a sá»± kiá»‡n nÃ y?')) return;
  saveUndo('XÃ³a sá»± kiá»‡n');
  events = events.filter(e => e.id!==id); DB.set(DB.K.EVENTS, events); renderEvents();
}

function toggleFlex() {
  const flex = document.getElementById('ev_t').value==='flex';
  document.getElementById('ui_fix').style.display  = flex?'none':'block';
  document.getElementById('ui_flex').style.display = flex?'block':'none';
}

function renderEvents() {
  const cnt = document.getElementById('evCount'); if(cnt) cnt.textContent=events.length;
  const el  = document.getElementById('evList');
  if (!events.length) { el.innerHTML='<p style="color:var(--txt2);text-align:center;padding:18px">ChÆ°a cÃ³ sá»± kiá»‡n.</p>'; return; }
  el.innerHTML = events.map(e => `
    <div class="li">
      <div class="dot" style="background:${e.color}"></div>
      <div class="n">${e.name}</div>
      <span style="font-size:.7rem;color:var(--txt2)">${e.type==='fixed'?e.start+'â€“'+e.end:e.eStart+'â†’'+e.lEnd}</span>
      <button class="btn br sm" onclick="delEvent(${e.id})">âœ•</button>
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASKS CRUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addTask() {
  const name = document.getElementById('tk_n').value.trim(); if (!name){alert('Nháº­p tÃªn!');return;}
  const { subject, color } = classifyTask(name, selSubj||'');
  const t = {
    id:Date.now(), name,
    dur:+document.getElementById('tk_d').value||60,
    pri:selPri, diff:selDiff,
    dateFrom:document.getElementById('tk_dfrom').value,
    dateTo:document.getElementById('tk_dto').value,
    pref:document.getElementById('tk_pref').value,
    note:document.getElementById('tk_note').value.trim(),
    subject:selSubj||subject, color, subjectOverride:selSubj||'', done:false
  };
  saveUndo('ThÃªm task');
  tasks.push(t); DB.set(DB.K.TASKS, tasks); renderTasks();
  document.getElementById('tk_n').value='';
  document.getElementById('tk_note').value='';
  document.getElementById('subjectAutoLabel').textContent='';
  selSubj=''; selectSubject(''); selectPri('med'); selectDiff('med');
  showToast('âœ… ÄÃ£ thÃªm cÃ´ng viá»‡c!');
}

function toggleTask(id) { const t=tasks.find(t=>t.id===id); if(t){t.done=!t.done;DB.set(DB.K.TASKS,tasks);renderTasks();} }
function delTask(id) { if(!confirm('XÃ³a?'))return; saveUndo('XÃ³a task'); tasks=tasks.filter(t=>t.id!==id); DB.set(DB.K.TASKS,tasks);renderTasks(); }
function clearDone() { saveUndo('XÃ³a Ä‘Ã£ xong'); tasks=tasks.filter(t=>!t.done); DB.set(DB.K.TASKS,tasks);renderTasks();showToast('ğŸ—‘ï¸ XÃ³a xong!'); }

function renderTasks() {
  const cnt=document.getElementById('tkCount'); if(cnt) cnt.textContent=tasks.length;
  const el=document.getElementById('tkList');
  if (!tasks.length) { el.innerHTML='<p style="color:var(--txt2);text-align:center;padding:18px">ChÆ°a cÃ³ cÃ´ng viá»‡c.</p>'; return; }
  const dMap={high:'bh',med:'bm',low:'bl'},dLbl={high:'ğŸ”´ Cao',med:'ğŸŸ¡ TB',low:'ğŸŸ¢ Tháº¥p'};
  const diffLbl={hard:'ğŸ”´ KhÃ³',med:'ğŸŸ¡ TB',easy:'ğŸŸ¢ Dá»…'};
  el.innerHTML=tasks.map(t=>{
    const {emoji=''} = classifyTask(t.name,t.subjectOverride||'');
    const dateRange = (t.dateFrom||t.dateTo)?`ğŸ“… ${t.dateFrom||'âˆ'} â†’ ${t.dateTo||'âˆ'}`:'';
    const daysLeft  = t.dateTo ? Math.ceil((new Date(t.dateTo)-new Date(todayStr()))/86400000) : null;
    const urgency   = daysLeft!==null && daysLeft<=3 ? `<span class="badge bh">âš ï¸ ${daysLeft<=0?'Háº¿t háº¡n!':daysLeft+'ngÃ y'}</span>` : '';
    return `<div class="li" style="${t.done?'opacity:.45':''}">
      <input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" style="width:14px;height:14px;accent-color:var(--pri);flex-shrink:0"/>
      <div class="n" style="${t.done?'text-decoration:line-through':''}">
        <span style="font-size:.8rem">${emoji} ${t.name}</span><br>
        <span style="font-size:.65rem;color:var(--txt2)">${t.subject||''} Â· ${diffLbl[t.diff||'med']} ${dateRange?'Â· '+dateRange:''}</span>
      </div>
      ${urgency}
      <span class="badge ${dMap[t.pri]}">${dLbl[t.pri]}</span>
      <span style="font-size:.68rem;color:var(--txt2)">â±${t.dur}p</span>
      <button class="btn bgh sm" onclick="openEditTask(${t.id})">âœï¸</button>
      <button class="btn br sm" onclick="delTask(${t.id})">âœ•</button>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDIT MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openEditSlot(ds, idx) {
  const s = schedule[ds]?.[idx]; if(!s)return;
  editCtx = { mode:'slot', ds, idx };
  _fillModal(s.kind==='task'?'âœï¸ Chá»‰nh sá»­a task':'âœï¸ Chá»‰nh sá»­a sá»± kiá»‡n',
    s.name, m2t(s.start), m2t(s.end), s.pri||'med', s.end-s.start, s.tag||'', s.dateFrom||'', s.dateTo||'', s.note||'');
}
function openEditTask(tid) {
  const t = tasks.find(t=>t.id===tid); if(!t)return;
  editCtx = { mode:'task', taskId:tid };
  _fillModal('âœï¸ Chá»‰nh sá»­a cÃ´ng viá»‡c', t.name,'08:00','09:00',t.pri,t.dur,t.subject||'',t.dateFrom||'',t.dateTo||'',t.note||'');
}
function openEditNew() {
  if (!tlDate){showToast('âš ï¸ Chá»n ngÃ y trÆ°á»›c!');return;}
  editCtx = { mode:'new', ds:tlDate };
  _fillModal('â• ThÃªm vÃ o ngÃ y','','08:00','09:00','med',60,'','','','');
}
function _fillModal(title,name,start,end,pri,dur,tag,dateFrom,dateTo,note) {
  document.getElementById('editTitle').textContent=title;
  document.getElementById('e_name').value=name;
  document.getElementById('e_start').value=start;
  document.getElementById('e_end').value=end;
  document.getElementById('e_pri').value=pri;
  document.getElementById('e_dur').value=dur;
  document.getElementById('e_tag').value=tag;
  document.getElementById('e_dfrom').value=dateFrom;
  document.getElementById('e_dto').value=dateTo;
  document.getElementById('e_note').value=note;
  document.getElementById('editModal').classList.add('open');
}
function saveEdit() {
  if (!editCtx) return;
  const {mode,ds,idx,taskId}=editCtx;
  if (mode==='task') {
    const t=tasks.find(t=>t.id===taskId); if(!t)return;
    saveUndo('Sá»­a task');
    t.name=document.getElementById('e_name').value.trim()||t.name;
    t.pri=document.getElementById('e_pri').value;
    t.dur=+document.getElementById('e_dur').value||t.dur;
    t.dateFrom=document.getElementById('e_dfrom').value;
    t.dateTo=document.getElementById('e_dto').value;
    t.note=document.getElementById('e_note').value.trim();
    const {color,subject}=classifyTask(t.name);
    t.color=color; t.subject=subject;
    DB.set(DB.K.TASKS,tasks); closeEdit(); renderTasks(); showToast('âœ… ÄÃ£ lÆ°u!'); return;
  }
  const ns=t2m(document.getElementById('e_start').value), ne=t2m(document.getElementById('e_end').value);
  if (ne<=ns){alert('Giá» káº¿t thÃºc pháº£i sau giá» báº¯t Ä‘áº§u!');return;}
  saveUndo('Sá»­a slot');
  const u={name:document.getElementById('e_name').value.trim()||'Task',start:ns,end:ne,
    pri:document.getElementById('e_pri').value,tag:document.getElementById('e_tag').value.trim(),
    dateFrom:document.getElementById('e_dfrom').value,dateTo:document.getElementById('e_dto').value,
    note:document.getElementById('e_note').value.trim(),
    color:{high:'#ef4444',med:'#f59e0b',low:'#10b981'}[document.getElementById('e_pri').value]};
  if (!schedule[ds]) schedule[ds]=[];
  if (mode==='new') schedule[ds].push({...u,kind:'task',done:false,locked:false});
  else schedule[ds][idx]={...schedule[ds][idx],...u};
  schedule[ds].sort((a,b)=>a.start-b.start); DB.set(DB.K.SCHED,schedule);
  closeEdit(); renderTimeline(ds,dsToDate(ds)); renderCalendar(); showToast('âœ… ÄÃ£ lÆ°u!');
}
function deleteEditTarget() {
  if (!editCtx) return;
  const {mode,ds,idx,taskId}=editCtx;
  if (mode==='task') {
    if(!confirm('XÃ³a?'))return; saveUndo('XÃ³a task');
    tasks=tasks.filter(t=>t.id!==taskId); DB.set(DB.K.TASKS,tasks); closeEdit(); renderTasks(); showToast('ğŸ—‘ï¸ ÄÃ£ xÃ³a!'); return;
  }
  if(!confirm(`XÃ³a "${schedule[ds]?.[idx]?.name}"?`))return; saveUndo('XÃ³a slot');
  schedule[ds].splice(idx,1); DB.set(DB.K.SCHED,schedule);
  closeEdit(); renderTimeline(ds,dsToDate(ds)); renderCalendar(); showToast('ğŸ—‘ï¸ ÄÃ£ xÃ³a!');
}
function closeEdit(){ document.getElementById('editModal').classList.remove('open'); editCtx=null; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FAKE AI ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FAKE_AI = (() => {
  const TIPS = [
    'ğŸ… <b>Pomodoro:</b> Há»c 25 phÃºt, nghá»‰ 5 phÃºt. NÃ£o cáº§n chu ká»³ Ä‘á»ƒ xá»­ lÃ½ thÃ´ng tin!',
    'ğŸ§  <b>Active Recall:</b> Thay vÃ¬ Ä‘á»c láº¡i, tá»± Ä‘áº·t cÃ¢u há»i rá»“i tráº£ lá»i â€“ nhá»› lÃ¢u hÆ¡n 70%.',
    'ğŸ“… <b>Spaced Repetition:</b> Ã”n láº¡i sau 1 ngÃ y â†’ 3 ngÃ y â†’ 1 tuáº§n â†’ 1 thÃ¡ng.',
    'âœï¸ <b>Feynman Technique:</b> Giáº£i thÃ­ch khÃ¡i niá»‡m nhÆ° Ä‘ang dáº¡y ngÆ°á»i khÃ¡c â€“ náº¿u khÃ´ng giáº£i thÃ­ch Ä‘Æ°á»£c, báº¡n chÆ°a thá»±c sá»± hiá»ƒu.',
    'ğŸŒ™ <b>Ngá»§ Ä‘á»§ 7-8 tiáº¿ng:</b> NÃ£o cá»§ng cá»‘ kÃ½ á»©c trong khi ngá»§. Thá»©c khuya há»c sáº½ kÃ©m hiá»‡u quáº£!',
    'ğŸ”„ <b>Interleaving:</b> Xen káº½ ToÃ¡n â†’ VÄƒn â†’ Anh thay vÃ¬ há»c cÃ¹ng 1 mÃ´n liÃªn tá»¥c 3 tiáº¿ng.',
    'ğŸ’¡ <b>MÃ´n khÃ³ buá»•i sÃ¡ng:</b> NÄƒng lÆ°á»£ng vÃ  sá»± táº­p trung cao nháº¥t tá»« 7hâ€“11h. DÃ nh cho ToÃ¡n, LÃ½, HÃ³a.',
  ];

  function analyzeSchedule(ds) {
    const slots = (schedule[ds]||[]).filter(e=>e.kind!=='buffer');
    const tasks  = slots.filter(e=>e.kind==='task');
    const done   = tasks.filter(t=>t.done).length;
    const total  = tasks.length;
    const mins   = tasks.reduce((s,t)=>s+(t.end-t.start),0);
    return { slots, tasks, done, total, mins, ds };
  }

  function deadlineAlert() {
    const urgent = tasks.filter(t => {
      if (t.done || !t.dateTo) return false;
      const d = Math.ceil((new Date(t.dateTo) - new Date(todayStr())) / 86400000);
      return d <= 3;
    }).sort((a,b) => a.dateTo.localeCompare(b.dateTo));
    if (!urgent.length) return null;
    return 'âš ï¸ <b>Deadline sáº¯p tá»›i:</b><br>' + urgent.map(t => {
      const d = Math.ceil((new Date(t.dateTo) - new Date(todayStr())) / 86400000);
      return `â€¢ <b>${t.name}</b> â€“ ${d<=0?'<span style="color:var(--red)">Háº¾T Háº N!</span>':`cÃ²n ${d} ngÃ y`} (${t.dateTo})`;
    }).join('<br>');
  }

  function respond(text) {
    const t = text.toLowerCase().trim();

    // View schedule
    if (/(hÃ´m nay|ngÃ y mai|lá»‹ch|cÃ³ gÃ¬|cáº§n lÃ m)/.test(t)) {
      const ds = /ngÃ y mai|mai\b/.test(t) ? offStr(1) : todayStr();
      const { slots, done, total, mins } = analyzeSchedule(ds);
      const label = ds===todayStr() ? 'HÃ´m nay' : 'NgÃ y mai';
      if (!total) return `ğŸ“… <b>${label}</b> chÆ°a cÃ³ lá»‹ch há»c. HÃ£y thÃªm cÃ´ng viá»‡c vÃ  nháº¥n âš¡ Xáº¿p lá»‹ch!`;
      const pct = Math.round(done/total*100);
      let reply = `ğŸ“… <b>${label}</b> â€“ ${done}/${total} task hoÃ n thÃ nh (${pct}%) Â· ${Math.round(mins/60*10)/10}h há»c<br><br>`;
      reply += slots.filter(s=>s.kind!=='buffer').map(s=>`â€¢ ${m2t(s.start)}â€“${m2t(s.end)}: ${s.name}${s.done?' âœ…':''}`).join('<br>');
      return reply;
    }

    // Deadline alert
    if (/(deadline|háº¡n|sáº¯p thi|háº¡n chÃ³t)/.test(t)) {
      return deadlineAlert() || 'âœ… Tuyá»‡t vá»i! Hiá»‡n táº¡i khÃ´ng cÃ³ deadline nÃ o trong 3 ngÃ y tá»›i.';
    }

    // Add task via chat
    if (/(thÃªm|táº¡o|lÃªn lá»‹ch)/.test(t)) {
      const durMatch = text.match(/(\d+)\s*(phÃºt|p\b|tiáº¿ng)/i);
      const dur = durMatch ? (durMatch[2]==='tiáº¿ng'?+durMatch[1]*60:+durMatch[1]) : 60;
      const nameClean = text.replace(/^.*(thÃªm|táº¡o|lÃªn lá»‹ch)\s*/i,'').replace(/\s*\d+\s*(phÃºt|p\b|tiáº¿ng).*/i,'').trim();
      if (nameClean) {
        const {color,subject}=classifyTask(nameClean);
        saveUndo('ThÃªm task qua chat');
        tasks.push({id:Date.now(),name:nameClean,dur,pri:'med',diff:'med',
          dateFrom:todayStr(),dateTo:offStr(7),pref:'auto',
          subject,color,subjectOverride:'',done:false,note:''});
        DB.set(DB.K.TASKS,tasks); renderTasks(); runScheduler();
        return `âœ… ÄÃ£ thÃªm: <b>${nameClean}</b> (${dur} phÃºt) vÃ  xáº¿p lá»‹ch tá»± Ä‘á»™ng!`;
      }
    }

    // Hard first suggestion
    if (/(khÃ³|sáº¯p xáº¿p|tá»‘i Æ°u|Æ°u tiÃªn|mÃ´n khÃ³)/.test(t)) {
      const hardTasks = tasks.filter(t=>!t.done&&(t.diff||'med')==='hard');
      if (!hardTasks.length) return 'ğŸ’¡ Hiá»‡n táº¡i khÃ´ng cÃ³ cÃ´ng viá»‡c nÃ o Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u lÃ  "KhÃ³". HÃ£y thÃªm cÃ´ng viá»‡c vÃ  chá»n Ä‘á»™ khÃ³.';
      return `ğŸ¯ <b>Gá»£i Ã½ xáº¿p lá»‹ch mÃ´n khÃ³:</b><br><br>CÃ¡c mÃ´n cáº§n Æ°u tiÃªn:<br>` +
        hardTasks.map(t=>`â€¢ ğŸ”´ <b>${t.name}</b> (${t.dur}p) â€“ háº¡n ${t.dateTo||'khÃ´ng giá»›i háº¡n'}`).join('<br>') +
        `<br><br>ğŸ’¡ Chá»n cháº¿ Ä‘á»™ <b>"ğŸ”´ KhÃ³ trÆ°á»›c"</b> trong tab CÃ´ng viá»‡c vÃ  nháº¥n âš¡ Xáº¿p lá»‹ch.`;
    }

    // Reduce load
    if (/(má»‡t|giáº£m|quÃ¡ táº£i|nháº¹ hÆ¡n)/.test(t)) {
      let cnt=0;
      tasks.forEach(t=>{if(t.pri==='high'&&!t.done){t.pri='med';cnt++;}});
      DB.set(DB.K.TASKS,tasks); renderTasks();
      return `ğŸ˜Œ ÄÃ£ giáº£m Æ°u tiÃªn ${cnt} task xuá»‘ng má»©c Trung bÃ¬nh. Nghá»‰ ngÆ¡i vÃ  náº¡p láº¡i nÄƒng lÆ°á»£ng nhÃ©! ğŸ’™`;
    }

    // Stats
    if (/(thá»‘ng kÃª|tuáº§n nÃ y|hiá»‡u suáº¥t)/.test(t)) {
      const mon=getMonday(0);
      let totalMins=0, totalDone=0, totalTasks=0;
      for(let d=0;d<7;d++){
        const date=new Date(mon);date.setDate(mon.getDate()+d);
        const ds=dateToStr(date);
        const ts=(schedule[ds]||[]).filter(s=>s.kind==='task');
        totalMins+=ts.reduce((s,t)=>s+(t.end-t.start),0);
        totalDone+=ts.filter(t=>t.done).length;
        totalTasks+=ts.length;
      }
      return `ğŸ“Š <b>Thá»‘ng kÃª tuáº§n nÃ y:</b><br>
â€¢ Tá»•ng task: <b>${totalTasks}</b><br>
â€¢ ÄÃ£ hoÃ n thÃ nh: <b>${totalDone}</b> (${totalTasks?Math.round(totalDone/totalTasks*100):0}%)<br>
â€¢ Tá»•ng giá» há»c: <b>${Math.round(totalMins/60*10)/10}h</b><br>
â€¢ Trung bÃ¬nh/ngÃ y: <b>${Math.round(totalMins/7/60*10)/10}h</b>`;
    }

    // Tips
    if (/(lá»i khuyÃªn|máº¹o|há»c tá»‘t|pomodoro|cÃ¡ch há»c)/.test(t))
      return `ğŸ’¡ ${TIPS[Math.floor(Math.random()*TIPS.length)]}`;

    // App info
    if (/(báº¡n lÃ  ai|em lÃ  ai|planner)/.test(t))
      return 'ğŸ“š MÃ¬nh lÃ  <b>Smart Student Planner AI</b> â€“ trá»£ lÃ½ lá»‹ch há»c thÃ´ng minh. DÃ¹ng cháº¿ Ä‘á»™ <b>Fake AI</b> (offline) hoáº·c <b>Gemini AI</b> Ä‘á»ƒ trÃ² chuyá»‡n!';

    // Deadline check triggered automatically
    const alert = deadlineAlert();
    if (alert) return alert + '<br><br>ğŸ’¬ Há»i mÃ¬nh thÃªm: "Lá»‹ch hÃ´m nay?", "Lá»i khuyÃªn há»c táº­p", "ThÃªm bÃ i ToÃ¡n 60 phÃºt"â€¦';

    return `ğŸ¤– MÃ¬nh hiá»ƒu báº¡n Ä‘ang há»i vá» lá»‹ch há»c. HÃ£y thá»­:<br>
â€¢ "HÃ´m nay tÃ´i cÃ³ gÃ¬?"<br>
â€¢ "ThÃªm bÃ i ToÃ¡n 60 phÃºt"<br>
â€¢ "Deadline sáº¯p tá»›i?"<br>
â€¢ "Lá»i khuyÃªn há»c táº­p"<br>
â€¢ "Sáº¯p xáº¿p mÃ´n khÃ³ trÆ°á»›c"`;
  }

  return { respond };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GEMINI AI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callGemini(userMsg) {
  const key = DB.get(DB.K.APIKEY, '') || '';
  if (!key) return null;

  const systemCtx = (() => {
    const ds=todayStr(), dt=dsToDate(ds);
    const todayEvs=(schedule[ds]||[]).filter(e=>e.kind!=='buffer').slice(0,5).map(e=>`${m2t(e.start)}: ${e.name}`).join(', ')||'trá»‘ng';
    const pending=tasks.filter(t=>!t.done).slice(0,5).map(t=>`${t.name}(${t.dur}p,háº¡n:${t.dateTo||'âˆ'})`).join(', ')||'khÃ´ng cÃ³';
    const urgentDL=tasks.filter(t=>!t.done&&t.dateTo&&Math.ceil((new Date(t.dateTo)-new Date(todayStr()))/86400000)<=3).length;
    return `Báº¡n lÃ  trá»£ lÃ½ lá»‹ch há»c thÃ´ng minh tÃªn Smart Student Planner AI. HÃ´m nay ${DAY_FULL[dt.getDay()]} ${ds}. Lá»‹ch hÃ´m nay: ${todayEvs}. CÃ´ng viá»‡c chá»: ${pending}. Deadline trong 3 ngÃ y: ${urgentDL}. Tráº£ lá»i báº±ng tiáº¿ng Viá»‡t, ngáº¯n gá»n, thá»±c táº¿, há»¯u Ã­ch cho há»c sinh.`;
  })();

  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;
  try {
    const res = await fetch(url, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        contents:[{ parts:[{text:`${systemCtx}\n\nNgÆ°á»i dÃ¹ng: ${userMsg}`}] }],
        generationConfig:{ temperature:0.7, maxOutputTokens:512 }
      })
    });
    if (!res.ok) { const err=await res.json(); throw new Error(err.error?.message||'API error'); }
    const data = await res.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
  } catch(e) { console.error('Gemini error:', e); return `âŒ Lá»—i Gemini: ${e.message}`; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function quickSend(el) { document.getElementById('chatIn').value=el.textContent; sendChat(); }

async function sendChat() {
  const inp=document.getElementById('chatIn'), text=inp.value.trim(); if(!text)return;
  inp.value=''; addMsg('u',text);
  const hist=DB.get(DB.K.CHAT,[]); hist.push({role:'user',content:text,ts:Date.now()}); DB.set(DB.K.CHAT,hist);
  document.getElementById('btnSend').disabled=true;

  const isGemini = cfg.aiMode==='gemini' && !!DB.get(DB.K.APIKEY,'');

  if (isGemini) {
    const bubble=addMsg('a','<span class="dots"><span></span><span></span><span></span></span>');
    const reply=await callGemini(text);
    bubble.innerHTML=reply?renderAIText(reply):'âŒ KhÃ´ng nháº­n Ä‘Æ°á»£c pháº£n há»“i tá»« Gemini. Kiá»ƒm tra API key!';
    const all=DB.get(DB.K.CHAT,[]); all.push({role:'assistant',content:bubble.textContent,ts:Date.now()}); DB.set(DB.K.CHAT,all);
  } else {
    // Fake AI â€“ instant response
    const reply=FAKE_AI.respond(text);
    addMsg('a',reply);
    const all=DB.get(DB.K.CHAT,[]); all.push({role:'assistant',content:reply,ts:Date.now()}); DB.set(DB.K.CHAT,all);
  }
  document.getElementById('btnSend').disabled=false;
}

function renderAIText(t){
  return t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\*(.*?)\*/g,'<i>$1</i>')
          .replace(/`(.*?)`/g,'<code style="background:var(--surf3);padding:0 3px;border-radius:4px;font-size:.82em">$1</code>')
          .replace(/\n/g,'<br>');
}
function addMsg(role,html){
  const box=document.getElementById('chatBox');
  const div=document.createElement('div');div.className='msg '+role;div.innerHTML=html;
  box.appendChild(div);box.scrollTop=9999;return div;
}
function clearChatHistory(){if(!confirm('XÃ³a toÃ n bá»™ lá»‹ch sá»­ chat?'))return;DB.set(DB.K.CHAT,[]);document.getElementById('chatBox').innerHTML='';addMsg('sys','ğŸ—‘ï¸ ÄÃ£ xÃ³a chat.');}
function loadChatHistory(){DB.get(DB.K.CHAT,[]).slice(-10).forEach(m=>addMsg(m.role==='user'?'u':'a',renderAIText(m.content)));}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let statDayOff=0;
function switchStatTab(tab,btn){
  document.querySelectorAll('.stat-tab').forEach(b=>b.classList.toggle('on',b===btn));
  document.getElementById('statsContent').innerHTML=tab==='day'?renderDay():tab==='week'?renderWeek():renderMonth();
}
function renderStats(){document.getElementById('statsContent').innerHTML=renderDay();}

function renderDay(){
  const dt=new Date();dt.setDate(dt.getDate()+statDayOff);
  const ds=dateToStr(dt);
  const slots=(schedule[ds]||[]).filter(e=>e.kind==='task');
  const done=slots.filter(e=>e.done).length,tot=slots.length;
  const mins=slots.reduce((s,e)=>s+(e.end-e.start),0);
  const pct=tot?Math.round(done/tot*100):0;
  const byS={};slots.forEach(s=>{const sub=s.tag||'KhÃ¡c';byS[sub]=(byS[sub]||0)+(s.end-s.start);});
  const mx=Math.max(...Object.values(byS),1);
  return `<div class="card"><div class="ct">ğŸ“† ${DAY_FULL[dt.getDay()]} ${ds}</div>
  <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
    <button class="btn bgh sm" onclick="statDayOff--;renderStats()">â—€</button>
    <button class="btn bgh sm" onclick="statDayOff++;renderStats()">â–¶</button>
    <button class="btn bp sm" onclick="statDayOff=0;renderStats()">HÃ´m nay</button>
  </div>
  <div class="stat-cards">
    <div class="sc"><div class="sv">${tot}</div><div class="sl">Tá»•ng task</div></div>
    <div class="sc"><div class="sv">${done}</div><div class="sl">âœ… Xong</div></div>
    <div class="sc"><div class="sv">${pct}%</div><div class="sl">Tá»‰ lá»‡</div></div>
    <div class="sc"><div class="sv">${Math.round(mins/60*10)/10}h</div><div class="sl">Há»c</div></div>
  </div>
  <div class="prog"><div class="prog-b" style="width:${pct}%"></div></div>
  </div>
  <div class="card"><div class="ct">ğŸ“š PhÃ¢n bá»• mÃ´n</div>
    ${Object.entries(byS).sort((a,b)=>b[1]-a[1]).map(([s,d])=>`
    <div class="stat-bar-row">
      <div class="lbl">${s}</div>
      <div class="bar-wrap"><div class="bar-fill" style="width:${Math.round(d/mx*100)}%;background:var(--pri)"></div></div>
      <div class="val">${Math.round(d/60*10)/10}h</div>
    </div>`).join('')||'<p style="color:var(--txt2);font-size:.8rem">KhÃ´ng cÃ³ dá»¯ liá»‡u.</p>'}
  </div>`;
}

function renderWeek(){
  const mon=getMonday(0);
  const days=Array.from({length:7},(_,i)=>{const d=new Date(mon);d.setDate(mon.getDate()+i);return dateToStr(d);});
  const maxM=Math.max(...days.map(ds=>(schedule[ds]||[]).filter(s=>s.kind==='task').reduce((s,t)=>s+(t.end-t.start),0)),1);
  return `<div class="card"><div class="ct">ğŸ—“ï¸ Tuáº§n nÃ y</div>
  ${days.map(ds=>{
    const dt=dsToDate(ds),ts=(schedule[ds]||[]).filter(s=>s.kind==='task');
    const m=ts.reduce((s,t)=>s+(t.end-t.start),0),done=ts.filter(t=>t.done).length;
    return `<div class="stat-bar-row">
      <div class="lbl">${DAY_VI[dt.getDay()]} ${dt.getDate()}</div>
      <div class="bar-wrap"><div class="bar-fill" style="width:${Math.round(m/maxM*100)}%;background:${ds===todayStr()?'var(--acc)':'var(--pri)'}"></div></div>
      <div class="val">${Math.round(m/60*10)/10}h <span style="font-size:.64rem;color:var(--txt2)">${done}/${ts.length}</span></div>
    </div>`;
  }).join('')}
  </div>`;
}

function renderMonth(){
  const now=new Date(),year=now.getFullYear(),month=now.getMonth();
  const dim=new Date(year,month+1,0).getDate();
  const MN=['ThÃ¡ng 1','ThÃ¡ng 2','ThÃ¡ng 3','ThÃ¡ng 4','ThÃ¡ng 5','ThÃ¡ng 6','ThÃ¡ng 7','ThÃ¡ng 8','ThÃ¡ng 9','ThÃ¡ng 10','ThÃ¡ng 11','ThÃ¡ng 12'];
  const allDays=Array.from({length:dim},(_,i)=>dateToStr(new Date(year,month,i+1)));
  const tMin=allDays.reduce((s,ds)=>{const ts=(schedule[ds]||[]).filter(s=>s.kind==='task');return s+ts.reduce((a,t)=>a+(t.end-t.start),0);},0);
  const tDone=allDays.reduce((s,ds)=>(s+(schedule[ds]||[]).filter(s=>s.kind==='task'&&s.done).length),0);
  const tTot=allDays.reduce((s,ds)=>(s+(schedule[ds]||[]).filter(s=>s.kind==='task').length),0);
  return `<div class="card"><div class="ct">ğŸ“… ${MN[month]} ${year}</div>
  <div class="stat-cards">
    <div class="sc"><div class="sv">${tTot}</div><div class="sl">Tá»•ng task</div></div>
    <div class="sc"><div class="sv">${tDone}</div><div class="sl">Xong</div></div>
    <div class="sc"><div class="sv">${tTot?Math.round(tDone/tTot*100):0}%</div><div class="sl">Tá»‰ lá»‡</div></div>
    <div class="sc"><div class="sv">${Math.round(tMin/60)}h</div><div class="sl">Tá»•ng há»c</div></div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:6px">
    ${['CN','T2','T3','T4','T5','T6','T7'].map(d=>`<div style="text-align:center;font-size:.6rem;font-weight:700;color:var(--txt2)">${d}</div>`).join('')}
    ${Array.from({length:new Date(year,month,1).getDay()},()=>'<div></div>').join('')}
    ${Array.from({length:dim},(_,i)=>{
      const ds=dateToStr(new Date(year,month,i+1));
      const ms=(schedule[ds]||[]).filter(s=>s.kind==='task').reduce((a,t)=>a+(t.end-t.start),0);
      const alpha=ms>0?Math.min(0.15+ms/300,1):0.05;
      const isToday=ds===todayStr();
      return `<div title="${ds}: ${Math.round(ms/60*10)/10}h"
        style="aspect-ratio:1;border-radius:5px;display:flex;align-items:center;justify-content:center;
        font-size:.68rem;font-weight:700;background:rgba(124,58,237,${alpha});
        color:${alpha>0.5?'#fff':'var(--txt)'};border:${isToday?'2px solid var(--acc)':'1.5px solid var(--brd)'}">
        ${i+1}</div>`;
    }).join('')}
  </div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI SETUP & MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let pendingAiMode = cfg.aiMode || 'fake';

function selectAiMode(mode) {
  pendingAiMode = mode;
  ['fake','gemini'].forEach(m => {
    const a = document.getElementById('mopt-'+m);
    const b = document.getElementById('setup-mopt-'+m);
    if (a) a.classList.toggle('on', m===mode);
    if (b) b.classList.toggle('on', m===mode);
  });
  const gSection = document.getElementById('geminiKeySection');
  const sSection = document.getElementById('setup-gemini-section');
  if (gSection) gSection.style.display = mode==='gemini'?'block':'none';
  if (sSection) sSection.style.display = mode==='gemini'?'block':'none';
}

function saveAiSetup() {
  cfg.aiMode = pendingAiMode;
  if (pendingAiMode==='gemini') {
    const keyInput = document.getElementById('geminiKeyInput');
    const saveKey  = document.getElementById('saveKeyToggle');
    if (keyInput?.value.trim()) {
      const key = keyInput.value.trim();
      if (saveKey?.checked) DB.set(DB.K.APIKEY, key);
      else { DB.set(DB.K.APIKEY,''); sessionStorage.setItem('ssp_tmpkey', key); }
    }
  }
  DB.set(DB.K.CFG, cfg);
  updateAIModeUI();
  closeAiSetup();
  showToast(`âœ… ÄÃ£ chuyá»ƒn sang ${pendingAiMode==='gemini'?'Gemini AI':'Fake AI'}!`);
}

function saveGeminiKey() {
  const key = document.getElementById('setup_apikey')?.value.trim();
  if (!key){showToast('âš ï¸ Nháº­p API key trÆ°á»›c!');return;}
  DB.set(DB.K.APIKEY, key);
  cfg.aiMode='gemini'; DB.set(DB.K.CFG,cfg);
  updateAIModeUI(); showToast('âœ… ÄÃ£ lÆ°u API key vÃ  chuyá»ƒn sang Gemini!');
}

async function testGemini() {
  const key = document.getElementById('setup_apikey')?.value.trim()||DB.get(DB.K.APIKEY,'');
  if (!key){showToast('âš ï¸ Nháº­p API key trÆ°á»›c!');return;}
  showToast('â³ Äang kiá»ƒm tra Geminiâ€¦');
  const old = DB.get(DB.K.APIKEY,'');
  DB.set(DB.K.APIKEY, key);
  const reply = await callGemini('Tráº£ lá»i báº±ng 1 cÃ¢u: Xin chÃ o!');
  DB.set(DB.K.APIKEY, old);
  showToast(reply&&!reply.startsWith('âŒ') ? 'âœ… Gemini hoáº¡t Ä‘á»™ng!' : 'âŒ ' + (reply||'KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c'));
}

function updateAIModeUI() {
  const isGemini = cfg.aiMode==='gemini' && !!DB.get(DB.K.APIKEY,'');
  const dot = document.getElementById('sDot');
  const txt = document.getElementById('sTxt');
  const badge = document.getElementById('modeBadge');
  if (dot) { dot.className='sdot '+(isGemini?'dot-ok':'dot-chk'); }
  if (txt) { txt.textContent = isGemini ? 'âœ¨ Gemini' : 'ğŸ§  Fake AI'; }
  if (badge) {
    badge.className = 'mode-badge ' + (isGemini ? 'mode-gemini' : 'mode-fake');
    badge.textContent = isGemini ? 'âœ¨ Gemini AI' : 'ğŸ§  Fake AI (Offline)';
  }
  // Sync setup page
  const skIn = document.getElementById('setup_apikey');
  if (skIn && !skIn.value) skIn.value = DB.get(DB.K.APIKEY,'')||'';
  updateSetupModeUI();
}

function updateSetupModeUI() {
  ['fake','gemini'].forEach(m => {
    const el = document.getElementById('setup-mopt-'+m);
    if (el) el.classList.toggle('on', (cfg.aiMode||'fake')===m);
  });
  const ss = document.getElementById('setup-gemini-section');
  if (ss) ss.style.display = (cfg.aiMode==='gemini')?'block':'none';
}

function openAiSetup()  { selectAiMode(cfg.aiMode||'fake'); document.getElementById('geminiKeyInput').value=DB.get(DB.K.APIKEY,'')||''; document.getElementById('aiSetupModal').classList.add('open'); }
function closeAiSetup() { document.getElementById('aiSetupModal').classList.remove('open'); }
function openGuide()    { document.getElementById('guideModal').classList.add('open'); }
function closeGuide()   { document.getElementById('guideModal').classList.remove('open'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSubjectBtns() {
  document.getElementById('subjBtns').innerHTML = SUBJECTS_LIST.map(s =>
    `<div class="subj-btn" data-s="${s}" onclick="selectSubject('${s}')">${s}</div>`).join('');
}
function selectSubject(s) {
  selSubj = s;
  document.querySelectorAll('.subj-btn').forEach(b => b.classList.toggle('on', b.dataset.s===s));
}
function autoDetectSubject(title) {
  const {subject,matched}=classifyTask(title);
  const lbl=document.getElementById('subjectAutoLabel');
  if (matched&&subject!=='KhÃ¡c'){lbl.textContent=`(nháº­n diá»‡n: ${subject})`;selectSubject(subject);}
  else lbl.textContent='';
}
function selectPri(p) {
  selPri=p;
  document.querySelectorAll('.pri-btn[data-pri]').forEach(b=>{
    b.className='pri-btn'+(b.dataset.pri===p?` on-${p}`:'');
  });
}
function selectDiff(d) {
  selDiff=d;
  document.querySelectorAll('.pri-btn[data-diff]').forEach(b=>{
    const on=b.dataset.diff===d;
    b.className='pri-btn'+(on?d==='hard'?' on-high':d==='easy'?' on-low':' on-med':'');
  });
}
function buildPickers() {
  const dp=document.getElementById('dayPick');
  dp.innerHTML=['CN','T2','T3','T4','T5','T6','T7'].map((d,i)=>
    `<div class="dchip" data-day="${i}" onclick="this.classList.toggle('on')">${d}</div>`).join('');
  [1,2,3,4,5].forEach(i=>dp.children[i].classList.add('on'));
  document.getElementById('colPick').innerHTML=COLORS.map((c,i)=>
    `<div class="copt ${i===0?'on':''}" style="background:${c}" data-color="${c}"
      onclick="document.querySelectorAll('.copt').forEach(e=>e.classList.remove('on'));this.classList.add('on')"></div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goTo(name, btn) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on'));
  document.getElementById('pg-'+name).classList.add('on');
  btn.classList.add('on');
  if (name==='stats') renderStats();
  if (name==='setup') { updateSetupModeUI(); updateNotifStatus(); }
}
function toggleDark() {
  const dark=document.documentElement.dataset.theme==='dark';
  document.documentElement.dataset.theme=dark?'light':'dark';
  document.getElementById('btnDark').textContent=dark?'ğŸŒ™':'â˜€ï¸';
  cfg.darkMode=!dark; DB.set(DB.K.CFG,cfg);
}
function showToast(msg) {
  const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',3000);
}
function cp(txt) {
  navigator.clipboard?.writeText(txt).then(()=>showToast('âœ… Copied!')).catch(()=>{
    const e=document.createElement('textarea');e.value=txt;document.body.appendChild(e);e.select();document.execCommand('copy');e.remove();showToast('âœ… Copied!');
  });
}
function saveCfg() {
  cfg.hardMorning=document.getElementById('cfg_hardMorning').checked;
  cfg.interleave  =document.getElementById('cfg_interleave').checked;
  cfg.pomodoro    =document.getElementById('cfg_pomodoro').checked;
  DB.set(DB.K.CFG,cfg); showToast('âœ… ÄÃ£ lÆ°u cÃ i Ä‘áº·t!');
}
function renderAll() { renderCalendar(); renderEvents(); renderTasks(); if(tlDate)renderTimeline(tlDate,dsToDate(tlDate)); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEMO DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadDemoData() {
  if (!confirm('Táº£i demo sáº½ XÃ“A dá»¯ liá»‡u hiá»‡n táº¡i. Tiáº¿p tá»¥c?')) return;
  events = [
    {id:1,name:'ğŸ« Äi há»c',type:'fixed',start:'07:00',end:'11:30',repeat:[1,2,3,4,5],pri:'high',color:'#3b82f6'},
    {id:2,name:'ğŸš Ä‚n trÆ°a',type:'flex',eStart:'11:30',lEnd:'13:30',dur:45,repeat:[0,1,2,3,4,5,6],pri:'med',color:'#f59e0b'},
    {id:3,name:'ğŸ“– Há»c thÃªm ToÃ¡n',type:'fixed',start:'13:30',end:'15:30',repeat:[2,4],pri:'high',color:'#ef4444'},
    {id:4,name:'ğŸƒ Thá»ƒ dá»¥c',type:'flex',eStart:'17:00',lEnd:'18:30',dur:40,repeat:[1,3,5],pri:'med',color:'#84cc16'},
    {id:5,name:'ğŸ½ï¸ Ä‚n tá»‘i',type:'flex',eStart:'18:00',lEnd:'19:30',dur:40,repeat:[0,1,2,3,4,5,6],pri:'med',color:'#f97316'},
    {id:6,name:'ğŸ˜´ Ngá»§',type:'fixed',start:'22:00',end:'23:59',repeat:[0,1,2,3,4,5,6],pri:'high',color:'#8b5cf6'},
  ];
  tasks = [
    {id:101,name:'LÃ m 5 bÃ i táº­p ToÃ¡n chÆ°Æ¡ng 2',dur:60,pri:'high',diff:'hard',dateFrom:todayStr(),dateTo:offStr(4),pref:'morning',subject:'ToÃ¡n',color:'#ef4444',subjectOverride:'',done:false,note:''},
    {id:102,name:'Viáº¿t vÄƒn nghá»‹ luáº­n xÃ£ há»™i',dur:45,pri:'med',diff:'med',dateFrom:todayStr(),dateTo:offStr(6),pref:'auto',subject:'Ngá»¯ VÄƒn',color:'#ec4899',subjectOverride:'',done:false,note:''},
    {id:103,name:'Ã”n tá»« vá»±ng Tiáº¿ng Anh unit 5',dur:30,pri:'med',diff:'easy',dateFrom:todayStr(),dateTo:offStr(10),pref:'evening',subject:'Tiáº¿ng Anh',color:'#3b82f6',subjectOverride:'',done:false,note:''},
    {id:104,name:'Giáº£i bÃ i táº­p Váº­t LÃ½ cÆ¡ há»c',dur:50,pri:'high',diff:'hard',dateFrom:todayStr(),dateTo:offStr(2),pref:'morning',subject:'Váº­t LÃ½',color:'#f97316',subjectOverride:'',done:false,note:''},
    {id:105,name:'Há»c thuá»™c bÃ i HÃ³a há»¯u cÆ¡',dur:40,pri:'med',diff:'hard',dateFrom:todayStr(),dateTo:offStr(7),pref:'auto',subject:'HÃ³a Há»c',color:'#8b5cf6',subjectOverride:'',done:false,note:''},
    {id:106,name:'Ã”n Lá»‹ch Sá»­',dur:35,pri:'low',diff:'easy',dateFrom:todayStr(),dateTo:offStr(14),pref:'evening',subject:'Lá»‹ch Sá»­',color:'#d97706',subjectOverride:'',done:false,note:''},
  ];
  DB.set(DB.K.EVENTS,events);DB.set(DB.K.TASKS,tasks);DB.set(DB.K.SCHED,{});schedule={};
  renderEvents();renderTasks();runScheduler();
  goTo('cal',document.querySelector('.tab'));
  showToast('âœ… ÄÃ£ táº£i demo! Nháº¥p vÃ o ngÃ y Ä‘á»ƒ xem lá»‹ch ğŸ“…');
}

function resetAllData() {
  if(!confirm('XÃ³a TOÃ€N Bá»˜ dá»¯ liá»‡u?'))return;
  DB.clear(); location.reload();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANDING â†’ APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startApp() {
  document.getElementById('landing').style.transition='opacity .4s';
  document.getElementById('landing').style.opacity='0';
  setTimeout(()=>{
    document.getElementById('landing').style.display='none';
    document.getElementById('app').classList.add('show');
    initApp();
  },400);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT APP (called after landing dismissed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp() {
  cfg = getCfg();

  // Dark mode
  if (cfg.darkMode) { document.documentElement.dataset.theme='dark'; document.getElementById('btnDark').textContent='â˜€ï¸'; }

  // Build pickers
  buildPickers();
  buildSubjectBtns();

  // Restore undo
  undoSnap = DB.get(DB.K.UNDO, null);
  if (undoSnap) document.getElementById('btnUndo').style.display='flex';

  // Set default dates for task form
  document.getElementById('tk_dfrom').value = todayStr();
  document.getElementById('tk_dto').value   = offStr(7);

  // Sync cfg toggles
  document.getElementById('cfg_hardMorning').checked = cfg.hardMorning!==false;
  document.getElementById('cfg_interleave').checked  = !!cfg.interleave;
  document.getElementById('cfg_pomodoro').checked    = cfg.pomodoro!==false;

  // Render data
  renderEvents(); renderTasks(); renderCalendar();

  // Load API key if saved
  const savedKey = DB.get(DB.K.APIKEY,'');
  if (savedKey) { const el=document.getElementById('setup_apikey'); if(el) el.value=savedKey; }

  // AI mode
  pendingAiMode = cfg.aiMode||'fake';
  updateAIModeUI();

  // Notification banner
  if (!cfg.notifGranted && Notification && Notification.permission==='default') {
    document.getElementById('notifBanner').classList.add('show');
  }
  updateNotifStatus();

  // Load chat history
  loadChatHistory();
  if (!DB.get(DB.K.CHAT,[]).length) {
    addMsg('a',`ğŸ‘‹ Xin chÃ o! MÃ¬nh lÃ  trá»£ lÃ½ <b>Smart Student Planner AI</b>.<br><br>
ğŸš€ <b>Báº¯t Ä‘áº§u:</b><br>
â€¢ ğŸ“Œ VÃ o <b>Sá»± kiá»‡n</b> â†’ thÃªm lá»‹ch há»c, Äƒn, ngá»§<br>
â€¢ ğŸ“ VÃ o <b>CÃ´ng viá»‡c</b> â†’ thÃªm bÃ i táº­p + Ä‘á»™ khÃ³ + deadline<br>
â€¢ âš¡ Nháº¥n <b>Xáº¿p lá»‹ch</b> Ä‘á»ƒ AI sáº¯p xáº¿p tá»± Ä‘á»™ng<br>
â€¢ ğŸ“¥ Hoáº·c thá»­ <b>Load Demo</b> trong âš™ï¸ CÃ i Ä‘áº·t<br><br>
<em>Hiá»‡n Ä‘ang dÃ¹ng cháº¿ Ä‘á»™ ${cfg.aiMode==='gemini'?'âœ¨ Gemini AI':'ğŸ§  Fake AI (offline)'}.</em>`);
  }

  // Start notification scheduler
  if (Notification && Notification.permission==='granted') scheduleNotifications();

  console.log('ğŸ“š Smart Student Planner AI v11 â€“ Ready!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Show landing first â€“ startApp() called on button click
// If returning user (has data), can auto-start
window.addEventListener('load', () => {
  const hasData = events.length>0 || tasks.length>0 || Object.keys(schedule).length>0;
  if (hasData) {
    // Returning user: shorter landing exposure
    setTimeout(()=>{}, 0);
  }
});
</script>
</body>
</html>